<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Codera Application</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Firebase (compat) CDNs to support global usage in inline scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-firestore-compat.js"></script>
    <!-- CodeMirror -->
    <link rel="stylesheet" href="https://unpkg.com/codemirror@5.65.16/lib/codemirror.css">
    <script src="https://unpkg.com/codemirror@5.65.16/lib/codemirror.js"></script>
    <script src="https://unpkg.com/codemirror@5.65.16/mode/javascript/javascript.js"></script>
    <script src="https://unpkg.com/codemirror@5.65.16/mode/python/python.js"></script>
    <script src="https://unpkg.com/codemirror@5.65.16/mode/clike/clike.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/codemirror@5.65.16/theme/dracula.css">

    <!-- Production WebRTC Utilities -->
    <script>
        // Enhanced WebRTC for production - inline to avoid CORS issues
        class ProductionWebRTCHelper {
            static async testMicrophone() {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    console.log('‚úÖ Microphone test passed');
                    stream.getTracks().forEach(track => track.stop());
                    return true;
                } catch (error) {
                    console.log('‚ùå Microphone test failed:', error.message);
                    return false;
                }
            }
            
            static showTroubleshootingGuide() {
                const guide = `
üé§ VOICE CHAT TROUBLESHOOTING GUIDE:

1. üîí HTTPS: Your app uses HTTPS ‚úÖ (Required for voice chat)

2. üì± PERMISSIONS:
   ‚Ä¢ Look for microphone icon in address bar
   ‚Ä¢ Click and select "Always allow"
   ‚Ä¢ Refresh page after granting access

3. üåê BROWSER:
   ‚Ä¢ Use Chrome, Firefox, Safari, or Edge (latest)
   ‚Ä¢ Clear cache and cookies if needed
   ‚Ä¢ Try incognito/private mode

4. üéß HARDWARE:
   ‚Ä¢ Ensure microphone is connected
   ‚Ä¢ Check system audio settings
   ‚Ä¢ Test microphone in other apps

5. üåç NETWORK:
   ‚Ä¢ Corporate networks may block WebRTC
   ‚Ä¢ Try personal network or mobile hotspot
   ‚Ä¢ Some public WiFi blocks voice chat

6. üîß DEBUG:
   ‚Ä¢ Press F12 to open browser console
   ‚Ä¢ Look for detailed error messages
   ‚Ä¢ Try refreshing the page

If still not working, the issue is likely network/firewall related.`;
                alert(guide);
                console.log(guide);
            }
        }
        
        // Make available globally
        window.ProductionWebRTCHelper = ProductionWebRTCHelper;
    </script>

    <!-- Shims: expose React hooks and Firebase helpers matching the code's usage -->
    <script>
        // Make React hooks available as globals
        const { useState, useEffect, useRef, useMemo, useCallback } = React;

        // Provide modular-style helper names backed by compat SDK (so existing code works)
        // Only define if not already present (e.g., when injected elsewhere)
        window.initializeApp = window.initializeApp || function(config) { return firebase.initializeApp(config); };
        window.getFirestore = window.getFirestore || function(app) { return firebase.firestore(app); };
        window.getAuth = window.getAuth || function(app) { return firebase.auth(app); };
        window.signInWithCustomToken = window.signInWithCustomToken || function(auth, token) { return auth.signInWithCustomToken(token); };
        window.signInAnonymously = window.signInAnonymously || function(auth) { return auth.signInAnonymously(); };
        window.onAuthStateChanged = window.onAuthStateChanged || function(auth, handler) { return auth.onAuthStateChanged(handler); };
        window.signOut = window.signOut || function(auth) { return auth.signOut(); };
        window.signInWithEmailAndPassword = window.signInWithEmailAndPassword || function(auth, email, password) { return auth.signInWithEmailAndPassword(email, password); };
        window.GoogleAuthProvider = window.GoogleAuthProvider || function() { return new firebase.auth.GoogleAuthProvider(); };
        window.signInWithPopup = window.signInWithPopup || function(auth, provider) { return auth.signInWithPopup(provider); };
        window.createUserWithEmailAndPassword = window.createUserWithEmailAndPassword || function(auth, email, password) { return auth.createUserWithEmailAndPassword(email, password); };
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Light mode overrides to map dark Tailwind classes to light equivalents */
        body.light { background-color: #f9fafb; color: #111827; }
        body.light .bg-gray-900 { background-color: #f3f4f6 !important; }
        body.light .bg-gray-800 { background-color: #ffffff !important; }
        body.light .bg-gray-700 { background-color: #f3f4f6 !important; }
        body.light .bg-gray-600 { background-color: #e5e7eb !important; }
        body.light .text-gray-100, body.light .text-white { color: #111827 !important; }
        body.light .text-gray-200 { color: #111827 !important; }
        body.light .text-gray-300 { color: #6b7280 !important; }
        body.light .text-gray-400 { color: #6b7280 !important; }
        body.light .text-indigo-400 { color: #4f46e5 !important; }
        body.light .border-gray-600 { border-color: #e5e7eb !important; }
        body.light .border-indigo-700 { border-color: #c7d2fe !important; }
        body.light .hover\:bg-gray-700:hover { background-color: #e5e7eb !important; }
        body.light .hover\:bg-gray-600:hover { background-color: #e5e7eb !important; }
        body.light .bg-gray-900.bg-opacity-75 { background-color: rgba(0,0,0,0.35) !important; }
        body.light nav.bg-gray-800 { background-color: #ffffff !important; }
        body.light aside.bg-gray-800 { background-color: #ffffff !important; }
        body.light .custom-scrollbar::-webkit-scrollbar-track { background: #e5e7eb; }
        body.light .custom-scrollbar::-webkit-scrollbar-thumb { background: #9ca3af; }
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #4a5568;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #a0aec0;
            border-radius: 4px;
        }
    </style>
</head>
<body class="bg-gray-900">
    <script>
        try {
            if (localStorage.getItem('theme') === 'light') {
                document.body.classList.add('light');
            }
        } catch (e) {}
    </script>
    <div id="root"></div>

    <script type="text/babel">
    const AppEarly = () => {
        // Theme state
        const [theme, setTheme] = useState(() => {
            try {
                return localStorage.getItem('theme') || 'dark';
            } catch (e) {
                return 'dark';
            }
        });

        // Apply theme to document and notify listeners (e.g., CodeMirror)
        useEffect(() => {
            try {
                localStorage.setItem('theme', theme);
            } catch (e) {}
            // Toggle body marker class for light mode
            document.body.classList.toggle('light', theme === 'light');
            // Dispatch theme-change event
            window.dispatchEvent(new CustomEvent('theme-change', { detail: theme }));
        }, [theme]);

        const toggleTheme = () => setTheme(prev => (prev === 'dark' ? 'light' : 'dark'));
        // Firebase State
        const [db, setDb] = useState(null);
        const [auth, setAuth] = useState(null);
        const [userId, setUserId] = useState(null);
        const [isAuthenticated, setIsAuthenticated] = useState(false);
        const [isAuthReady, setIsAuthReady] = useState(false);

        // UI State - Fixed to use hash-based routing with debug
        const [currentPage, setCurrentPage] = useState(() => {
            const hash = window.location.hash;
            const pathname = window.location.pathname;
            const href = window.location.href;
            
            console.log('=== INITIAL PAGE LOAD DEBUG ===');
            console.log('Full URL:', href);
            console.log('Hash:', hash);
            console.log('Pathname:', pathname);
            
            if (hash && hash.startsWith('#/')) {
                const page = hash.substring(1);
                console.log('Using hash route:', page);
                return page;
            }
            
            const fallback = pathname || '/';
            console.log('Using fallback route:', fallback);
            return fallback;
        });
        const [previousPage, setPreviousPage] = useState('/home'); // Track previous page for profile toggle
        const [isSidebarOpen, setIsSidebarOpen] = useState(window.innerWidth >= 1024); // Open by default on desktop

        // --- Firebase Initialization and Authentication ---
        useEffect(() => {
            console.log('üîÑ Starting Firebase initialization...');
            console.log('Firebase available:', !!window.firebase);
            
            try {
                // Try to initialize Firebase for global communication
                // Replace this with your actual Firebase config
                const firebaseConfig = {
                    // PLACEHOLDER - Replace with your Firebase config
                    // To get your config:
                    // 1. Go to https://console.firebase.google.com/
                    // 2. Create a project or select existing one
                    // 3. Go to Project Settings > General > Your apps
                    // 4. Add web app and copy the config here
            
                            apiKey: "AIzaSyCdl2AhZG9HBwDLcSENTroup0ryR7_NdW8",
                            authDomain: "codera-battle.firebaseapp.com",
                            projectId: "codera-battle",
                            storageBucket: "codera-battle.firebasestorage.app",
                            messagingSenderId: "825772579105",
                            appId: "1:825772579105:web:583045e4bb94c7f9af0660",
                            measurementId: "G-G10VGFQVBN"

                };
                
                console.log('üîç Firebase config check:');
                console.log('API Key present:', !!firebaseConfig.apiKey);
                console.log('Project ID:', firebaseConfig.projectId);
                console.log('Firebase global object:', !!window.firebase);
                
                // Check if Firebase config is provided
                if (firebaseConfig.apiKey && firebaseConfig.projectId && window.firebase) {
                    console.log('Initializing Firebase for global communication...');
                    
                    // Initialize Firebase app using compat API
                    const app = firebase.initializeApp(firebaseConfig);
                    const firestore = firebase.firestore();
                    const firebaseAuth = firebase.auth();
                    
                    setDb(firestore);
                    setAuth(firebaseAuth);
                    
                    console.log('‚úÖ Firebase app initialized:', app.name);
                    console.log('‚úÖ Firestore initialized');
                    console.log('‚úÖ Auth initialized');
                    
                    // Set up authentication state listener
                    firebaseAuth.onAuthStateChanged((user) => {
                        if (user) {
                            setUserId(user.uid);
                            setIsAuthenticated(true);
                            console.log('User authenticated:', user.uid, user.email);
                        } else {
                            setUserId(null);
                            setIsAuthenticated(false);
                            console.log('User not authenticated');
                        }
                        setIsAuthReady(true);
                    });
                    
                } else {
                    console.log('Firebase config not provided, authentication required');
                    console.log('To enable authentication, add your Firebase config above.');
                    
                    // No authentication without Firebase
                    setUserId(null);
                    setIsAuthenticated(false);
                    setIsAuthReady(true);
                }
                
                // Don't redirect if we're already on a specific page
                if (currentPage !== '/' && currentPage !== '/login') {
                    console.log('Staying on current page:', currentPage);
                    return;
                }
                
            } catch (error) {
                console.error("Error in Firebase initialization:", error);
                // No fallback - require proper authentication
                setUserId(null);
                setIsAuthenticated(false);
                setIsAuthReady(true);
            }
        }, [currentPage]);

        // Handle initial routing based on authentication state
        useEffect(() => {
            console.log('Setting up authentication redirect logic...');
            if (isAuthReady) {
                // Redirect to home if already authenticated and on login page
                if (isAuthenticated && (currentPage === '/' || currentPage === '/login')) {
                    console.log('User authenticated, redirecting to home');
                    try {
                        if (window.location.protocol === 'file:') {
                            setCurrentPage('/home');
                            window.location.hash = '/home';
                        } else {
                            setCurrentPage('/home');
                            window.history.pushState({}, '', '#/home');
                        }
                    } catch (error) {
                        console.log('Using hash routing fallback for redirect');
                        setCurrentPage('/home');
                        window.location.hash = '/home';
                    }
                }
                // Redirect to login if not authenticated and trying to access protected pages
                else if (!isAuthenticated && currentPage !== '/login' && currentPage !== '/') {
                    console.log('User not authenticated, redirecting to login');
                    try {
                        if (window.location.protocol === 'file:') {
                            setCurrentPage('/login');
                            window.location.hash = '/login';
                        } else {
                            setCurrentPage('/login');
                            window.history.pushState({}, '', '#/login');
                        }
                    } catch (error) {
                        console.log('Using hash routing fallback for login redirect');
                        setCurrentPage('/login');
                        window.location.hash = '/login';
                    }
                }
            }
        }, [isAuthReady, isAuthenticated, currentPage]);


        // Handle browser navigation (back/forward) - Fixed for hash routing
        useEffect(() => {
            const handleHashChange = () => {
                const hash = window.location.hash;
                if (hash && hash.startsWith('#/')) {
                    setCurrentPage(hash.substring(1)); // Remove the # symbol
                } else {
                    setCurrentPage(window.location.pathname || '/');
                }
            };
            
            window.addEventListener('hashchange', handleHashChange);
            window.addEventListener('popstate', handleHashChange);
            
            return () => {
                window.removeEventListener('hashchange', handleHashChange);
                window.removeEventListener('popstate', handleHashChange);
            };
        }, []);

        // Function to navigate programmatically - Fixed for hash routing
        const navigateTo = (path) => {
            // Store previous page before navigating to any new page
            if (currentPage !== path && !currentPage.startsWith('/profile')) {
                // Only update previous page if we're not currently on a profile page
                setPreviousPage(currentPage);
            } else if (currentPage !== path && currentPage.startsWith('/profile') && !path.startsWith('/profile')) {
                // If leaving profile to go somewhere else, don't update previous page
                // Keep the original previous page intact
            } else if (currentPage !== path && !currentPage.startsWith('/profile') && path.startsWith('/profile')) {
                // If going to profile from non-profile page, store current as previous
                setPreviousPage(currentPage);
            }
            setCurrentPage(path);
            // Use hash-based routing for file:// protocol compatibility
            const hashPath = '#' + path;
            try {
                // Try pushState first
                if (window.location.protocol === 'file:') {
                    // For file:// protocol, use hash routing only
                    window.location.hash = path;
                } else {
                    window.history.pushState({}, '', hashPath);
                }
            } catch (error) {
                // Fallback to hash routing if pushState fails
                console.log('Using hash routing fallback');
                window.location.hash = path;
            }
        };

        // Special toggle function for profile icon
        const toggleProfile = () => {
            if (currentPage.startsWith('/profile')) {
                // If currently on profile, go back to previous page
                setCurrentPage(previousPage);
                const hashPath = '#' + previousPage;
                try {
                    if (window.location.protocol === 'file:') {
                        window.location.hash = previousPage;
                    } else {
                        window.history.pushState({}, '', hashPath);
                    }
                } catch (error) {
                    console.log('Using hash routing fallback');
                    window.location.hash = previousPage;
                }
            } else {
                // If not on profile, store current page and go to profile
                setPreviousPage(currentPage);
                setCurrentPage('/profile');
                const hashPath = '#/profile';
                try {
                    if (window.location.protocol === 'file:') {
                        window.location.hash = '/profile';
                    } else {
                        window.history.pushState({}, '', hashPath);
                    }
                } catch (error) {
                    console.log('Using hash routing fallback');
                    window.location.hash = '/profile';
                }
            }
        };

        const handleLogout = async () => {
            if (auth) {
                try {
                    await signOut(auth);
                    navigateTo('/login'); // Redirect to login after logout
                } catch (error) {
                    console.error("Error logging out:", error);
                }
            }
        };

        // Conditional rendering based on authentication and current page
        if (!isAuthReady) {
            return (
                <div className="min-h-screen flex items-center justify-center bg-gray-900 text-gray-100">
                    <svg className="animate-spin h-10 w-10 text-indigo-400 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                        <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <p>Loading application...</p>
                </div>
            );
        }

        // This conditional redirect is now handled within the useEffect for better lifecycle management
        // and to ensure pushState is not called on blob: URLs
        // if (!isAuthenticated && currentPage !== '/login') {
        //     navigateTo('/login');
        //     return null;
        // }

        const renderPage = () => {
            // Handle both path and query parameters from hash-based URLs
            const [pathname, queryString] = currentPage.split('?');
            const pathSegments = pathname.split('/').filter(Boolean); // ['', 'practice', '1'] -> ['practice', '1']
            const baseRoute = `/${pathSegments[0] || ''}`;
            const id = pathSegments[1];
            const subRoute = pathSegments[1]; // for /battle/random or /battle/friends
            
            // Debug logging
            console.log('=== ROUTING DEBUG ===');
            console.log('Current page:', currentPage);
            console.log('Pathname:', pathname);
            console.log('Base route:', baseRoute);
            console.log('Sub route:', subRoute);
            console.log('Path segments:', pathSegments);
            console.log('Query string:', queryString);
            console.log('Is authenticated:', isAuthenticated);
            console.log('Auth ready:', isAuthReady);

            switch (baseRoute) {
                case '/login':
                    return isAuthenticated ? <HomePage username="CodeMaster" navigateTo={navigateTo} /> : <LoginPage onLoginSuccess={() => navigateTo('/home')} navigateTo={navigateTo} />;
                case '/home':
                    if (!isAuthenticated) return <LoginPage onLoginSuccess={() => navigateTo('/home')} navigateTo={navigateTo} />;
                    return <HomePage username="CodeMaster" navigateTo={navigateTo} />;
                case '/practice':
                    if (!isAuthenticated) return <LoginPage onLoginSuccess={() => navigateTo('/home')} navigateTo={navigateTo} />;
                    return id ? <PracticeProblemPage problemId={id} /> : <PracticeListPage navigateTo={navigateTo} />;
                case '/battle':
                     if (!isAuthenticated) return <LoginPage onLoginSuccess={() => navigateTo('/home')} navigateTo={navigateTo} />;
                     if (subRoute === 'random') return <BattleRandomPage navigateTo={navigateTo} />;
                     if (subRoute === 'friends') return <BattleFriendsPage navigateTo={navigateTo} />;
                     if (subRoute === 'room') return <BattleRoomPage navigateTo={navigateTo} userId={userId} db={db} />;
                     return <BattleOverviewPage navigateTo={navigateTo} />;
                case '/leaderboard':
                    if (!isAuthenticated) return <LoginPage onLoginSuccess={() => navigateTo('/home')} navigateTo={navigateTo} />;
                    return <LeaderboardPage navigateTo={navigateTo} />;
                case '/friends':
                    if (!isAuthenticated) return <LoginPage onLoginSuccess={() => navigateTo('/home')} navigateTo={navigateTo} />;
                    return <FriendsPage navigateTo={navigateTo} />;
                case '/notes':
                    if (!isAuthenticated) return <LoginPage onLoginSuccess={() => navigateTo('/home')} navigateTo={navigateTo} />;
                    return <NotesPage navigateTo={navigateTo} />;
                case '/profile':
                    if (!isAuthenticated) return <LoginPage onLoginSuccess={() => navigateTo('/home')} navigateTo={navigateTo} />;
                    return <ProfilePage navigateTo={navigateTo} profileId={id} />;
                default:
                    // Default to login page for unauthenticated users
                    return isAuthenticated ? <HomePage username="CodeMaster" navigateTo={navigateTo} /> : <LoginPage onLoginSuccess={() => navigateTo('/home')} navigateTo={navigateTo} />;
            }
        };

        return (
            <div className={`flex min-h-screen ${theme === 'dark' ? 'bg-gray-900' : 'bg-gray-100'}`}>
                {isAuthenticated && (
                    <>
                        <Navbar toggleSidebar={() => setIsSidebarOpen(!isSidebarOpen)} username="CodeMaster" currentPage={currentPage} userId={userId} onLogout={handleLogout} theme={theme} onToggleTheme={toggleTheme} navigateTo={navigateTo} toggleProfile={toggleProfile} />
                        <Sidebar isSidebarOpen={isSidebarOpen} toggleSidebar={setIsSidebarOpen} navigateTo={navigateTo} currentPage={currentPage} />
                    </>
                )}
                <div className={`flex-grow ${isAuthenticated ? 'ml-0 lg:ml-20 pt-16' : ''} transition-all duration-300 ease-in-out`}>
                    {renderPage()}
                </div>
            </div>
        );
    };

    const Navbar = ({ toggleSidebar, username, currentPage, userId, onLogout, theme, onToggleTheme, navigateTo, toggleProfile }) => {
        const [showNotifications, setShowNotifications] = useState(false);
        const [notifications, setNotifications] = useState([
            { id: 1, type: 'battle', message: 'You have a battle invite from Player1!', read: false },
            { id: 2, type: 'streak', message: 'Keep up your 5-day streak!', read: false },
            { id: 3, type: 'friendRequest', message: 'Player2 sent you a friend request.', read: true },
            { id: 4, type: 'problem', message: 'New problem added: Merge Sorted Array.', read: false },
            { id: 5, type: 'qotd', message: 'Question of the Day is available!', read: false },
        ]);

        const notificationRef = useRef(null);

        useEffect(() => {
            const handleClickOutside = (event) => {
                if (notificationRef.current && !notificationRef.current.contains(event.target)) {
                    setShowNotifications(false);
                }
            };
            document.addEventListener('mousedown', handleClickOutside);
            return () => document.removeEventListener('mousedown', handleClickOutside);
        }, []);

        const unreadCount = notifications.filter(n => !n.read).length;

        const markAllAsRead = () => {
            setNotifications(notifications.map(n => ({ ...n, read: true })));
        };

        const handleNotificationClick = (notification) => {
            // Simulate navigation
            console.log(`Navigating based on notification type: ${notification.type}`);
            // In a real app, this would change the `currentPage` state or use a router.
            setShowNotifications(false);
            setNotifications(notifications.map(n => n.id === notification.id ? { ...n, read: true } : n));
        };

        return (
            <nav className="fixed top-0 left-0 w-full bg-gray-800 text-gray-100 p-4 shadow-lg flex justify-between items-center z-50">
                <div className="flex items-center">
                    <button onClick={toggleSidebar} className="lg:hidden p-2 rounded-md hover:bg-gray-700 transition duration-200 mr-2">
                        <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6h16M4 12h16M4 18h16" />
                        </svg>
                    </button>
                    <h1 className="text-xl font-bold text-indigo-400">Codera</h1>
                </div>
                <div className="flex items-center space-x-4">
                    {/* Theme Toggle */}
                    <button onClick={onToggleTheme} className="p-2 rounded-md hover:bg-gray-700 transition duration-200" aria-label="Toggle theme">
                        {theme === 'dark' ? (
                            // Sun icon for switching to light
                            <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6 text-yellow-400" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 18a6 6 0 100-12 6 6 0 000 12zm0 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zm0-22a1 1 0 011 1v1a1 1 0 11-2 0V1a1 1 0 011-1zm10 11a1 1 0 011 1 1 1 0 11-2 0 1 1 0 011-1zM4 12a1 1 0 011 1 1 1 0 11-2 0 1 1 0 011-1zm13.657 7.071a1 1 0 011.414 1.415l-.707.707a1 1 0 11-1.414-1.414l.707-.708zM6.343 3.515A1 1 0 117.757 2.1l.707.707A1 1 0 117.05 4.22l-.707-.707zm12.02-.707A1 1 0 1119.778 4.22l-.707.707A1 1 0 0117.657 3.51l.707-.707zM4.222 19.778a1 1 0 111.415-1.414l.707.707A1 1 0 114.93 20.485l-.707-.707z" />
                            </svg>
                        ) : (
                            // Moon icon for switching to dark
                            <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6 text-blue-600" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M21.752 15.002A9 9 0 1112.998 2.248a7 7 0 108.754 12.754z" />
                            </svg>
                        )}
                    </button>

                    {/* Notifications */}
                    <div className="relative" ref={notificationRef}>
                        <button onClick={() => setShowNotifications(!showNotifications)} className="p-2 rounded-md hover:bg-gray-700 transition duration-200 relative" aria-label="Notifications">
                            <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
                            </svg>
                            {unreadCount > 0 && (
                                <span className="absolute top-0 right-0 inline-flex items-center justify-center px-2 py-1 text-xs font-bold leading-none text-red-100 bg-red-600 rounded-full">{unreadCount}</span>
                            )}
                        </button>
                        {showNotifications && (
                            <div className="absolute right-0 mt-2 w-72 bg-gray-700 rounded-md shadow-xl z-50 animate-fade-in-down">
                                <div className="p-4 border-b border-gray-600 flex justify-between items-center">
                                    <h3 className="font-semibold text-white">Notifications</h3>
                                    <button onClick={markAllAsRead} className="text-sm text-indigo-400 hover:text-indigo-300">Mark all as read</button>
                                </div>
                                <div className="max-h-60 overflow-y-auto custom-scrollbar">
                                    {notifications.length === 0 ? (
                                        <p className="p-4 text-gray-400">No new notifications.</p>
                                    ) : (
                                        notifications.map(n => (
                                            <div key={n.id} onClick={() => handleNotificationClick(n)} className={`p-3 border-b border-gray-600 hover:bg-gray-600 cursor-pointer ${n.read ? 'text-gray-400' : 'text-white font-medium'}`}>
                                                {n.message}
                                            </div>
                                        ))
                                    )}
                                </div>
                            </div>
                        )}
                    </div>


                    {/* Avatar */}
                    <button onClick={toggleProfile} className="p-2 rounded-full hover:bg-gray-700 transition duration-200" aria-label="User avatar">
                        <img src="https://placehold.co/32x32/FF7700/FFFFFF?text=CM" alt="User Avatar" className="h-8 w-8 rounded-full" />
                    </button>
                    {/* Logout Button (for demo) */}
                    {userId && (
                        <button onClick={onLogout} className="px-3 py-1 bg-red-600 hover:bg-red-700 text-white text-sm rounded-md shadow-md transition duration-200">
                            Logout
                        </button>
                    )}
                </div>
            </nav>
        );
    };

    // Sidebar Component
    const Sidebar = ({ isSidebarOpen, toggleSidebar, navigateTo, currentPage }) => {
        const sidebarRef = useRef(null);

        useEffect(() => {
            const handleClickOutside = (event) => {
                if (isSidebarOpen && sidebarRef.current && !sidebarRef.current.contains(event.target) && !event.target.closest('nav button')) {
                    toggleSidebar(false);
                }
            };
            document.addEventListener('mousedown', handleClickOutside);
            return () => document.removeEventListener('mousedown', handleClickOutside);
        }, [isSidebarOpen, toggleSidebar]);

        const NavLink = ({ to, icon, label }) => (
            <button
                onClick={() => { navigateTo(to); if (window.innerWidth < 1024) toggleSidebar(false); }}
                className={`flex items-center p-3 rounded-lg hover:bg-indigo-700 transition duration-200 ${currentPage === to ? 'bg-indigo-600' : ''} ${!isSidebarOpen && 'justify-center'} `}
                aria-label={label}
            >
                {icon}
                {isSidebarOpen && <span className="ml-3">{label}</span>}
            </button>
        );

        return (
            <>
                {isSidebarOpen && window.innerWidth < 1024 && (
                    <div className="fixed inset-0 bg-gray-900 bg-opacity-75 z-30" onClick={() => toggleSidebar(false)}></div>
                )}
                <aside ref={sidebarRef} className={`fixed top-16 left-0 h-[calc(100vh-4rem)] bg-gray-800 text-gray-100 shadow-xl z-40 transition-all duration-300 ease-in-out pt-4 ${isSidebarOpen ? 'w-64' : 'w-20'} ${!isSidebarOpen && 'items-center'} flex flex-col`}>
                    <div className={`p-4 flex ${isSidebarOpen ? 'justify-between' : 'justify-center'} items-center mb-4`}>
                        {isSidebarOpen && <span className="text-xl font-semibold">Menu</span>}
                        <button onClick={() => toggleSidebar(!isSidebarOpen)} className="p-2 rounded-full hover:bg-gray-700 transition duration-200" aria-label="Toggle sidebar">
                            <svg xmlns="http://www.w3.org/2000/svg" className={`h-6 w-6 transform ${isSidebarOpen ? 'rotate-180' : ''}`} fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" />
                            </svg>
                        </button>
                    </div>
                    <nav className="flex-grow p-4 space-y-2">
                        <NavLink to="/home" label="Home" icon={
                            <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                            </svg>
                        } />
                        <NavLink to="/practice" label="Practice" icon={
                            <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4" />
                            </svg>
                        } />
                        <NavLink to="/battle" label="Battles" icon={
                            <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M18 12v3M18 18v3M18 6v3m4 2a4 4 0 11-8 0 4 4 0 018 0zm-12 3v1m-3 2v3m0-3V6a3 3 0 013-3h2M6 16V6a3 3 0 00-3-3h2m0 14v1m0 0h1v1m-1-1h-1m-1-1v-1m0 0a1 1 0 01-1-1v-4a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1" />
                            </svg>
                        } />
                        <NavLink to="/leaderboard" label="Leaderboard" icon={
                            <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                            </svg>
                        } />
                        <NavLink to="/friends" label="Friends" icon={
                            <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H2v-2a3 3 0 00-3 3v2m10-11H9V3l4 4-4 4zm1-8v2.071c.795.347 1.637.669 2.5.91V3.929c-.863.241-1.705.563-2.5.91zM7 7a2 2 0 100-4 2 2 0 000 4zm10 0a2 2 0 100-4 2 2 0 000 4zm-4 4a2 2 0 100-4 2 2 0 000 4z" />
                            </svg>
                        } />
                        <NavLink to="/notes" label="Notes" icon={
                            <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6M9 8h6m2 8a2 2 0 002-2V6a2 2 0 00-2-2H9l-2-2H5a2 2 0 00-2 2v14a2 2 0 002 2h12z" />
                            </svg>
                        } />
                        <NavLink to="/profile" label="Profile" icon={
                            <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                            </svg>
                        } />
                    </nav>
                </aside>
            </>
        );
    };

    // Login Page Component
    const LoginPage = ({ onLoginSuccess, navigateTo }) => {
        const [email, setEmail] = useState('demo@codera.com');
        const [password, setPassword] = useState('password');
        const [confirmPassword, setConfirmPassword] = useState('');
        const [error, setError] = useState('');
        const [loading, setLoading] = useState(false);
        const [showAlert, setShowAlert] = useState(false);
        const [isSignUp, setIsSignUp] = useState(false);

        const handleLogin = async () => {
            setLoading(true);
            setError('');
            try {
                const auth = getAuth();
                await signInWithEmailAndPassword(auth, email, password);
                setShowAlert(true);
                setTimeout(() => {
                    setShowAlert(false);
                    onLoginSuccess(); // Redirects to /home
                }, 1000);
            } catch (err) {
                setError("Invalid credentials. Please try demo@codera.com / password.");
                console.error("Login error:", err);
            } finally {
                setLoading(false);
            }
        };

        const handleGoogleLogin = async () => {
            setLoading(true);
            setError('');
            try {
                const auth = getAuth();
                const provider = new GoogleAuthProvider();
                const result = await signInWithPopup(auth, provider);
                const user = result.user;
                console.log('Google login successful:', user.displayName, user.email);
                setShowAlert(true);
                setTimeout(() => {
                    setShowAlert(false);
                    onLoginSuccess(); // Redirects to /home
                }, 1000);
            } catch (err) {
                if (err.code === 'auth/popup-closed-by-user') {
                    setError('Sign-in was cancelled. Please try again.');
                } else if (err.code === 'auth/popup-blocked') {
                    setError('Pop-up was blocked by browser. Please allow pop-ups and try again.');
                } else {
                    setError('Google sign-in failed. Please try again.');
                }
                console.error('Google login error:', err);
            } finally {
                setLoading(false);
            }
        };

        const handleSignUp = async () => {
            if (password !== confirmPassword) {
                setError('Passwords do not match.');
                return;
            }
            
            if (password.length < 6) {
                setError('Password must be at least 6 characters long.');
                return;
            }

            setLoading(true);
            setError('');
            try {
                const auth = getAuth();
                const result = await createUserWithEmailAndPassword(auth, email, password);
                const user = result.user;
                console.log('Signup successful:', user.uid, user.email);
                setShowAlert(true);
                setTimeout(() => {
                    setShowAlert(false);
                    onLoginSuccess(); // Redirects to /home
                }, 1000);
            } catch (err) {
                if (err.code === 'auth/email-already-in-use') {
                    setError('This email is already registered. Try signing in instead.');
                } else if (err.code === 'auth/invalid-email') {
                    setError('Please enter a valid email address.');
                } else if (err.code === 'auth/weak-password') {
                    setError('Password is too weak. Please choose a stronger password.');
                } else {
                    setError('Sign up failed. Please try again.');
                }
                console.error('Signup error:', err);
            } finally {
                setLoading(false);
            }
        };

        const toggleMode = () => {
            setIsSignUp(!isSignUp);
            setError('');
            setEmail(isSignUp ? 'demo@codera.com' : '');
            setPassword(isSignUp ? 'password' : '');
            setConfirmPassword('');
        };

        return (
            <div className="min-h-screen flex items-center justify-center bg-gray-900 px-4">
                <div className="bg-gray-800 p-8 rounded-lg shadow-2xl w-full max-w-md border border-indigo-700 animate-fade-in-up">
                    <h2 className="text-3xl font-bold text-center text-indigo-400 mb-6">
                        {isSignUp ? 'Join Codera' : 'Welcome to Codera'}
                    </h2>
                    {showAlert && (
                        <div className="bg-green-500 text-white p-3 rounded-md mb-4 text-center animate-pulse">
                            Login successful! Redirecting...
                        </div>
                    )}
                    {error && (
                        <div className="bg-red-500 text-white p-3 rounded-md mb-4 text-center">
                            {error}
                        </div>
                    )}
                    <div className="space-y-4">
                        <div>
                            <label htmlFor="email" className="block text-gray-300 text-sm font-medium mb-1">Email</label>
                            <input
                                type="email"
                                id="email"
                                className="w-full p-3 bg-gray-700 border border-gray-600 rounded-md text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                value={email}
                                onChange={(e) => setEmail(e.target.value)}
                                placeholder="demo@codera.com"
                                aria-label="Email"
                            />
                        </div>
                        <div>
                            <label htmlFor="password" className="block text-gray-300 text-sm font-medium mb-1">Password</label>
                            <input
                                type="password"
                                id="password"
                                className="w-full p-3 bg-gray-700 border border-gray-600 rounded-md text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                value={password}
                                onChange={(e) => setPassword(e.target.value)}
                                placeholder={isSignUp ? "Enter your password" : "password"}
                                aria-label="Password"
                            />
                        </div>
                        {isSignUp && (
                            <div>
                                <label htmlFor="confirmPassword" className="block text-gray-300 text-sm font-medium mb-1">Confirm Password</label>
                                <input
                                    type="password"
                                    id="confirmPassword"
                                    className="w-full p-3 bg-gray-700 border border-gray-600 rounded-md text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    value={confirmPassword}
                                    onChange={(e) => setConfirmPassword(e.target.value)}
                                    placeholder="Confirm your password"
                                    aria-label="Confirm Password"
                                />
                            </div>
                        )}
                        <button
                            onClick={isSignUp ? handleSignUp : handleLogin}
                            disabled={loading}
                            className="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold p-3 rounded-md shadow-lg transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-indigo-500 flex items-center justify-center"
                        >
                            {loading ? (
                                <svg className="animate-spin h-5 w-5 text-white mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                    <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                                    <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                            ) : (
                                isSignUp ? 'Create Account' : 'Sign In'
                            )}
                        </button>
                        
                        {/* Divider */}
                        <div className="flex items-center my-4">
                            <div className="flex-grow h-px bg-gray-600"></div>
                            <span className="mx-4 text-gray-400 text-sm">or</span>
                            <div className="flex-grow h-px bg-gray-600"></div>
                        </div>
                        
                        {/* Google Sign-In Button */}
                        <button
                            onClick={handleGoogleLogin}
                            disabled={loading}
                            className="w-full bg-white hover:bg-gray-100 text-gray-800 font-bold p-3 rounded-md shadow-lg transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-red-500 flex items-center justify-center border border-gray-300"
                        >
                            {loading ? (
                                <svg className="animate-spin h-5 w-5 text-gray-800 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                    <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                                    <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                            ) : (
                                <>
                                    <svg className="w-5 h-5 mr-3" viewBox="0 0 24 24">
                                        <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                                        <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                                        <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                                        <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                                    </svg>
                                    Continue with Google
                                </>
                            )}
                        </button>
                    </div>
                    <p className="text-center text-gray-400 text-sm mt-6">
                        {isSignUp ? (
                            <>Already have an account? <button className="text-blue-400 hover:underline" onClick={toggleMode}>Sign in</button></>
                        ) : (
                            <>Don't have an account? <button className="text-blue-400 hover:underline" onClick={toggleMode}>Sign up</button></>
                        )}
                    </p>
                </div>
            </div>
        );
    };

    // Home Page Component
    const HomePage = ({ username, streakCount, badges, navigateTo }) => {
        // Mock data for recent activity
        const recentActivity = [
            { id: 1, type: 'problem', title: 'Two Sum', status: 'Solved', difficulty: 'Easy', date: '2 days ago' },
            { id: 2, type: 'battle', title: 'Battle with PlayerX', result: 'Won', opponent: 'PlayerX', date: '1 day ago', badge: 'First Win' },
            { id: 3, type: 'problem', title: 'Reverse Linked List', status: 'Attempted', difficulty: 'Medium', date: '1 day ago' },
            { id: 4, type: 'battle', title: 'Battle with PlayerY', result: 'Lost', opponent: 'PlayerY', date: '5 hours ago' },
        ];

        // Question of the Day - rotate through different problems
        const today = new Date();
        const dayOfYear = Math.floor((today - new Date(today.getFullYear(), 0, 0)) / (1000 * 60 * 60 * 24));
        const qotdProblemId = (dayOfYear % 5) + 1; // Cycle through problems 1-5
        
        const qotdTitles = {
            1: "Two Sum",
            2: "Add Two Numbers", 
            3: "Longest Substring Without Repeating Characters",
            4: "Median of Two Sorted Arrays",
            5: "Reverse Linked List"
        };
        
        const qotd = {
            title: qotdTitles[qotdProblemId],
            problemId: qotdProblemId
        };

        return (
            <div className="p-8 pt-24 pl-28 lg:pl-28 min-h-screen bg-gray-900 text-gray-100 font-inter">
                <h1 className="text-4xl font-bold text-white mb-6">Welcome back, <span className="text-indigo-400">{username || "CodeMaster"}!</span></h1>

                {/* User Stats & Badges */}
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                    <div className="bg-gray-800 p-6 rounded-lg shadow-lg border border-indigo-700">
                        <h3 className="text-xl font-semibold text-white mb-2">Current Streak üî•</h3>
                        <p className="text-3xl font-bold text-orange-400">{streakCount || 7} Days</p>
                        <p className="text-gray-400 text-sm mt-2">Keep up the great work!</p>
                    </div>
                    <div className="bg-gray-800 p-6 rounded-lg shadow-lg border border-indigo-700">
                        <h3 className="text-xl font-semibold text-white mb-2">Your Badges üèÜ</h3>
                        <div className="flex flex-wrap gap-2 mt-2">
                            {(badges || ["First Win", "10-Day Streak"]).map((badge, index) => (
                                <span key={index} className="px-3 py-1 bg-green-600 text-green-100 text-sm font-medium rounded-full">
                                    {badge}
                                </span>
                            ))}
                        </div>
                        <p className="text-gray-400 text-sm mt-2">Earn more by competing and practicing!</p>
                    </div>
                    <div className="bg-gray-800 p-6 rounded-lg shadow-lg border border-indigo-700">
                        <h3 className="text-xl font-semibold text-white mb-2">Question of the Day üí°</h3>
                        <p className="text-lg font-medium text-blue-400 mb-3">{qotd.title}</p>
                        <button
                            onClick={() => navigateTo(`/practice/${qotd.problemId}`)}
                            className="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 rounded-md shadow-md transition duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
                        >
                            Solve Now
                        </button>
                        <p className="text-gray-400 text-xs mt-2">Complete it for bonus XP and streak boost!</p>
                    </div>
                </div>

                {/* Recent Activity */}
                <section className="mb-8">
                    <h2 className="text-2xl font-bold text-white mb-4">Recent Activity</h2>
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        {recentActivity.map(activity => (
                            <div key={activity.id} className="bg-gray-800 p-4 rounded-lg shadow-md border border-gray-700 hover:border-indigo-500 transition duration-200 cursor-pointer">
                                <div className="flex justify-between items-center mb-2">
                                    <span className={`px-2 py-1 text-xs font-medium rounded ${activity.type === 'problem' ? 'bg-indigo-600' : 'bg-purple-600'} text-white`}>
                                        {activity.type === 'problem' ? 'Problem' : 'Battle'}
                                    </span>
                                    {activity.status && (
                                        <span className={`text-xs font-semibold ${activity.status === 'Solved' || activity.result === 'Won' ? 'text-green-400' : 'text-red-400'}`}>
                                            {activity.status || activity.result}
                                        </span>
                                    )}
                                </div>
                                <h3 className="text-lg font-semibold text-white">{activity.title}</h3>
                                {activity.opponent && <p className="text-gray-300 text-sm">vs. {activity.opponent}</p>}
                                {activity.difficulty && <p className="text-gray-400 text-xs">Difficulty: {activity.difficulty}</p>}
                                {activity.badge && <p className="text-yellow-400 text-xs mt-1">Badge Earned: {activity.badge}</p>}
                                <p className="text-gray-500 text-xs mt-2">{activity.date}</p>
                            </div>
                        ))}
                    </div>
                </section>

                {/* Other sections would go here (e.g., Upcoming Contests, Friends Online) */}
                <section>
                    <h2 className="text-2xl font-bold text-white mb-4">Quick Links</h2>
                    <div className="flex flex-wrap gap-4">
                        <button onClick={() => navigateTo('/battle/random')} className="px-6 py-3 bg-purple-600 hover:bg-purple-700 text-white font-medium rounded-md shadow-lg transition duration-200">
                            Battle with Random
                        </button>
                        <button onClick={() => navigateTo('/practice')} className="px-6 py-3 bg-teal-600 hover:bg-teal-700 text-white font-medium rounded-md shadow-lg transition duration-200">
                            Go to Practice
                        </button>
                    </div>
                </section>
            </div>
        );
    };

    // Practice Problem Page Component (Minimal for routing demo)
// import React, { useState, useEffect, useRef } from "react";



const PracticeProblemPage = ({ problemId }) => {
  // Problems data structure
  const problemsData = {
    1: {
      title: "Two Sum",
      description: "Given an array of integers nums and an integer target, return indices of the two numbers such that they add up to target. You may assume that each input has exactly one solution, and you may not use the same element twice.",
      examples: [
        "Input: nums = [2,7,11,15], target = 9\nOutput: [0,1]\nExplanation: Because nums[0] + nums[1] == 9, we return [0, 1].",
        "Input: nums = [3,2,4], target = 6\nOutput: [1,2]",
        "Input: nums = [3,3], target = 6\nOutput: [0,1]"
      ],
      constraints: [
        "2 <= nums.length <= 104",
        "-109 <= nums[i] <= 109",
        "-109 <= target <= 109",
        "Only one valid answer exists."
      ],
      starterCode: {
        javascript: `function twoSum(nums, target) {\n  // Write your JavaScript code here\n}`,
        python: `def two_sum(nums, target):\n    # Write your Python code here`,
        java: `public int[] twoSum(int[] nums, int target) {\n    // Write your Java code here\n    return new int[0];\n}`,
        cpp: `vector<int> twoSum(const vector<int>& nums, int target) {\n    // Write your C++ code here\n    return {};\n}`,
      },
      testCases: [
        { input: [2, 7, 11, 15], target: 9, expected: [0, 1] },
        { input: [3, 2, 4], target: 6, expected: [1, 2] },
        { input: [3, 3], target: 6, expected: [0, 1] },
        { input: [5, 5, 1, 1], target: 10, expected: [0, 1] },
      ],
    },
    2: {
      title: "Add Two Numbers",
      description: "You are given two non-empty linked lists representing two non-negative integers. The digits are stored in reverse order, and each of their nodes contains a single digit. Add the two numbers and return the sum as a linked list.",
      examples: [
        "Input: l1 = [2,4,3], l2 = [5,6,4]\nOutput: [7,0,8]\nExplanation: 342 + 465 = 807.",
        "Input: l1 = [0], l2 = [0]\nOutput: [0]",
        "Input: l1 = [9,9,9,9,9,9,9], l2 = [9,9,9,9]\nOutput: [8,9,9,9,0,0,0,1]"
      ],
      constraints: [
        "The number of nodes in each linked list is in the range [1, 100].",
        "0 <= Node.val <= 9",
        "It is guaranteed that the list represents a number that does not have leading zeros."
      ],
      starterCode: {
        javascript: `function addTwoNumbers(l1, l2) {\n  // Write your JavaScript code here\n}`,
        python: `def add_two_numbers(l1, l2):\n    # Write your Python code here`,
        java: `public int[] addTwoNumbers(int[] l1, int[] l2) {\n    // Write your Java code here\n    return new int[0];\n}`,
        cpp: `vector<int> addTwoNumbers(const vector<int>& l1, const vector<int>& l2) {\n    // Write your C++ code here\n    return {};\n}`,
      },
      testCases: [
        { input: { l1: [2,4,3], l2: [5,6,4] }, expected: [7,0,8] },
        { input: { l1: [0], l2: [0] }, expected: [0] },
        { input: { l1: [9,9,9,9,9,9,9], l2: [9,9,9,9] }, expected: [8,9,9,9,0,0,0,1] },
      ],
    },
    3: {
      title: "Longest Substring Without Repeating Characters",
      description: "Given a string s, find the length of the longest substring without repeating characters.",
      examples: [
        "Input: s = \"abcabcbb\"\nOutput: 3\nExplanation: The answer is \"abc\", with the length of 3.",
        "Input: s = \"bbbbb\"\nOutput: 1\nExplanation: The answer is \"b\", with the length of 1.",
        "Input: s = \"pwwkew\"\nOutput: 3\nExplanation: The answer is \"wke\", with the length of 3."
      ],
      constraints: [
        "0 <= s.length <= 5 * 104",
        "s consists of English letters, digits, symbols and spaces."
      ],
      starterCode: {
        javascript: `function lengthOfLongestSubstring(s) {\n  // Write your JavaScript code here\n}`,
        python: `def length_of_longest_substring(s):\n    # Write your Python code here`,
        java: `public int lengthOfLongestSubstring(String s) {\n    // Write your Java code here\n    return 0;\n}`,
        cpp: `int lengthOfLongestSubstring(string s) {\n    // Write your C++ code here\n    return 0;\n}`,
      },
      testCases: [
        { input: "abcabcbb", expected: 3 },
        { input: "bbbbb", expected: 1 },
        { input: "pwwkew", expected: 3 },
        { input: "", expected: 0 },
      ],
    },
    4: {
      title: "Median of Two Sorted Arrays",
      description: "Given two sorted arrays nums1 and nums2 of size m and n respectively, return the median of the two sorted arrays. The overall run time complexity should be O(log (m+n)).",
      examples: [
        "Input: nums1 = [1,3], nums2 = [2]\nOutput: 2.00000\nExplanation: merged array = [1,2,3] and median is 2.",
        "Input: nums1 = [1,2], nums2 = [3,4]\nOutput: 2.50000\nExplanation: merged array = [1,2,3,4] and median is (2 + 3) / 2 = 2.5."
      ],
      constraints: [
        "nums1.length == m",
        "nums2.length == n",
        "0 <= m <= 1000",
        "0 <= n <= 1000",
        "1 <= m + n <= 2000",
        "-106 <= nums1[i], nums2[i] <= 106"
      ],
      starterCode: {
        javascript: `function findMedianSortedArrays(nums1, nums2) {\n  // Write your JavaScript code here\n}`,
        python: `def find_median_sorted_arrays(nums1, nums2):\n    # Write your Python code here`,
        java: `public double findMedianSortedArrays(int[] nums1, int[] nums2) {\n    // Write your Java code here\n    return 0.0;\n}`,
        cpp: `double findMedianSortedArrays(const vector<int>& nums1, const vector<int>& nums2) {\n    // Write your C++ code here\n    return 0.0;\n}`,
      },
      testCases: [
        { input: { nums1: [1,3], nums2: [2] }, expected: 2.0 },
        { input: { nums1: [1,2], nums2: [3,4] }, expected: 2.5 },
        { input: { nums1: [0,0], nums2: [0,0] }, expected: 0.0 },
      ],
    },
    5: {
      title: "Reverse Linked List",
      description: "Given the head of a singly linked list, reverse the list, and return the reversed list.",
      examples: [
        "Input: head = [1,2,3,4,5]\nOutput: [5,4,3,2,1]",
        "Input: head = [1,2]\nOutput: [2,1]",
        "Input: head = []\nOutput: []"
      ],
      constraints: [
        "The number of nodes in the list is the range [0, 5000].",
        "-5000 <= Node.val <= 5000"
      ],
      starterCode: {
        javascript: `function reverseList(head) {\n  // Write your JavaScript code here\n}`,
        python: `def reverse_list(head):\n    # Write your Python code here`,
        java: `public int[] reverseList(int[] head) {\n    // Write your Java code here\n    return new int[0];\n}`,
        cpp: `vector<int> reverseList(const vector<int>& head) {\n    // Write your C++ code here\n    return {};\n}`,
      },
      testCases: [
        { input: [1,2,3,4,5], expected: [5,4,3,2,1] },
        { input: [1,2], expected: [2,1] },
        { input: [], expected: [] },
      ],
    }
  };

  // Get the problem data based on problemId, default to Two Sum if not found
  const problem = problemsData[problemId] || problemsData[1];

  // Code editor state
  const [selectedLanguage, setSelectedLanguage] = useState("javascript");
  const [code, setCode] = useState(problem.starterCode[selectedLanguage]);
  const editorRef = useRef(null);
  const lastLanguage = useRef(selectedLanguage);

  // Output & loading
  const [output, setOutput] = useState("");
  const [loading, setLoading] = useState(false);

  // Tabs
  const [activeTab, setActiveTab] = useState("Description");

  // AI Chat state
  const [showAIHelper, setShowAIHelper] = useState(false);
  const [aiMessages, setAiMessages] = useState([]);
  const [newAiMessage, setNewAiMessage] = useState("");
  const [isAiResponding, setIsAiResponding] = useState(false);

  // Integrated Notes state (localStorage-backed)
  const [showNotes, setShowNotes] = useState(false);
  const [notes, setNotes] = useState(() => {
    try {
      const raw = localStorage.getItem('codera-notes');
      return raw ? JSON.parse(raw) : [];
    } catch (e) {
      return [];
    }
  });

  // Helper: persist notes
  const saveAllNotes = (next) => {
    setNotes(next);
    try { localStorage.setItem('codera-notes', JSON.stringify(next)); } catch(e) {}
  };

  // Filter notes for this context (practice + problemId)
  const contextKey = `practice:${problemId}`;
  const practiceNotes = useMemo(() => notes.filter(n => n.context?.key === contextKey), [notes, contextKey]);
  const [hasSelection, setHasSelection] = useState(false);

  // Create a note from current selection
  const handleSaveSelectionToNotes = () => {
    const ed = editorRef.current;
    if (!ed) return alert('Editor not ready');
    const sel = (ed.getSelection && ed.getSelection()) || '';
    const snippet = (sel || '').trim();
    if (!snippet) return alert('Please select some code in the editor first.');
    const defaultTitle = snippet.split('\n')[0].slice(0, 60) || 'Snippet';
    let custom = '';
    try { custom = window.prompt('Enter a title for this note:', defaultTitle) ?? ''; } catch (e) { custom = defaultTitle; }
    if (custom === null) return; // cancelled
    const title = (custom.trim() || defaultTitle);
    const note = {
      id: `note_${Date.now()}_${Math.random().toString(36).slice(2,8)}`,
      title,
      snippet,
      language: selectedLanguage,
      createdAt: new Date().toISOString(),
      context: { mode: 'practice', key: contextKey, problemId }
    };
    saveAllNotes([note, ...notes]);
    setShowNotes(true);
  };

  const handleInsertNoteAtCursor = (note) => {
    const ed = editorRef.current;
    if (!ed) return;
    if (ed.replaceSelection) ed.replaceSelection(note.snippet);
  };

  const handleCopyNote = async (note) => {
    try { await navigator.clipboard.writeText(note.snippet); } catch (e) { console.log('Clipboard not available'); }
  };

  const handleDeleteNote = (id) => {
    const next = notes.filter(n => n.id !== id);
    saveAllNotes(next);
  };

  // Initialize CodeMirror
  useEffect(() => {
    const editorContainer = document.getElementById("code-editor");
    if (!editorContainer || !window.CodeMirror) return;

    editorRef.current = window.CodeMirror(editorContainer, {
      value: problem.starterCode[selectedLanguage],
      mode: selectedLanguage === "javascript" ? "javascript" : 
            selectedLanguage === "python" ? "python" :
            selectedLanguage === "java" ? "text/x-java" :
            selectedLanguage === "cpp" ? "text/x-c++src" : "javascript",
      theme: (function(){
        try { return (localStorage.getItem('theme') || 'dark') === 'dark' ? 'dracula' : 'default'; } catch(e) { return 'dracula'; }
      })(),
      lineNumbers: true,
      indentUnit: 4,
      smartIndent: true,
    });

    editorRef.current.on("change", (instance) => setCode(instance.getValue()));
    editorRef.current.on("cursorActivity", (cm) => {
      try {
        const s = cm.getSelection ? cm.getSelection() : '';
        setHasSelection(!!(s && s.trim()));
      } catch (e) { setHasSelection(false); }
    });

    // React to theme changes globally
    const handleThemeChange = (e) => {
      const next = e?.detail || 'dark';
      if (editorRef.current) {
        editorRef.current.setOption('theme', next === 'dark' ? 'dracula' : 'default');
      }
    };
    window.addEventListener('theme-change', handleThemeChange);

    return () => {
      if (editorRef.current) {
        editorRef.current.toTextArea?.();
        editorRef.current = null;
      }
      window.removeEventListener('theme-change', handleThemeChange);
    };
  }, []);

  // Handle language switch without overwriting
  useEffect(() => {
    if (editorRef.current && lastLanguage.current !== selectedLanguage) {
      const mode = selectedLanguage === "javascript" ? "javascript" : 
                   selectedLanguage === "python" ? "python" :
                   selectedLanguage === "java" ? "text/x-java" :
                   selectedLanguage === "cpp" ? "text/x-c++src" : "javascript";
      editorRef.current.setOption("mode", mode);
      editorRef.current.setValue(problem.starterCode[selectedLanguage]);
      lastLanguage.current = selectedLanguage;
      setCode(problem.starterCode[selectedLanguage]);
    }
  }, [selectedLanguage, problem.starterCode]);

  // Update code when problem changes
  useEffect(() => {
    setCode(problem.starterCode[selectedLanguage]);
    if (editorRef.current) {
      editorRef.current.setValue(problem.starterCode[selectedLanguage]);
    }
  }, [problemId, selectedLanguage]);

  // Simulate running code
  // Replace handleRunCode with Judge0 API call
const handleRunCode = async () => {
  setLoading(true);
  setOutput("Running code with Judge0...");

  const languageMap = {
    javascript: 63, // Node.js
    python: 71,     // Python 3
    java: 62,       // Java
    cpp: 54,        // C++ 17
  };

  // Run with the first test case only for "Run Code"
  const test = problem.testCases[0];

  // Get function name based on problem
  const functionName = problemId == 1 ? 'twoSum' : 
                      problemId == 2 ? 'addTwoNumbers' :
                      problemId == 3 ? 'lengthOfLongestSubstring' :
                      problemId == 4 ? 'findMedianSortedArrays' :
                      problemId == 5 ? 'reverseList' : 'twoSum';

  const pythonFunctionName = problemId == 1 ? 'two_sum' : 
                            problemId == 2 ? 'add_two_numbers' :
                            problemId == 3 ? 'length_of_longest_substring' :
                            problemId == 4 ? 'find_median_sorted_arrays' :
                            problemId == 5 ? 'reverse_list' : 'two_sum';

  const javaFunctionName = problemId == 1 ? 'twoSum' : 
                          problemId == 2 ? 'addTwoNumbers' :
                          problemId == 3 ? 'lengthOfLongestSubstring' :
                          problemId == 4 ? 'findMedianSortedArrays' :
                          problemId == 5 ? 'reverseList' : 'twoSum';

  const cppFunctionName = problemId == 1 ? 'twoSum' : 
                         problemId == 2 ? 'addTwoNumbers' :
                         problemId == 3 ? 'lengthOfLongestSubstring' :
                         problemId == 4 ? 'findMedianSortedArrays' :
                         problemId == 5 ? 'reverseList' : 'twoSum';

  // Handle different parameter structures for different problems
  let functionCall = "";
  
  if (problemId == 1) {
    // Two Sum: twoSum(nums, target)
    if (selectedLanguage === "javascript") {
      functionCall = `${functionName}(${JSON.stringify(test.input)}, ${test.target})`;
    } else if (selectedLanguage === "python") {
      functionCall = `${pythonFunctionName}(${JSON.stringify(test.input)}, ${test.target})`;
    } else if (selectedLanguage === "java") {
      functionCall = `${javaFunctionName}(new int[]{${test.input.join(',')}}, ${test.target})`;
    } else if (selectedLanguage === "cpp") {
      functionCall = `${cppFunctionName}({${test.input.join(',')}}, ${test.target})`;
    }
  } else if (problemId == 2) {
    // Add Two Numbers: addTwoNumbers(l1, l2)
    if (selectedLanguage === "javascript") {
      functionCall = `${functionName}(${JSON.stringify(test.input.l1)}, ${JSON.stringify(test.input.l2)})`;
    } else if (selectedLanguage === "python") {
      functionCall = `${pythonFunctionName}(${JSON.stringify(test.input.l1)}, ${JSON.stringify(test.input.l2)})`;
    } else if (selectedLanguage === "java") {
      functionCall = `${javaFunctionName}(new int[]{${test.input.l1.join(',')}}, new int[]{${test.input.l2.join(',')}})`;
    } else if (selectedLanguage === "cpp") {
      functionCall = `${cppFunctionName}({${test.input.l1.join(',')}}, {${test.input.l2.join(',')}})`;
    }
  } else if (problemId == 3) {
    // Longest Substring: lengthOfLongestSubstring(s)
    if (selectedLanguage === "javascript") {
      functionCall = `${functionName}(${JSON.stringify(test.input)})`;
    } else if (selectedLanguage === "python") {
      functionCall = `${pythonFunctionName}(${JSON.stringify(test.input)})`;
    } else if (selectedLanguage === "java") {
      functionCall = `${javaFunctionName}("${test.input}")`;
    } else if (selectedLanguage === "cpp") {
      functionCall = `${cppFunctionName}("${test.input}")`;
    }
  } else if (problemId == 4) {
    // Median of Arrays: findMedianSortedArrays(nums1, nums2)
    if (selectedLanguage === "javascript") {
      functionCall = `${functionName}(${JSON.stringify(test.input.nums1)}, ${JSON.stringify(test.input.nums2)})`;
    } else if (selectedLanguage === "python") {
      functionCall = `${pythonFunctionName}(${JSON.stringify(test.input.nums1)}, ${JSON.stringify(test.input.nums2)})`;
    } else if (selectedLanguage === "java") {
      functionCall = `${javaFunctionName}(new int[]{${test.input.nums1.join(',')}}, new int[]{${test.input.nums2.join(',')}})`;
    } else if (selectedLanguage === "cpp") {
      functionCall = `${cppFunctionName}({${test.input.nums1.join(',')}}, {${test.input.nums2.join(',')}})`;
    }
  } else if (problemId == 5) {
    // Reverse List: reverseList(head)
    if (selectedLanguage === "javascript") {
      functionCall = `${functionName}(${JSON.stringify(test.input)})`;
    } else if (selectedLanguage === "python") {
      functionCall = `${pythonFunctionName}(${JSON.stringify(test.input)})`;
    } else if (selectedLanguage === "java") {
      functionCall = `${javaFunctionName}(new int[]{${test.input.join(',')}})`;
    } else if (selectedLanguage === "cpp") {
      functionCall = `${cppFunctionName}({${test.input.join(',')}})`;
    }
  }

  // Fallback: if functionCall is still empty, use a default
  if (!functionCall) {
    if (selectedLanguage === "javascript") {
      functionCall = `${functionName}(${JSON.stringify(test.input)}, ${test.target})`;
    } else if (selectedLanguage === "python") {
      functionCall = `${pythonFunctionName}(${JSON.stringify(test.input)}, ${test.target})`;
    } else if (selectedLanguage === "java") {
      functionCall = `${javaFunctionName}(new int[]{${test.input.join(',')}}, ${test.target})`;
    } else if (selectedLanguage === "cpp") {
      functionCall = `${cppFunctionName}({${test.input.join(',')}}, ${test.target})`;
    }
  }

  // Generate wrapped code based on language
  let wrappedCode = "";
  if (selectedLanguage === "javascript") {
    wrappedCode = `${code}

// Auto-call the function with test case
try {
    const result = ${functionCall};
    console.log(JSON.stringify(result));
} catch (error) {
    console.error(error.message);
}`;
  } else if (selectedLanguage === "python") {
    wrappedCode = `
${code}

# Auto-call the function with test case
import json
print(json.dumps(${functionCall}))
`;
  } else if (selectedLanguage === "java") {
    // Extract the method body from user code
    let methodBody = code.trim();
    
    // Remove 'public' prefix if it exists
    if (methodBody.startsWith('public ')) {
        methodBody = methodBody.replace(/^public\s+/, '');
    }
    
    // Ensure it has public static prefix
    if (!methodBody.startsWith('static ')) {
        methodBody = 'public static ' + methodBody;
    } else {
        methodBody = 'public ' + methodBody;
    }
    
    // For problems that return non-array types, don't use Arrays.toString()
    const needsArraysToString = problemId === 1 || problemId === 2 || problemId === 5;
    const printStatement = needsArraysToString ? `Arrays.toString(${functionCall})` : `${functionCall}`;
    
    wrappedCode = `import java.util.*;

public class Main {
    ${methodBody}
    
    public static void main(String[] args) {
        try {
            System.out.println(${printStatement});
        } catch (Exception e) {
            System.err.println("Error: " + e.getMessage());
        }
    }
}`;
  } else if (selectedLanguage === "cpp") {
    wrappedCode = `#include <iostream>
#include <vector>
#include <string>
#include <algorithm>
#include <sstream>
using namespace std;

// Helper function to print vectors
template<typename T>
void printVector(const vector<T>& vec) {
    cout << "[";
    for (size_t i = 0; i < vec.size(); ++i) {
        cout << vec[i];
        if (i < vec.size() - 1) cout << ",";
    }
    cout << "]";
}

${code}

int main() {
    try {
        auto result = ${functionCall};
        
        // Handle different return types
        if constexpr (std::is_same_v<decltype(result), vector<int>>) {
            printVector(result);
        } else {
            cout << result;
        }
        cout << endl;
    } catch (const exception& e) {
        cerr << "Error: " << e.what() << endl;
    }
    return 0;
}`;
  }

  try {
    const submission = {
      source_code: wrappedCode,
      language_id: languageMap[selectedLanguage],
      stdin: "",
    };

    const res = await fetch("https://judge0-ce.p.rapidapi.com/submissions?base64_encoded=true&wait=true", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "x-rapidapi-host": "judge0-ce.p.rapidapi.com",
        "x-rapidapi-key": "1f4bcaf085mshdb3d102dc891ab6p12b4d2jsn3480d98ed8c1"
      },
      body: JSON.stringify({
        source_code: btoa(wrappedCode),
        language_id: languageMap[selectedLanguage],
        stdin: btoa(""),
      }),
    });

    const result = await res.json();
    if (result.stdout) {
      setOutput("Output:\n" + atob(result.stdout));
    } else if (result.stderr) {
      setOutput("Error:\n" + atob(result.stderr));
    } else if (result.compile_output) {
      setOutput("Compilation Error:\n" + atob(result.compile_output));
    } else {
      setOutput("Unexpected response:\n" + JSON.stringify(result, null, 2));
    }
  } catch (err) {
    setOutput("Error calling Judge0: " + err.message);
  }

  setLoading(false);
};

// Replace handleSubmitCode with Judge0 + test cases
const handleSubmitCode = async () => {
  setLoading(true);
  setOutput("Submitting solution via Judge0...");

  const languageMap = {
    javascript: 63, // Node.js
    python: 71,     // Python 3
    java: 62,       // Java
    cpp: 54,        // C++ 17
  };

  let results = [];

  for (let i = 0; i < problem.testCases.length; i++) {
    const test = problem.testCases[i];

    // --- Wrap user code with a call to their function ---
    let wrappedCode = "";

    // Get function name based on problem
    const functionName = problemId === 1 ? 'twoSum' : 
                        problemId === 2 ? 'addTwoNumbers' :
                        problemId === 3 ? 'lengthOfLongestSubstring' :
                        problemId === 4 ? 'findMedianSortedArrays' :
                        problemId === 5 ? 'reverseList' : 'twoSum';

    const pythonFunctionName = problemId == 1 ? 'two_sum' : 
                              problemId == 2 ? 'add_two_numbers' :
                              problemId == 3 ? 'length_of_longest_substring' :
                              problemId == 4 ? 'find_median_sorted_arrays' :
                              problemId == 5 ? 'reverse_list' : 'two_sum';

    const javaFunctionName = problemId == 1 ? 'twoSum' : 
                            problemId == 2 ? 'addTwoNumbers' :
                            problemId == 3 ? 'lengthOfLongestSubstring' :
                            problemId == 4 ? 'findMedianSortedArrays' :
                            problemId == 5 ? 'reverseList' : 'twoSum';

    const cppFunctionName = problemId == 1 ? 'twoSum' : 
                           problemId == 2 ? 'addTwoNumbers' :
                           problemId == 3 ? 'lengthOfLongestSubstring' :
                           problemId == 4 ? 'findMedianSortedArrays' :
                           problemId == 5 ? 'reverseList' : 'twoSum';

    // Handle different parameter structures for different problems
    let functionCall = "";
    
    if (problemId == 1) {
      // Two Sum: twoSum(nums, target)
      if (selectedLanguage === "javascript") {
        functionCall = `${functionName}(${JSON.stringify(test.input)}, ${test.target})`;
      } else if (selectedLanguage === "python") {
        functionCall = `${pythonFunctionName}(${JSON.stringify(test.input)}, ${test.target})`;
      } else if (selectedLanguage === "java") {
        functionCall = `${javaFunctionName}(new int[]{${test.input.join(',')}}, ${test.target})`;
      } else if (selectedLanguage === "cpp") {
        functionCall = `${cppFunctionName}({${test.input.join(',')}}, ${test.target})`;
      }
    } else if (problemId == 2) {
      // Add Two Numbers: addTwoNumbers(l1, l2)
      if (selectedLanguage === "javascript") {
        functionCall = `${functionName}(${JSON.stringify(test.input.l1)}, ${JSON.stringify(test.input.l2)})`;
      } else if (selectedLanguage === "python") {
        functionCall = `${pythonFunctionName}(${JSON.stringify(test.input.l1)}, ${JSON.stringify(test.input.l2)})`;
      } else if (selectedLanguage === "java") {
        functionCall = `${javaFunctionName}(new int[]{${test.input.l1.join(',')}}, new int[]{${test.input.l2.join(',')}})`;
      } else if (selectedLanguage === "cpp") {
        functionCall = `${cppFunctionName}({${test.input.l1.join(',')}}, {${test.input.l2.join(',')}})`;
      }
    } else if (problemId == 3) {
      // Longest Substring: lengthOfLongestSubstring(s)
      if (selectedLanguage === "javascript") {
        functionCall = `${functionName}(${JSON.stringify(test.input)})`;
      } else if (selectedLanguage === "python") {
        functionCall = `${pythonFunctionName}(${JSON.stringify(test.input)})`;
      } else if (selectedLanguage === "java") {
        functionCall = `${javaFunctionName}("${test.input}")`;
      } else if (selectedLanguage === "cpp") {
        functionCall = `${cppFunctionName}("${test.input}")`;
      }
    } else if (problemId == 4) {
      // Median of Arrays: findMedianSortedArrays(nums1, nums2)
      if (selectedLanguage === "javascript") {
        functionCall = `${functionName}(${JSON.stringify(test.input.nums1)}, ${JSON.stringify(test.input.nums2)})`;
      } else if (selectedLanguage === "python") {
        functionCall = `${pythonFunctionName}(${JSON.stringify(test.input.nums1)}, ${JSON.stringify(test.input.nums2)})`;
      } else if (selectedLanguage === "java") {
        functionCall = `${javaFunctionName}(new int[]{${test.input.nums1.join(',')}}, new int[]{${test.input.nums2.join(',')}})`;
      } else if (selectedLanguage === "cpp") {
        functionCall = `${cppFunctionName}({${test.input.nums1.join(',')}}, {${test.input.nums2.join(',')}})`;
      }
    } else if (problemId == 5) {
      // Reverse List: reverseList(head)
      if (selectedLanguage === "javascript") {
        functionCall = `${functionName}(${JSON.stringify(test.input)})`;
      } else if (selectedLanguage === "python") {
        functionCall = `${pythonFunctionName}(${JSON.stringify(test.input)})`;
      } else if (selectedLanguage === "java") {
        functionCall = `${javaFunctionName}(new int[]{${test.input.join(',')}})`;
      } else if (selectedLanguage === "cpp") {
        functionCall = `${cppFunctionName}({${test.input.join(',')}})`;
      }
    }

    // Fallback: if functionCall is still empty, use a default
    if (!functionCall) {
      if (selectedLanguage === "javascript") {
        functionCall = `${functionName}(${JSON.stringify(test.input)}, ${test.target})`;
      } else if (selectedLanguage === "python") {
        functionCall = `${pythonFunctionName}(${JSON.stringify(test.input)}, ${test.target})`;
      } else if (selectedLanguage === "java") {
        functionCall = `${javaFunctionName}(new int[]{${test.input.join(',')}}, ${test.target})`;
      } else if (selectedLanguage === "cpp") {
        functionCall = `${cppFunctionName}({${test.input.join(',')}}, ${test.target})`;
      }
    }


    if (selectedLanguage === "javascript") {
      wrappedCode = `
${code}

// Auto-call the function with test case
console.log(JSON.stringify(${functionCall}));
`;
    } else if (selectedLanguage === "javascript") {
      wrappedCode = `${code}

// Auto-call the function with test case
try {
    const result = ${functionCall};
    console.log(JSON.stringify(result));
} catch (error) {
    console.error(error.message);
}`;
    } else if (selectedLanguage === "python") {
      wrappedCode = `${code}

# Auto-call the function with test case
import json
print(json.dumps(${functionCall}))`;
    } else if (selectedLanguage === "java") {
      // Extract the method body from user code
      let methodBody = code.trim();
      
      // Remove 'public' prefix if it exists
      if (methodBody.startsWith('public ')) {
          methodBody = methodBody.replace(/^public\s+/, '');
      }
      
      // Ensure it has public static prefix
      if (!methodBody.startsWith('static ')) {
          methodBody = 'public static ' + methodBody;
      } else {
          methodBody = 'public ' + methodBody;
      }
      
      // For problems that return non-array types, don't use Arrays.toString()
      const needsArraysToString = problemId === 1 || problemId === 2 || problemId === 5;
      const printStatement = needsArraysToString ? `Arrays.toString(${functionCall})` : `${functionCall}`;
      
      wrappedCode = `import java.util.*;

public class Main {
    ${methodBody}
    
    public static void main(String[] args) {
        try {
            System.out.println(${printStatement});
        } catch (Exception e) {
            System.err.println("Error: " + e.getMessage());
        }
    }
}`;
    } else if (selectedLanguage === "cpp") {
      wrappedCode = `#include <iostream>
#include <vector>
#include <string>
#include <algorithm>
#include <sstream>
using namespace std;

// Helper function to print vectors
template<typename T>
void printVector(const vector<T>& vec) {
    cout << "[";
    for (size_t i = 0; i < vec.size(); ++i) {
        cout << vec[i];
        if (i < vec.size() - 1) cout << ",";
    }
    cout << "]";
}

${code}

int main() {
    try {
        auto result = ${functionCall};
        
        // Handle different return types
        if constexpr (std::is_same_v<decltype(result), vector<int>>) {
            printVector(result);
        } else {
            cout << result;
        }
        cout << endl;
    } catch (const exception& e) {
        cerr << "Error: " << e.what() << endl;
    }
    return 0;
}`;
    }


    try {
      const submission = {
        source_code: wrappedCode,
        language_id: languageMap[selectedLanguage],
        stdin: "",
      };

      const res = await fetch(
        "https://judge0-ce.p.rapidapi.com/submissions?base64_encoded=true&wait=true",
        {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "x-rapidapi-host": "judge0-ce.p.rapidapi.com",
            "x-rapidapi-key": "1f4bcaf085mshdb3d102dc891ab6p12b4d2jsn3480d98ed8c1" // Replace with your key
          },
          body: JSON.stringify({
            source_code: btoa(wrappedCode),
            language_id: languageMap[selectedLanguage],
            stdin: btoa(""),
          }),
        }
      );

      const result = await res.json();

      let verdict = "Wrong Answer";
      if (result.stdout) {
        const userOutput = JSON.parse(atob(result.stdout).trim());
        verdict =
          JSON.stringify(userOutput) === JSON.stringify(test.expected)
            ? "Passed"
            : `Failed (Expected ${JSON.stringify(test.expected)}, Got ${JSON.stringify(userOutput)})`;
      } else if (result.stderr) {
        verdict = "Runtime Error: " + atob(result.stderr);
      } else if (result.compile_output) {
        verdict = "Compilation Error: " + atob(result.compile_output);
      }

      results.push(`Test Case ${i + 1}: ${verdict}`);
    } catch (err) {
      results.push(`Test Case ${i + 1}: Error - ${err.message}`);
    }
  }

  setOutput(results.join("\n"));
  setLoading(false);
};



  // Simulate submitting code
  

  // AI helper
  const handleSendAiMessage = async () => {
    if (!newAiMessage.trim()) return;

    setAiMessages((prev) => [...prev, { sender: "User", text: newAiMessage }]);
    setNewAiMessage("");
    setIsAiResponding(true);

    try {
      const promptText = `You are Rollo, an AI coding assistant. The problem is "${problem.title}".
The user is asking for a hint or help. Provide a short conceptual hint.
User question: ${newAiMessage}`;

      const payload = { contents: [{ role: "user", parts: [{ text: promptText }] }] };
      const apiKey = "AIzaSyARdkaRogn-sS93dy26iCBoA60XUmLYJ80"; // Replace with your key
      const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`;

      const response = await fetch(apiUrl, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });

      if (!response.ok) throw new Error(`API error: ${response.status}`);
      const result = await response.json();
      const aiResponseText = result?.candidates?.[0]?.content?.parts?.[0]?.text;

      setAiMessages((prev) => [
        ...prev,
        { sender: "Rollo", text: aiResponseText || "I couldn't generate a response this time." },
      ]);
    } catch (error) {
      setAiMessages((prev) => [
        ...prev,
        { sender: "Rollo", text: "Sorry, I'm having trouble right now." },
      ]);
    } finally {
      setIsAiResponding(false);
    }
  };

  return (
    <div className="p-8 pt-24 lg:pl-28 min-h-screen bg-gray-900 text-gray-100 font-inter">
      <h1 className="text-3xl font-bold text-indigo-400 mb-6">
        {problem.title} (Problem ID: {problemId})
      </h1>

      <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
        {/* Problem Panel */}
        <div className="bg-gray-800 p-6 rounded-lg shadow-lg border border-indigo-700 flex flex-col">
          <div className="flex border-b border-gray-700 mb-4">
            {["Description", "Examples", "Constraints"].map((tab) => (
              <button
                key={tab}
                onClick={() => setActiveTab(tab)}
                className={`px-4 py-2 -mb-px border-b-2 ${
                  activeTab === tab
                    ? "border-indigo-500 text-indigo-400"
                    : "border-transparent text-gray-400 hover:text-white"
                } transition duration-200`}
              >
                {tab}
              </button>
            ))}
          </div>
          <div className="overflow-y-auto custom-scrollbar flex-grow">
            {activeTab === "Description" && <p>{problem.description}</p>}
            {activeTab === "Examples" && (
              <div>
                {problem.examples.map((ex, idx) => (
                  <pre key={idx} className="bg-gray-700 p-3 rounded-md text-gray-200 text-sm mb-2 overflow-x-auto">
                    <code>{ex}</code>
                  </pre>
                ))}
              </div>
            )}
            {activeTab === "Constraints" && (
              <ul className="list-disc pl-5 text-gray-300">
                {problem.constraints.map((c, idx) => <li key={idx}>{c}</li>)}
              </ul>
            )}
          </div>
        </div>

        {/* Code Editor Panel */}
        <div className="bg-gray-800 p-6 rounded-lg shadow-lg border border-indigo-700 flex flex-col">
          <div className="flex justify-between items-center mb-4">
            <h2 className="text-xl font-semibold">Code Editor</h2>
            <select
              value={selectedLanguage}
              onChange={(e) => setSelectedLanguage(e.target.value)}
              className="bg-gray-700 text-gray-100 p-2 rounded-md"
            >
              <option value="javascript">JavaScript</option>
              <option value="python">Python</option>
              <option value="java">Java</option>
              <option value="cpp">C++</option>
            </select>
          </div>

          <div className="relative mb-4">
            <div id="code-editor" className="flex-grow rounded-md border border-gray-700" style={{ height: "400px" }}></div>
            {hasSelection && (
              <button
                onClick={handleSaveSelectionToNotes}
                className="absolute top-2 right-2 px-3 py-1 text-xs bg-yellow-600 hover:bg-yellow-700 text-white rounded shadow"
                title="Save selected code to Notes"
              >
                Save selection
              </button>
            )}
          </div>

          <div className="flex flex-wrap justify-end gap-3 mb-4">
            <button onClick={handleRunCode} disabled={loading} className="px-6 py-2 bg-blue-600 rounded-md">Run Code</button>
            <button onClick={handleSubmitCode} disabled={loading} className="px-6 py-2 bg-green-600 rounded-md">Submit</button>
            <button onClick={handleSaveSelectionToNotes} className="px-6 py-2 bg-yellow-600 hover:bg-yellow-700 rounded-md text-white">Save selection to Notes</button>
            <button onClick={() => setShowNotes(s => !s)} className="px-6 py-2 bg-indigo-600 hover:bg-indigo-700 rounded-md text-white">{showNotes ? 'Hide Notes' : 'Show Notes'}</button>
          </div>

          <div className="bg-gray-700 p-3 rounded-md text-gray-200 text-sm min-h-[100px] overflow-auto">
            <h3 className="font-medium text-white mb-1">Output:</h3>
            <pre>{output}</pre>
          </div>

          {showNotes && (
            <div className="mt-4 bg-gray-700 p-4 rounded-md text-gray-100">
              <div className="flex items-center justify-between mb-2">
                <h3 className="text-lg font-semibold">Notes for this problem</h3>
                <span className="text-xs text-gray-300">{practiceNotes.length} saved</span>
              </div>
              {practiceNotes.length === 0 ? (
                <p className="text-gray-300 text-sm">No notes yet. Select code in the editor and click "Save selection to Notes".</p>
              ) : (
                <ul className="space-y-2">
                  {practiceNotes.map(note => (
                    <li key={note.id} className="bg-gray-800 border border-gray-600 rounded-md p-3">
                      <div className="flex items-center justify-between">
                        <div>
                          <div className="text-sm font-medium text-white">{note.title || 'Snippet'}</div>
                          <div className="text-xs text-gray-400">{new Date(note.createdAt).toLocaleString()} ‚Ä¢ {note.language}</div>
                        </div>
                        <div className="flex gap-2">
                          <button onClick={() => handleInsertNoteAtCursor(note)} className="px-3 py-1 text-xs bg-blue-600 hover:bg-blue-700 rounded">Insert</button>
                          <button onClick={() => handleCopyNote(note)} className="px-3 py-1 text-xs bg-teal-600 hover:bg-teal-700 rounded">Copy</button>
                          <button onClick={() => handleDeleteNote(note.id)} className="px-3 py-1 text-xs bg-red-600 hover:bg-red-700 rounded">Delete</button>
                        </div>
                      </div>
                      <pre className="mt-2 text-sm whitespace-pre-wrap text-gray-200 overflow-auto max-h-40">{note.snippet}</pre>
                    </li>
                  ))}
                </ul>
              )}
            </div>
          )}
        </div>
      </div>

      {/* AI Helper Button */}
      <button
        onClick={() => setShowAIHelper(!showAIHelper)}
        className="fixed bottom-6 right-6 bg-purple-600 p-4 rounded-full"
      >
        AI
      </button>

      {/* AI Chat */}
      {showAIHelper && (
        <div className="fixed bottom-20 right-6 w-80 h-96 bg-gray-800 rounded-lg shadow-2xl flex flex-col z-50 border border-indigo-700">
          <div className="p-4 border-b border-gray-700 flex justify-between">
            <h3 className="text-lg font-semibold text-white">Rollo</h3>
            <button onClick={() => setShowAIHelper(false)} className="text-gray-400 hover:text-white">X</button>
          </div>

          <div className="flex-grow p-4 overflow-y-auto space-y-3">
            {aiMessages.length === 0 ? (
              <p className="text-gray-400 text-sm">Hi! Ask me for hints...</p>
            ) : (
              aiMessages.map((msg, i) => (
                <div key={i} className={`flex ${msg.sender === "User" ? "justify-end" : "justify-start"}`}>
                  <div className={`max-w-[75%] p-2 rounded-lg ${msg.sender === "User" ? "bg-blue-600 text-white" : "bg-gray-700 text-gray-100"}`}>
                    <p className="text-sm">{msg.text}</p>
                  </div>
                </div>
              ))
            )}
            {isAiResponding && (
              <div className="flex justify-start">
                <div className="max-w-[75%] p-2 rounded-lg bg-gray-700 text-gray-100">
                  <p className="text-sm animate-pulse">Rollo is thinking...</p>
                </div>
              </div>
            )}
          </div>

          <div className="p-4 border-t border-gray-700 flex">
            <input
              type="text"
              value={newAiMessage}
              onChange={(e) => setNewAiMessage(e.target.value)}
              onKeyPress={(e) => { if (e.key === "Enter") handleSendAiMessage(); }}
              className="flex-grow bg-gray-700 text-gray-100 p-2 rounded-l-md"
              placeholder="Ask for a hint..."
              disabled={isAiResponding}
            />
            <button
              onClick={handleSendAiMessage}
              className="px-4 py-2 bg-indigo-600 rounded-r-md"
              disabled={isAiResponding || !newAiMessage.trim()}
            >
              {isAiResponding ? "..." : "Send"}
            </button>
          </div>
        </div>
      )}
    </div>
  );
};
    // Practice List Page (Minimal for routing demo)
    const PracticeListPage = ({ navigateTo }) => {
        const problems = [
            { id: 1, title: 'Two Sum', difficulty: 'Easy', status: 'Not Started', tags: ['Array', 'Hash Table'] },
            { id: 2, title: 'Add Two Numbers', difficulty: 'Medium', status: 'Attempted', tags: ['Linked List', 'Math'] },
            { id: 3, title: 'Longest Substring Without Repeating Characters', difficulty: 'Medium', status: 'Solved', tags: ['Hash Table', 'String', 'Sliding Window'] },
            { id: 4, title: 'Median of Two Sorted Arrays', difficulty: 'Hard', status: 'Not Started', tags: ['Array', 'Binary Search'] },
            { id: 5, title: 'Reverse Linked List', difficulty: 'Easy', status: 'Solved', tags: ['Linked List'] },
        ];

        const [filtersOpen, setFiltersOpen] = useState(false);
        const [difficultyFilter, setDifficultyFilter] = useState('');
        const [statusFilter, setStatusFilter] = useState('');
        const [tagFilter, setTagFilter] = useState('');
        const [searchQuery, setSearchQuery] = useState('');

        const allTags = [...new Set(problems.flatMap(p => p.tags))];

        const filteredProblems = problems.filter(problem => {
            const matchesDifficulty = difficultyFilter ? problem.difficulty === difficultyFilter : true;
            const matchesStatus = statusFilter ? problem.status === statusFilter : true;
            const matchesTag = tagFilter ? problem.tags.includes(tagFilter) : true;
            const matchesSearch = searchQuery ? problem.title.toLowerCase().includes(searchQuery.toLowerCase()) : true;
            return matchesDifficulty && matchesStatus && matchesTag && matchesSearch;
        });

        return (
            <div className="p-8 pt-24 pl-28 lg:pl-28 min-h-screen bg-gray-900 text-gray-100 font-inter">
                <h1 className="text-3xl font-bold text-indigo-400 mb-6">Practice Problems</h1>

                {/* Filters and Search */}
                <div className="bg-gray-800 p-4 rounded-lg shadow-lg mb-6 border border-indigo-700">
                    <div className="flex justify-between items-center mb-4">
                        <h2 className="text-xl font-semibold text-white">Filters</h2>
                        <button
                            onClick={() => setFiltersOpen(!filtersOpen)}
                            className="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-md transition duration-200"
                        >
                            {filtersOpen ? 'Hide Filters' : 'Show Filters'}
                        </button>
                    </div>

                    {filtersOpen && (
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4 animate-fade-in-down">
                            <select
                                value={difficultyFilter}
                                onChange={(e) => setDifficultyFilter(e.target.value)}
                                className="bg-gray-700 text-gray-100 p-2 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                            >
                                <option value="">All Difficulties</option>
                                <option value="Easy">Easy</option>
                                <option value="Medium">Medium</option>
                                <option value="Hard">Hard</option>
                            </select>
                            <select
                                value={statusFilter}
                                onChange={(e) => setStatusFilter(e.target.value)}
                                className="bg-gray-700 text-gray-100 p-2 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                            >
                                <option value="">All Statuses</option>
                                <option value="Not Started">Not Started</option>
                                <option value="Attempted">Attempted</option>
                                <option value="Solved">Solved</option>
                            </select>
                            <select
                                value={tagFilter}
                                onChange={(e) => setTagFilter(e.target.value)}
                                className="bg-gray-700 text-gray-100 p-2 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                            >
                                <option value="">All Tags</option>
                                {allTags.map(tag => <option key={tag} value={tag}>{tag}</option>)}
                            </select>
                        </div>
                    )}
                    <input
                        type="text"
                        placeholder="Search problems by title..."
                        value={searchQuery}
                        onChange={(e) => setSearchQuery(e.target.value)}
                        className="w-full p-2 bg-gray-700 border border-gray-600 rounded-md text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500 mt-4"
                    />
                </div>

                {/* Problems Table */}
                <div className="bg-gray-800 rounded-lg shadow-lg overflow-hidden border border-indigo-700">
                    <table className="min-w-full divide-y divide-gray-700">
                        <thead className="bg-gray-700">
                            <tr>
                                <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">
                                    Title
                                </th>
                                <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">
                                    Difficulty
                                </th>
                                <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">
                                    Status
                                </th>
                                <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">
                                    Tags
                                </th>
                                <th scope="col" className="relative px-6 py-3">
                                    <span className="sr-only">Actions</span>
                                </th>
                            </tr>
                        </thead>
                        <tbody className="bg-gray-800 divide-y divide-gray-700">
                            {filteredProblems.length === 0 ? (
                                <tr>
                                    <td colSpan="5" className="px-6 py-4 whitespace-nowrap text-center text-gray-400">
                                        No problems found matching your filters.
                                    </td>
                                </tr>
                            ) : (
                                filteredProblems.map((problem) => (
                                    <tr key={problem.id} className="hover:bg-gray-700 transition duration-150 ease-in-out">
                                        <td className="px-6 py-4 whitespace-nowrap">
                                            <div className="text-sm font-medium text-white">{problem.title}</div>
                                        </td>
                                        <td className="px-6 py-4 whitespace-nowrap">
                                            <span className={`px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${
                                                problem.difficulty === 'Easy' ? 'bg-green-100 text-green-800' :
                                                problem.difficulty === 'Medium' ? 'bg-yellow-100 text-yellow-800' :
                                                'bg-red-100 text-red-800'
                                            }`}>
                                                {problem.difficulty}
                                            </span>
                                        </td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-300">
                                            {problem.status}
                                        </td>
                                        <td className="px-6 py-4 whitespace-nowrap">
                                            <div className="flex flex-wrap gap-1">
                                                {problem.tags.map(tag => (
                                                    <span key={tag} className="px-2 py-0.5 bg-indigo-600 text-indigo-100 text-xs rounded-full">
                                                        {tag}
                                                    </span>
                                                ))}
                                            </div>
                                        </td>
                                        <td className="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                            <button
                                                onClick={() => navigateTo(`/practice/${problem.id}`)}
                                                className="text-indigo-400 hover:text-indigo-600 transition duration-200"
                                            >
                                                Solve
                                            </button>
                                        </td>
                                    </tr>
                                ))
                            )}
                        </tbody>
                    </table>
            </div>
        </div>
    );
    };

    // Battle Overview Page (Minimal for routing demo)
    const BattleOverviewPage = ({ navigateTo }) => {
        const startQuickBattle = () => {
            const roomId = 'room_' + Math.random().toString(36).substr(2, 9);
            navigateTo(`/battle/room?id=${roomId}`);
        };
        
        return (
            <div className="p-8 pt-24 pl-28 lg:pl-28 min-h-screen bg-gray-900 text-gray-100 font-inter">
                <h1 className="text-3xl font-bold text-indigo-400 mb-6">Battle Arena</h1>
                <div className="grid grid-cols-1 md:grid-cols-3 gap-8">
                    <div className="bg-gray-800 p-6 rounded-lg shadow-lg border border-indigo-700 flex flex-col items-center justify-center text-center">
                        <h2 className="text-2xl font-semibold text-white mb-4">Quick Battle</h2>
                        <p className="text-gray-300 mb-6">Start a battle room instantly! Share the link with friends or test features.</p>
                        <button
                            onClick={startQuickBattle}
                            className="px-8 py-3 bg-green-600 hover:bg-green-700 text-white font-bold rounded-md shadow-lg transition duration-200 focus:outline-none focus:ring-2 focus:ring-green-500"
                        >
                            Start Quick Battle
                        </button>
                    </div>
                    <div className="bg-gray-800 p-6 rounded-lg shadow-lg border border-indigo-700 flex flex-col items-center justify-center text-center">
                        <h2 className="text-2xl font-semibold text-white mb-4">Battle with Friends</h2>
                        <p className="text-gray-300 mb-6">Challenge your friends to a coding duel!</p>
                        <button
                            onClick={() => navigateTo('/battle/friends')}
                            className="px-8 py-3 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-md shadow-lg transition duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
                        >
                            Go to Friend Battles
                        </button>
                    </div>
                    <div className="bg-gray-800 p-6 rounded-lg shadow-lg border border-indigo-700 flex flex-col items-center justify-center text-center">
                        <h2 className="text-2xl font-semibold text-white mb-4">Battle with Random</h2>
                        <p className="text-gray-300 mb-6">Test your skills against a random opponent!</p>
                        <button
                            onClick={() => navigateTo('/battle/random')}
                            className="px-8 py-3 bg-purple-600 hover:bg-purple-700 text-white font-bold rounded-md shadow-lg transition duration-200 focus:outline-none focus:ring-2 focus:ring-purple-500"
                        >
                            Find Random Opponent
                        </button>
                    </div>
                </div>
            </div>
        );
    };

    // Battle Random Page (Minimal for routing demo)
    const BattleRandomPage = ({ navigateTo }) => {
        const [findingOpponent, setFindingOpponent] = useState(true);
        const [countdown, setCountdown] = useState(3); // Matchmaking countdown

        useEffect(() => {
            let findTimer;
            if (findingOpponent) {
                findTimer = setTimeout(() => {
                    setFindingOpponent(false); // Simulate finding an opponent
                    setCountdown(3); // Start countdown for battle
                }, 3000); // Simulate 3 seconds to find opponent
            }
            return () => clearTimeout(findTimer);
        }, [findingOpponent]);

        useEffect(() => {
            let battleCountdown;
            if (!findingOpponent && countdown > 0) {
                battleCountdown = setInterval(() => {
                    setCountdown(prev => prev - 1);
                }, 1000);
            } else if (!findingOpponent && countdown === 0) {
                // Generate a unique room ID and navigate to battle room
                const roomId = 'room_' + Math.random().toString(36).substr(2, 9);
                navigateTo(`/battle/room?id=${roomId}`); // Navigate to battle room with room ID
            }
            return () => clearInterval(battleCountdown);
        }, [findingOpponent, countdown, navigateTo]);

        return (
            <div className="p-8 pt-24 pl-28 lg:pl-28 min-h-screen bg-gray-900 text-gray-100 font-inter flex flex-col items-center justify-center">
                <h1 className="text-3xl font-bold text-indigo-400 mb-8">Battle with Random Opponent</h1>
                {findingOpponent ? (
                    <div className="text-center">
                        <svg className="animate-spin h-10 w-10 text-blue-500 mx-auto mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                            <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <p className="text-xl text-gray-300">Finding Opponent...</p>
                    </div>
                ) : (
                    <div className="text-center">
                        <h2 className="text-2xl font-semibold text-green-400 mb-4">Opponent Found!</h2>
                        <p className="text-xl text-white mb-6">Starting battle in <span className="font-bold text-indigo-400">{countdown}</span>...</p>
                        <div className="bg-gray-800 p-6 rounded-lg shadow-lg border border-indigo-700 inline-block">
                            <p className="text-lg text-gray-300">You are matched with: <span className="font-bold text-blue-400">ProCoder77</span></p>
                        </div>
                    </div>
                )}
            </div>
        );
    };

    // Battle Friends Page (Minimal for routing demo)
    const BattleFriendsPage = ({ navigateTo }) => {
        const [friends, setFriends] = useState([
            { id: 1, name: 'ProCoder77', online: true, invited: false },
            { id: 2, name: 'AlgoMaster', online: true, invited: false },
            { id: 3, name: 'DebugDiva', online: false, invited: false },
            { id: 4, name: 'CodeNinja', online: true, invited: false },
        ]);
        const [difficulty, setDifficulty] = useState('Medium');
        const [timeLimit, setTimeLimit] = useState('10');
        const [searchFriend, setSearchFriend] = useState('');
        const [friendRequests, setFriendRequests] = useState([
            { id: 5, name: 'FriendRequestGuy' }
        ]);
        const [discoverUsers, setDiscoverUsers] = useState([
            { id: 6, name: 'NewCoder', isFriend: false },
            { id: 7, name: 'LearnFast', isFriend: false },
        ]);
        const [activeTab, setActiveTab] = useState('My Friends');

        const invitedFriends = friends.filter(f => f.invited);
        const canStartBattle = true; // Allow starting battle even without friends for testing

        const toggleInvite = (id) => {
            setFriends(friends.map(f => f.id === id ? { ...f, invited: !f.invited } : f));
        };

        const handleAddFriend = (id) => {
            console.log(`Sending friend request to user ${id}`);
            // Simulate removing from discover and showing toast
            setDiscoverUsers(discoverUsers.filter(u => u.id !== id));
            // In a real app, this would be an API call and a toast notification
            alert('Friend request sent!'); // Using alert for demo, replace with custom modal
        };

        const handleAcceptRequest = (id) => {
            console.log(`Accepted friend request from ${id}`);
            setFriendRequests(friendRequests.filter(req => req.id !== id));
            alert('Friend request accepted!');
        };

        const handleDeclineRequest = (id) => {
            console.log(`Declined friend request from ${id}`);
            setFriendRequests(friendRequests.filter(req => req.id !== id));
            alert('Friend request declined!');
        };


        const handleStartBattle = () => {
            console.log("Starting battle with invited friends:", invitedFriends.map(f => f.name));
            const roomId = 'room_' + Math.random().toString(36).substr(2, 9);
            navigateTo(`/battle/room?id=${roomId}`);
        };

        // Check for query parameter for friend requests tab
        useEffect(() => {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('tab') === 'requests') {
                setActiveTab('Requests');
            }
        }, []);

        return (
            <div className="p-8 pt-24 pl-28 lg:pl-28 min-h-screen bg-gray-900 text-gray-100 font-inter">
                <h1 className="text-3xl font-bold text-indigo-400 mb-6">Battle with Friends</h1>

                <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    {/* Friends List */}
                    <div className="lg:col-span-1 bg-gray-800 p-6 rounded-lg shadow-lg border border-indigo-700">
                        <h2 className="text-xl font-semibold text-white mb-4">Your Friends</h2>
                        <input
                            type="text"
                            placeholder="Search friends..."
                            value={searchFriend}
                            onChange={(e) => setSearchFriend(e.target.value)}
                            className="w-full p-2 bg-gray-700 border border-gray-600 rounded-md text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500 mb-4"
                        />
                        <div className="space-y-3 max-h-60 overflow-y-auto custom-scrollbar">
                            {friends.filter(f => f.name.toLowerCase().includes(searchFriend.toLowerCase())).map(friend => (
                                <div key={friend.id} className={`flex items-center justify-between p-3 rounded-md ${friend.online ? 'bg-gray-700' : 'bg-gray-700 opacity-70'} ${friend.invited ? 'border-l-4 border-green-500' : ''}`}>
                                    <div className="flex items-center">
                                        <span className={`block w-3 h-3 rounded-full mr-2 ${friend.online ? 'bg-green-500' : 'bg-gray-500'}`}></span>
                                        <span className="font-medium text-white">{friend.name}</span>
                                    </div>
                                    <button
                                        onClick={() => toggleInvite(friend.id)}
                                        disabled={!friend.online}
                                        className={`px-3 py-1 text-sm rounded-md ${friend.online ? (friend.invited ? 'bg-red-600 hover:bg-red-700' : 'bg-blue-600 hover:bg-blue-700') : 'bg-gray-500 cursor-not-allowed'} text-white transition duration-200`}
                                    >
                                        {friend.online ? (friend.invited ? 'Uninvite' : 'Invite') : 'Offline'}
                                    </button>
                                </div>
                            ))}
                        </div>
                    </div>

                    {/* Room Details & Start Battle */}
                    <div className="lg:col-span-2 bg-gray-800 p-6 rounded-lg shadow-lg border border-indigo-700 flex flex-col">
                        <h2 className="text-xl font-semibold text-white mb-4">Battle Room Details</h2>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                            <div>
                                <label htmlFor="difficulty" className="block text-gray-300 text-sm font-medium mb-1">Difficulty</label>
                                <select
                                    id="difficulty"
                                    value={difficulty}
                                    onChange={(e) => setDifficulty(e.target.value)}
                                    className="w-full p-2 bg-gray-700 text-gray-100 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                >
                                    <option value="Easy">Easy</option>
                                    <option value="Medium">Medium</option>
                                    <option value="Hard">Hard</option>
                                </select>
                            </div>
                            <div>
                                <label htmlFor="timeLimit" className="block text-gray-300 text-sm font-medium mb-1">Time Limit (mins)</label>
                                <select
                                    id="timeLimit"
                                    value={timeLimit}
                                    onChange={(e) => setTimeLimit(e.target.value)}
                                    className="w-full p-2 bg-gray-700 text-gray-100 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                >
                                    <option value="5">5 minutes</option>
                                    <option value="10">10 minutes</option>
                                    <option value="15">15 minutes</option>
                                </select>
                            </div>
                        </div>

                        <h3 className="text-lg font-semibold text-white mb-3">Invited Players ({invitedFriends.length})</h3>
                        <div className="bg-gray-700 p-4 rounded-md flex-grow overflow-y-auto custom-scrollbar mb-6">
                            {invitedFriends.length === 0 ? (
                                <p className="text-gray-400">Invite friends from the list to start a battle.</p>
                            ) : (
                                invitedFriends.map(friend => (
                                    <div key={friend.id} className="flex items-center justify-between p-2 mb-2 bg-gray-600 rounded-md">
                                        <span className="font-medium text-white">{friend.name}</span>
                                        <button onClick={() => toggleInvite(friend.id)} className="text-red-400 hover:text-red-300 text-sm" aria-label={`Remove invite for ${friend.name}`}>
                                            Remove
                                        </button>
                                    </div>
                                ))
                            )}
                        </div>

                        <button
                            onClick={handleStartBattle}
                            disabled={!canStartBattle}
                            className={`w-full px-8 py-3 font-bold rounded-md shadow-lg transition duration-200 focus:outline-none focus:ring-2 ${canStartBattle ? 'bg-green-600 hover:bg-green-700 focus:ring-green-500' : 'bg-gray-600 cursor-not-allowed'} text-white`}
                        >
                            {invitedFriends.length > 0 ? `Start Battle (${invitedFriends.length} friends)` : 'Start Solo Battle (Test Mode)'}
                        </button>
                    </div>
                </div>
                 {/* Find More Friends & Friend Requests tabs */}
                 <div className="mt-8">
                    <div className="flex border-b border-gray-700 mb-4">
                        {['My Friends', 'Requests', 'Discover'].map(tab => (
                            <button
                                key={tab}
                                onClick={() => setActiveTab(tab)}
                                className={`px-4 py-2 -mb-px border-b-2 ${activeTab === tab ? 'border-indigo-500 text-indigo-400' : 'border-transparent text-gray-400 hover:text-white'} transition duration-200`}
                            >
                                {tab}
                            </button>
                        ))}
                    </div>

                    {activeTab === 'Requests' && (
                        <div className="bg-gray-800 p-6 rounded-lg shadow-lg border border-indigo-700">
                            <h3 className="text-xl font-semibold text-white mb-4">Friend Requests</h3>
                            {friendRequests.length === 0 ? (
                                <p className="text-gray-400">No pending friend requests.</p>
                            ) : (
                                <div className="space-y-3">
                                    {friendRequests.map(req => (
                                        <div key={req.id} className="flex items-center justify-between p-3 bg-gray-700 rounded-md">
                                            <span className="font-medium text-white">{req.name}</span>
                                            <div className="flex gap-2">
                                                <button onClick={() => handleAcceptRequest(req.id)} className="px-3 py-1 bg-green-600 hover:bg-green-700 text-white text-sm rounded-md">Accept</button>
                                                <button onClick={() => handleDeclineRequest(req.id)} className="px-3 py-1 bg-red-600 hover:bg-red-700 text-white text-sm rounded-md">Decline</button>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    )}

                    {activeTab === 'Discover' && (
                         <div className="bg-gray-800 p-6 rounded-lg shadow-lg border border-indigo-700">
                            <h3 className="text-xl font-semibold text-white mb-4">Discover New Coders</h3>
                            <input
                                type="text"
                                placeholder="Search users to add..."
                                className="w-full p-2 bg-gray-700 border border-gray-600 rounded-md text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500 mb-4"
                            />
                            <div className="space-y-3">
                                {discoverUsers.length === 0 ? (
                                    <p className="text-gray-400">No users to discover right now.</p>
                                ) : (
                                    discoverUsers.map(user => (
                                        <div key={user.id} className="flex items-center justify-between p-3 bg-gray-700 rounded-md">
                                            <span className="font-medium text-white">{user.name}</span>
                                            <button onClick={() => handleAddFriend(user.id)} className="px-3 py-1 bg-blue-600 hover:bg-blue-700 text-white text-sm rounded-md">Add Friend</button>
                                        </div>
                                    ))
                                )}
                            </div>
                        </div>
                    )}
                    {/* The 'My Friends' tab functionality is partially covered by the friend list above */}
                </div>
            </div>
        );
    };

    // Shared problems data for Practice and Battle
    const PROBLEMS_DATA = {
        1: {
            title: "Two Sum",
            description: "Given an array of integers nums and an integer target, return indices of the two numbers such that they add up to target. You may assume that each input has exactly one solution, and you may not use the same element twice.",
            examples: [
                "Input: nums = [2,7,11,15], target = 9 \nOutput: [0,1]",
                "Input: nums = [3,2,4], target = 6 \nOutput: [1,2]"
            ],
            difficulty: "Easy",
            category: "Arrays",
            starterCode: {
                javascript: `function twoSum(nums, target) {\n  // Write your JavaScript code here\n}`,
                python: `def two_sum(nums, target):\n    # Write your Python code here`,
                java: `public int[] twoSum(int[] nums, int target) {\n    // Write your Java code here\n    return new int[0];\n}`,
                cpp: `vector<int> twoSum(vector<int>& nums, int target) {\n    // Write your C++ code here\n    return {};\n}`,
            },
            testCases: [
                { input: [2, 7, 11, 15], target: 9, expected: [0, 1] },
                { input: [3, 2, 4], target: 6, expected: [1, 2] },
                { input: [3, 3], target: 6, expected: [0, 1] },
                { input: [5, 5, 1, 1], target: 10, expected: [0, 1] },
            ],
        },
        2: {
            title: "Add Two Numbers",
            description: "You are given two non-empty linked lists representing two non-negative integers. The digits are stored in reverse order, and each of their nodes contains a single digit. Add the two numbers and return the sum as a linked list.",
            examples: [
                "Input: l1 = [2,4,3], l2 = [5,6,4] \nOutput: [7,0,8] \nExplanation: 342 + 465 = 807.",
                "Input: l1 = [0], l2 = [0] \nOutput: [0]"
            ],
            difficulty: "Medium",
            category: "Linked List",
            starterCode: {
                javascript: `function addTwoNumbers(l1, l2) {\n  // Write your JavaScript code here\n}`,
                python: `def add_two_numbers(l1, l2):\n    # Write your Python code here`,
                java: `public int[] addTwoNumbers(int[] l1, int[] l2) {\n    // Write your Java code here\n    return new int[0];\n}`,
                cpp: `vector<int> addTwoNumbers(vector<int>& l1, vector<int>& l2) {\n    // Write your C++ code here\n    return {};\n}`,
            },
            testCases: [
                { input: { l1: [2,4,3], l2: [5,6,4] }, expected: [7,0,8] },
                { input: { l1: [0], l2: [0] }, expected: [0] },
                { input: { l1: [9,9,9,9,9,9,9], l2: [9,9,9,9] }, expected: [8,9,9,9,0,0,0,1] },
            ],
        },
        3: {
            title: "Longest Substring Without Repeating Characters",
            description: "Given a string s, find the length of the longest substring without repeating characters.",
            examples: [
                "Input: s = \"abcabcbb\"\nOutput: 3",
                "Input: s = \"bbbbb\"\nOutput: 1"
            ],
            difficulty: "Medium",
            category: "Strings",
            starterCode: {
                javascript: `function lengthOfLongestSubstring(s) {\n  // Write your JavaScript code here\n}`,
                python: `def length_of_longest_substring(s):\n    # Write your Python code here`,
                java: `public int lengthOfLongestSubstring(String s) {\n    // Write your Java code here\n    return 0;\n}`,
                cpp: `int lengthOfLongestSubstring(string s) {\n    // Write your C++ code here\n    return 0;\n}`,
            },
            testCases: [
                { input: "abcabcbb", expected: 3 },
                { input: "bbbbb", expected: 1 },
                { input: "pwwkew", expected: 3 },
                { input: "", expected: 0 },
            ],
        },
        4: {
            title: "Median of Two Sorted Arrays",
            description: "Given two sorted arrays nums1 and nums2 of size m and n respectively, return the median of the two sorted arrays.",
            examples: [
                "Input: nums1 = [1,3], nums2 = [2] \nOutput: 2.0",
                "Input: nums1 = [1,2], nums2 = [3,4] \nOutput: 2.5"
            ],
            difficulty: "Hard",
            category: "Arrays",
            starterCode: {
                javascript: `function findMedianSortedArrays(nums1, nums2) {\n  // Write your JavaScript code here\n}`,
                python: `def find_median_sorted_arrays(nums1, nums2):\n    # Write your Python code here`,
                java: `public double findMedianSortedArrays(int[] nums1, int[] nums2) {\n    // Write your Java code here\n    return 0.0;\n}`,
                cpp: `double findMedianSortedArrays(vector<int>& nums1, vector<int>& nums2) {\n    // Write your C++ code here\n    return 0.0;\n}`,
            },
            testCases: [
                { input: { nums1: [1,3], nums2: [2] }, expected: 2.0 },
                { input: { nums1: [1,2], nums2: [3,4] }, expected: 2.5 },
                { input: { nums1: [0,0], nums2: [0,0] }, expected: 0.0 },
            ],
        },
        5: {
            title: "Reverse Linked List",
            description: "Given the head of a singly linked list, reverse the list, and return the reversed list.",
            examples: [
                "Input: head = [1,2,3,4,5] \nOutput: [5,4,3,2,1]",
                "Input: head = [1,2] \nOutput: [2,1]"
            ],
            difficulty: "Easy",
            category: "Linked List",
            starterCode: {
                javascript: `function reverseList(head) {\n  // Write your JavaScript code here\n}`,
                python: `def reverse_list(head):\n    # Write your Python code here`,
                java: `public int[] reverseList(int[] head) {\n    // Write your Java code here\n    return new int[0];\n}`,
                cpp: `vector<int> reverseList(vector<int>& head) {\n    // Write your C++ code here\n    return {};\n}`,
            },
            testCases: [
                { input: [1,2,3,4,5], expected: [5,4,3,2,1] },
                { input: [1,2], expected: [2,1] },
                { input: [], expected: [] },
            ],
        }
    };

    // Integrated Notes Page
    const NotesPage = ({ navigateTo }) => {
        const [allNotes, setAllNotes] = useState(() => {
            try { const raw = localStorage.getItem('codera-notes'); return raw ? JSON.parse(raw) : []; } catch(e) { return []; }
        });
        const [query, setQuery] = useState('');
        const [mode, setMode] = useState(''); // '', 'practice', 'battle'

        // Keep in sync if other pages modify notes
        useEffect(() => {
            const onStorage = () => {
                try { const raw = localStorage.getItem('codera-notes'); setAllNotes(raw ? JSON.parse(raw) : []); } catch(e) {}
            };
            window.addEventListener('storage', onStorage);
            return () => window.removeEventListener('storage', onStorage);
        }, []);

        const filtered = useMemo(() => {
            return allNotes.filter(n => {
                const matchesMode = mode ? (n.context?.mode === mode) : true;
                const matchesQuery = query ? ((n.title||'').toLowerCase().includes(query.toLowerCase()) || (n.snippet||'').toLowerCase().includes(query.toLowerCase())) : true;
                return matchesMode && matchesQuery;
            });
        }, [allNotes, mode, query]);

        const handleCopy = async (note) => { try { await navigator.clipboard.writeText(note.snippet); } catch(e) {} };
        const handleDelete = (id) => {
            const next = allNotes.filter(n => n.id !== id);
            setAllNotes(next);
            try { localStorage.setItem('codera-notes', JSON.stringify(next)); } catch(e) {}
        };
        const openContext = (note) => {
            const ctx = note.context || {};
            if (ctx.mode === 'practice' && ctx.problemId) {
                navigateTo(`/practice/${ctx.problemId}`);
            } else if (ctx.mode === 'battle') {
                if (ctx.roomId) navigateTo(`/battle/room?id=${ctx.roomId}`);
                else navigateTo('/battle');
            }
        };

        return (
            <div className="p-8 pt-24 pl-28 lg:pl-28 min-h-screen bg-gray-900 text-gray-100 font-inter">
                <h1 className="text-3xl font-bold text-indigo-400 mb-6">Integrated Notes</h1>
                <div className="bg-gray-800 p-4 rounded-lg shadow-lg border border-indigo-700 mb-4 flex flex-col md:flex-row gap-3 md:items-center">
                    <input
                        value={query}
                        onChange={(e) => setQuery(e.target.value)}
                        placeholder="Search notes..."
                        className="flex-1 bg-gray-700 text-gray-100 p-2 rounded-md border border-gray-600"
                    />
                    <select value={mode} onChange={(e) => setMode(e.target.value)} className="bg-gray-700 text-gray-100 p-2 rounded-md border border-gray-600">
                        <option value="">All</option>
                        <option value="practice">Practice</option>
                        <option value="battle">Battle</option>
                    </select>
                    <span className="text-sm text-gray-300">{filtered.length} notes</span>
                </div>

                {filtered.length === 0 ? (
                    <p className="text-gray-400">No notes found.</p>
                ) : (
                    <ul className="space-y-3">
                        {filtered.map(note => (
                            <li key={note.id} className="bg-gray-800 p-4 rounded-lg border border-gray-700">
                                <div className="flex justify-between items-start">
                                    <div>
                                        <div className="text-white font-semibold text-sm">{note.title || 'Snippet'}</div>
                                        <div className="text-xs text-gray-400 mt-0.5">{new Date(note.createdAt).toLocaleString()} ‚Ä¢ {note.language} ‚Ä¢ {(note.context?.mode||'').toUpperCase()}</div>
                                    </div>
                                    <div className="flex gap-2">
                                        <button onClick={() => openContext(note)} className="px-3 py-1 text-xs bg-indigo-600 hover:bg-indigo-700 rounded">Open</button>
                                        <button onClick={() => handleCopy(note)} className="px-3 py-1 text-xs bg-teal-600 hover:bg-teal-700 rounded">Copy</button>
                                        <button onClick={() => handleDelete(note.id)} className="px-3 py-1 text-xs bg-red-600 hover:bg-red-700 rounded">Delete</button>
                                    </div>
                                </div>
                                <pre className="mt-2 text-sm whitespace-pre-wrap text-gray-200 overflow-auto max-h-48">{note.snippet}</pre>
                            </li>
                        ))}
                    </ul>
                )}
            </div>
        );
    };

    // Battle Room Page - (using the previous codera_battle_ui content, adapted for routing)
    const BattleRoomPage = ({ navigateTo, userId, db }) => {
        const [battleProblemId, setBattleProblemId] = useState(1);
        const problem = PROBLEMS_DATA[battleProblemId] || PROBLEMS_DATA[1];
        const [selectedLanguage, setSelectedLanguage] = useState('javascript');
        const [player1Code, setPlayer1Code] = useState('');
        const [player2Code, setPlayer2Code] = useState(`function twoSum(nums, target) {\n  // Your opponent's code (synced)\n}`);
        const [player1Output, setPlayer1Output] = useState("");
        const [player2Output, setPlayer2Output] = useState("");
        const [timer, setTimer] = useState(600); // remaining seconds
        // Initialize chat messages with persistence
        const [chatMessages, setChatMessages] = useState(() => {
            try {
                const saved = localStorage.getItem(`battle-chat-${roomId}`);
                return saved ? JSON.parse(saved) : [];
            } catch (e) {
                console.warn('‚ö†Ô∏è Could not load saved chat messages:', e);
                return [];
            }
        });
        const [newChatMessage, setNewChatMessage] = useState('');
        const [battleStatus, setBattleStatus] = useState("Waiting"); // "Waiting", "In Progress", "Ended"
        const [activeBattleTab, setActiveBattleTab] = useState('Description'); // For Battle Room tabs
        const [player1Progress, setPlayer1Progress] = useState(0); // For progress bars
        const [player2Progress, setPlayer2Progress] = useState(0);
        const [winner, setWinner] = useState(null); // 'player1', 'player2', 'draw'
        const [editor, setEditor] = useState(null);
        const [loading, setLoading] = useState(false);

        // Integrated Notes (battle)
        const [showNotes, setShowNotes] = useState(false);
        const [notes, setNotes] = useState(() => {
            try {
                const raw = localStorage.getItem('codera-notes');
                return raw ? JSON.parse(raw) : [];
            } catch (e) { return []; }
        });
        const saveAllNotes = (next) => {
            setNotes(next);
            try { localStorage.setItem('codera-notes', JSON.stringify(next)); } catch(e) {}
        };
        const battleContextKey = useMemo(() => `battle:${battleProblemId}`, [battleProblemId]);
        const battleNotes = useMemo(() => notes.filter(n => n.context?.key === battleContextKey), [notes, battleContextKey]);
        const [hasSelection, setHasSelection] = useState(false);
        const handleSaveSelectionToNotes = () => {
            if (!editor) return alert('Editor not ready');
            const sel = (editor.getSelection && editor.getSelection()) || '';
            const snippet = (sel || '').trim();
            if (!snippet) return alert('Please select some code in the editor first.');
            const defaultTitle = snippet.split('\n')[0].slice(0, 60) || 'Snippet';
            let custom = '';
            try { custom = window.prompt('Enter a title for this note:', defaultTitle) ?? ''; } catch (e) { custom = defaultTitle; }
            if (custom === null) return; // cancelled
            const title = (custom.trim() || defaultTitle);
            const note = {
                id: `note_${Date.now()}_${Math.random().toString(36).slice(2,8)}`,
                title,
                snippet,
                language: selectedLanguage,
                createdAt: new Date().toISOString(),
                context: { mode: 'battle', key: battleContextKey, battleProblemId, roomId }
            };
            saveAllNotes([note, ...notes]);
            setShowNotes(true);
        };
        const handleInsertNoteAtCursor = (note) => { if (editor?.replaceSelection) editor.replaceSelection(note.snippet); };
        const handleCopyNote = async (note) => { try { await navigator.clipboard.writeText(note.snippet); } catch(e) {} };
        const handleDeleteNote = (id) => { const next = notes.filter(n => n.id !== id); saveAllNotes(next); };
        const [roomId, setRoomId] = useState(null);
        const [participants, setParticipants] = useState({});
        const [isCreator, setIsCreator] = useState(false);
        const [durationSeconds, setDurationSeconds] = useState(600);
        const startedAtRef = useRef(null);

        // WebRTC Voice Chat & Code Sharing State
        const [isVoiceChatEnabled, setIsVoiceChatEnabled] = useState(false);
        const [isMuted, setIsMuted] = useState(false);
        const [isCodeSharing, setIsCodeSharing] = useState(false);
        const [friendCode, setFriendCode] = useState('');
        const [localAudioStream, setLocalAudioStream] = useState(null);
        const [isViewingFriendCode, setIsViewingFriendCode] = useState(false);
        const [voicePeerConnection, setVoicePeerConnection] = useState(null);
        const [screenPeerConnection, setScreenPeerConnection] = useState(null);
        const [isConnecting, setIsConnecting] = useState(false);
        
        // Refs for WebRTC - separate connections for voice and screen
        const localAudioRef = useRef(null);
        const remoteAudioRef = useRef(null);
        const remoteScreenRef = useRef(null);
        const voicePeerConnectionRef = useRef(null);
        const screenPeerConnectionRef = useRef(null);

        // Ref for chat scroll
        const chatEndRef = useRef(null);
        const isHost = isCreator; // creator is host

        // Helper: stable player id
        const myIdRef = useRef(null);
        if (!myIdRef.current) {
            try {
                const saved = localStorage.getItem('anon_id');
                if (saved) myIdRef.current = saved;
                else {
                    const gen = `anon_${Math.random().toString(36).slice(2, 10)}`;
                    localStorage.setItem('anon_id', gen);
                    myIdRef.current = gen;
                }
            } catch (e) {
                myIdRef.current = `anon_${Math.random().toString(36).slice(2, 10)}`;
            }
        }
        const myId = userId || myIdRef.current;

        // Display Firebase connection status in console
        useEffect(() => {
            if (db) {
                console.log('‚úÖ Firebase database available in BattleRoomPage');
            } else {
                console.log('‚ÑπÔ∏è Firebase database not available, using local mode');
            }
        }, [db]);

        // Firestore room setup
        useEffect(() => {
            let unsubscribeRoom = null;
            let intervalId = null;
            try {
                // Check if Firebase and db are available
                if (!window.firebase || !db) {
                    console.warn('Firebase Firestore not available; running local-only demo.');
                    
                    // Local demo mode - create or join room using URL parameter
                    const url = new URL(window.location.href);
                    let rid = url.searchParams.get('id');
                    
                    if (!rid) {
                        // Create new room ID for local testing
                        rid = 'local_' + Math.random().toString(36).substr(2, 9);
                        setIsCreator(true);
                        
                        // Handle URL update for both file:// and http:// protocols
                        try {
                            const currentUrl = window.location.href;
                            let newUrl;
                            
                            if (currentUrl.includes('?')) {
                                newUrl = currentUrl + '&id=' + rid;
                            } else {
                                newUrl = currentUrl + '?id=' + rid;
                            }
                            
                            // Update URL in address bar
                            window.history.replaceState({}, '', newUrl);
                            console.log('Created room with ID:', rid);
                            console.log('Room URL:', newUrl);
                        } catch (e) {
                            console.log('Could not update URL, using room ID:', rid);
                        }
                    } else {
                        setIsCreator(false);
                        console.log('Joining existing room:', rid);
                    }
                    
                    setRoomId(rid);
                    setBattleStatus('In Progress');
                    
                    // Simulate having participants for local testing
                    const localParticipants = {};
                    localParticipants[myId] = { online: true };
                    if (!isCreator) {
                        localParticipants['opponent_demo'] = { online: true };
                    }
                    setParticipants(localParticipants);
                    
                    return;
                }
                // Extract room ID from URL - handle both query params and hash params
                const url = new URL(window.location.href);
                let rid = url.searchParams.get('id');
                
                // Also check hash-based parameters
                if (!rid && window.location.hash.includes('?')) {
                    const hashParams = new URLSearchParams(window.location.hash.split('?')[1]);
                    rid = hashParams.get('id');
                }
                
                console.log('üîç Room ID extraction:');
                console.log('Full URL:', window.location.href);
                console.log('Hash:', window.location.hash);
                console.log('Extracted room ID:', rid);

                const createRoom = async () => {
                    const ref = db.collection('battleRooms').doc();
                    const initial = {
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        startedAt: null,
                        durationSeconds: 600,
                        participants: { [myId]: { online: true, updatedAt: firebase.firestore.FieldValue.serverTimestamp() } },
                        code: { [myId]: player1Code },
                        problemId: 1,
                        status: 'waiting', // waiting, active, completed
                        createdBy: myId
                    };
                    await ref.set(initial, { merge: true });
                    console.log('‚úÖ Battle room created:', ref.id);
                    console.log('üë• Created by user:', myId);
                    return ref.id;
                };

                const ensureRoom = async () => {
                    if (!rid) {
                        // choose random problem from PROBLEMS_DATA
                        const keys = Object.keys(PROBLEMS_DATA).map(Number);
                        const randomId = keys[Math.floor(Math.random() * keys.length)];
                        rid = await createRoom();
                        setBattleProblemId(randomId);
                        setIsCreator(true);
                        const newUrl = new URL(window.location.href);
                        newUrl.searchParams.set('id', rid);
                        if (window.location.protocol !== 'blob:') {
                            window.history.replaceState({}, '', newUrl.toString());
                        }
                        // store chosen problem
                        await db.collection('battleRooms').doc(rid).set({ problemId: randomId }, { merge: true });
                    } else {
                        setIsCreator(false);
                        // Join existing room and mark presence
                        await db.collection('battleRooms').doc(rid).set({
                            participants: { [myId]: { online: true, updatedAt: firebase.firestore.FieldValue.serverTimestamp() } },
                        }, { merge: true });
                        console.log('‚úÖ Joined existing battle room:', rid);
                        console.log('üë• Joining as user:', myId);
                    }

                    setRoomId(rid);

                    // Listen to room updates
                    unsubscribeRoom = db.collection('battleRooms').doc(rid).onSnapshot((snap) => {
                        if (!snap.exists) return;
                        const data = snap.data() || {};
                        setParticipants(data.participants || {});
                        setDurationSeconds(data.durationSeconds || 600);
                        if (data.problemId) setBattleProblemId(data.problemId);
                        const codeMap = data.code || {};
                        const opponentId = Object.keys(codeMap).find(k => k !== myId);
                        if (opponentId) {
                            setPlayer2Code(codeMap[opponentId] || '');
                        }
                        // Timer handling based on startedAt
                        const startedAt = data.startedAt ? data.startedAt.toDate ? data.startedAt.toDate() : new Date(data.startedAt) : null;
                        if (startedAt) {
                            startedAtRef.current = startedAt;
                            setBattleStatus('In Progress');
                            const tick = () => {
                                const now = new Date();
                                const elapsed = Math.floor((now - startedAtRef.current) / 1000);
                                const remaining = Math.max(0, (data.durationSeconds || 600) - elapsed);
                                setTimer(remaining);
                                if (remaining === 0) {
                                    setBattleStatus('Ended');
                                    clearInterval(intervalId);
                                }
                            };
                            clearInterval(intervalId);
                            intervalId = setInterval(tick, 1000);
                            tick();
                        } else {
                            // If two players present and no startedAt, let creator start
                            const presentCount = Object.values(data.participants || {}).filter(p => p && p.online).length;
                            setBattleStatus(presentCount >= 2 ? 'In Progress' : 'Waiting');
                            if (presentCount >= 2 && isCreator) {
                                db.collection('battleRooms').doc(rid).set({ 
                                    startedAt: firebase.firestore.FieldValue.serverTimestamp(),
                                    status: 'active'
                                }, { merge: true });
                            }
                        }
                    });

                    // Mark offline on unload
                    const handleUnload = () => {
                        db.collection('battleRooms').doc(rid).set({
                            participants: { [myId]: { online: false, updatedAt: firebase.firestore.FieldValue.serverTimestamp() } },
                        }, { merge: true });
                    };
                    window.addEventListener('beforeunload', handleUnload);

                    return () => {
                        window.removeEventListener('beforeunload', handleUnload);
                    };
                };

                ensureRoom();
            } catch (e) {
                console.error('Room initialization error:', e);
            }
            return () => {
                if (unsubscribeRoom) unsubscribeRoom();
                if (intervalId) clearInterval(intervalId);
            };
        // eslint-disable-next-line react-hooks/exhaustive-deps
        }, [db]);

        // Sync my code to Firestore
        useEffect(() => {
            try {
                if (!roomId || !db) return;
                // Debounce code updates to avoid excessive Firestore writes
                const timeoutId = setTimeout(() => {
                    db.collection('battleRooms').doc(roomId).set({ 
                        code: { [myId]: player1Code },
                        lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                    }, { merge: true });
                }, 500); // 500ms debounce
                
                return () => clearTimeout(timeoutId);
            } catch (e) {
                console.error('Error syncing code:', e);
            }
        }, [player1Code, roomId, myId, db]);


        // End battle when timer hits 0
        useEffect(() => {
            if (timer === 0 && battleStatus === 'In Progress') {
                setBattleStatus('Ended');
                setPlayer1Output("Time's up! Battle ended.");
                setPlayer2Output("Time's up! Battle ended.");
                setWinner('draw');
            }
        }, [timer, battleStatus]);

        // Scroll chat to bottom on new message
        useEffect(() => {
            chatEndRef.current?.scrollIntoView({ behavior: "smooth" });
        }, [chatMessages]);
        
        // Code Sharing Listener - Listen for friend's code updates
        useEffect(() => {
            if (!roomId) return;
            
            let unsubscribeCodeShare = null;
            
            if (db && window.firebase) {
                // Firebase listener for code sharing
                unsubscribeCodeShare = db.collection('battleRooms').doc(roomId)
                    .onSnapshot((doc) => {
                        if (!doc.exists) return;
                        const data = doc.data();
                        
                        // Handle code sharing updates from friend
                        if (data.codeShare && data.codeShare.from !== myId) {
                            if (data.codeShare.active && data.codeShare.sharedCode) {
                                console.log('üíª Received friend\'s code update:', data.codeShare.from);
                                setFriendCode(data.codeShare.sharedCode);
                                setIsViewingFriendCode(true);
                            } else if (!data.codeShare.active || !data.codeShare.sharedCode) {
                                console.log('‚ùå Friend stopped sharing code');
                                setIsViewingFriendCode(false);
                                setFriendCode('');
                            }
                        } else if (!data.codeShare && isViewingFriendCode) {
                            // Handle case where codeShare field is completely removed
                            console.log('‚ùå Code sharing data removed from Firebase');
                            setIsViewingFriendCode(false);
                            setFriendCode('');
                        }
                    }, (error) => {
                        console.error('‚ùå Code sharing listener error:', error);
                    });
            } else {
                // localStorage fallback for local testing
                const checkForCodeUpdates = () => {
                    try {
                        const codeDataStr = localStorage.getItem('code-share-' + roomId);
                        
                        // If no data exists, or data was removed, close the friend's code view
                        if (!codeDataStr) {
                            if (isViewingFriendCode) {
                                console.log('‚ùå Code sharing data removed (local)');
                                setIsViewingFriendCode(false);
                                setFriendCode('');
                            }
                            return;
                        }
                        
                        const codeData = JSON.parse(codeDataStr);
                        
                        // Check if friend is sharing code
                        if (codeData.from !== myId && codeData.active && codeData.sharedCode) {
                            console.log('üíª Received friend\'s code update (local):', codeData.from);
                            setFriendCode(codeData.sharedCode);
                            setIsViewingFriendCode(true);
                        } else if (codeData.from !== myId && (!codeData.active || !codeData.sharedCode)) {
                            console.log('‚ùå Friend stopped sharing code (local)');
                            setIsViewingFriendCode(false);
                            setFriendCode('');
                        }
                    } catch (e) {
                        // If parsing fails, also close the view
                        if (isViewingFriendCode) {
                            console.log('‚ùå Error parsing code data, closing view (local)');
                            setIsViewingFriendCode(false);
                            setFriendCode('');
                        }
                    }
                };
                
                // Check every 2 seconds for code updates
                const interval = setInterval(checkForCodeUpdates, 2000);
                
                return () => clearInterval(interval);
            }
            
            return () => {
                if (unsubscribeCodeShare) unsubscribeCodeShare();
            };
        }, [roomId, myId, db]);
        
        // Sync my code when sharing is enabled
        useEffect(() => {
            if (isCodeSharing && roomId) {
                const syncMyCode = async () => {
                    if (db && window.firebase) {
                        await db.collection('battleRooms').doc(roomId).set({
                            codeShare: {
                                active: true,
                                from: myId,
                                sharedCode: player1Code,
                                language: selectedLanguage,
                                timestamp: firebase.firestore.FieldValue.serverTimestamp()
                            }
                        }, { merge: true });
                    } else {
                        // Update localStorage
                        const codeData = {
                            active: true,
                            from: myId,
                            sharedCode: player1Code,
                            language: selectedLanguage,
                            timestamp: Date.now()
                        };
                        localStorage.setItem('code-share-' + roomId, JSON.stringify(codeData));
                    }
                };
                
                // Debounce code updates
                const timeoutId = setTimeout(syncMyCode, 500);
                return () => clearTimeout(timeoutId);
            }
        }, [player1Code, isCodeSharing, roomId, myId, selectedLanguage, db]);
        
        // Enhanced WebRTC Signaling Listener with Firebase and localStorage fallback
        useEffect(() => {
            if (!roomId) return;
            
            // If Firebase and db are available, use them for global signaling
            if (db && window.firebase && window.firebase.firestore) {
                console.log('Setting up Firebase WebRTC signaling for room:', roomId);
                
                let unsubscribeWebRTC = null;
                let unsubscribeICE = null;
                
                try {
                    // Listen for WebRTC signaling documents
                    unsubscribeWebRTC = db.collection('battleRooms').doc(roomId)
                        .onSnapshot(async (doc) => {
                            if (!doc.exists) return;
                            const data = doc.data();
                            
                            // Handle WebRTC voice chat offer
                            if (data.webrtc?.offer && data.webrtc.from !== myId && !isCreator) {
                                console.log('üé§ Received voice chat offer from:', data.webrtc.from);
                                try {
                                    await handleWebRTCOffer(data.webrtc.offer, 'voice');
                                } catch (error) {
                                    console.error('‚ùå Error handling voice WebRTC offer:', error);
                                }
                            }
                            
                            // Handle WebRTC voice chat answer
                            if (data.webrtc?.answer && data.webrtc.from !== myId && isCreator) {
                                console.log('üé§ Received voice chat answer from:', data.webrtc.from);
                                try {
                                    await handleWebRTCAnswer(data.webrtc.answer, 'voice');
                                } catch (error) {
                                    console.error('‚ùå Error handling voice WebRTC answer:', error);
                                }
                            }
                            
                            // Handle screen sharing offers
                            if (data.screenShare?.offer && data.screenShare.from !== myId) {
                                console.log('üì∫ Received screen share offer from:', data.screenShare.from);
                                try {
                                    await handleWebRTCOffer(data.screenShare.offer, 'screen');
                                } catch (error) {
                                    console.error('‚ùå Error handling screen share offer:', error);
                                }
                            }
                            
                            // Handle screen sharing answers
                            if (data.screenShare?.answer && data.screenShare.from !== myId) {
                                console.log('üì∫ Received screen share answer from:', data.screenShare.from);
                                try {
                                    await handleWebRTCAnswer(data.screenShare.answer, 'screen');
                                } catch (error) {
                                    console.error('‚ùå Error handling screen share answer:', error);
                                }
                            }
                        }, (error) => {
                            console.error('‚ùå Firebase WebRTC listener error:', error);
                        });
                    
                    // Listen for ICE candidates
                    unsubscribeICE = db.collection('battleRooms').doc(roomId)
                        .collection('iceCandidates')
                        .where('from', '!=', myId)
                        .onSnapshot((snapshot) => {
                            snapshot.docChanges().forEach(async (change) => {
                                if (change.type === 'added') {
                                    const candidateData = change.doc.data();
                                    console.log('üîÑ Received ICE candidate from:', candidateData.from);
                                    
                                    try {
                                        // Try to add ICE candidate to both peer connections
                                        let added = false;
                                        
                                        if (voicePeerConnectionRef.current && candidateData.candidate) {
                                            try {
                                                await voicePeerConnectionRef.current.addIceCandidate(new RTCIceCandidate(candidateData.candidate));
                                                console.log('‚úÖ ICE candidate added to voice connection');
                                                added = true;
                                            } catch (e) {
                                                console.log('üîç ICE candidate not compatible with voice connection');
                                            }
                                        }
                                        
                                        if (screenPeerConnectionRef.current && candidateData.candidate && !added) {
                                            try {
                                                await screenPeerConnectionRef.current.addIceCandidate(new RTCIceCandidate(candidateData.candidate));
                                                console.log('‚úÖ ICE candidate added to screen connection');
                                                added = true;
                                            } catch (e) {
                                                console.log('üîç ICE candidate not compatible with screen connection');
                                            }
                                        }
                                        
                                        if (!added) {
                                            console.warn('‚ö†Ô∏è ICE candidate could not be added to any connection');
                                        }
                                    } catch (error) {
                                        console.error('‚ùå Error adding ICE candidate:', error);
                                    }
                                }
                            });
                        }, (error) => {
                            console.error('‚ùå Firebase ICE candidates listener error:', error);
                        });
                        
                } catch (error) {
                    console.error('‚ùå Error setting up Firebase WebRTC listeners:', error);
                }
                
                return () => {
                    if (unsubscribeWebRTC) unsubscribeWebRTC();
                    if (unsubscribeICE) unsubscribeICE();
                };
                
            } else {
                // Disable localStorage signaling to prevent infinite loops
                console.log('Firebase not available, localStorage signaling DISABLED to prevent infinite loops');
                console.log('‚ö†Ô∏è For local testing, use two browser windows with the same URL');
                
                // DISABLED: localStorage polling to prevent infinite loops
                // let localInterval;
                
                // Enhanced localStorage-based signaling for local testing
                const checkForSignals = () => {
                    try {
                        // Check for WebRTC voice chat signals
                        const voiceSignals = JSON.parse(localStorage.getItem('webrtc-voice-signals-' + roomId) || '{}');
                        
                        // Check for voice chat offers
                        if (voiceSignals.offer && voiceSignals.from !== myId && !isCreator) {
                            console.log('üé§ Received local voice offer from:', voiceSignals.from);
                            handleWebRTCOffer(voiceSignals.offer, 'voice');
                            localStorage.removeItem('webrtc-voice-signals-' + roomId);
                        }
                        
                        // Check for voice chat answers
                        if (voiceSignals.answer && voiceSignals.from !== myId && isCreator) {
                            console.log('üé§ Received local voice answer from:', voiceSignals.from);
                            handleWebRTCAnswer(voiceSignals.answer, 'voice');
                            localStorage.removeItem('webrtc-voice-signals-' + roomId);
                        }
                        
                        // Check for screen sharing signals
                        const screenSignals = JSON.parse(localStorage.getItem('screen-share-signals-' + roomId) || '{}');
                        
                        // Check for screen sharing offers
                        if (screenSignals.offer && screenSignals.from !== myId) {
                            console.log('üì∫ Received local screen share offer from:', screenSignals.from);
                            handleWebRTCOffer(screenSignals.offer, 'screen');
                            localStorage.removeItem('screen-share-signals-' + roomId);
                        }
                        
                        // Check for screen sharing answers
                        if (screenSignals.answer && screenSignals.from !== myId) {
                            console.log('üì∫ Received local screen share answer from:', screenSignals.from);
                            handleWebRTCAnswer(screenSignals.answer, 'screen');
                            localStorage.removeItem('screen-share-signals-' + roomId);
                        }
                        
                        // Check for ICE candidates
                        const candidates = JSON.parse(localStorage.getItem('ice-candidates-' + roomId) || '[]');
                        const newCandidates = candidates.filter(c => c.from !== myId && !c.processed);
                        
                        newCandidates.forEach(async candidateData => {
                            try {
                                // Try to add ICE candidate to both peer connections
                                let added = false;
                                
                                if (voicePeerConnectionRef.current && candidateData.candidate) {
                                    try {
                                        await voicePeerConnectionRef.current.addIceCandidate(new RTCIceCandidate(candidateData.candidate));
                                        console.log('‚úÖ Local ICE candidate added to voice connection');
                                        added = true;
                                    } catch (e) {
                                        console.log('üîç Local ICE candidate not compatible with voice connection');
                                    }
                                }
                                
                                if (screenPeerConnectionRef.current && candidateData.candidate && !added) {
                                    try {
                                        await screenPeerConnectionRef.current.addIceCandidate(new RTCIceCandidate(candidateData.candidate));
                                        console.log('‚úÖ Local ICE candidate added to screen connection');
                                        added = true;
                                    } catch (e) {
                                        console.log('üîç Local ICE candidate not compatible with screen connection');
                                    }
                                }
                                
                                // Mark as processed
                                candidateData.processed = true;
                                
                                if (!added) {
                                    console.warn('‚ö†Ô∏è Local ICE candidate could not be added to any connection');
                                }
                            } catch (error) {
                                console.error('‚ùå Error adding local ICE candidate:', error);
                                candidateData.processed = true; // Mark as processed even if failed
                            }
                        });
                        
                        // Update candidates list (remove old processed ones, keep recent ones)
                        if (newCandidates.length > 0) {
                            const now = Date.now();
                            const updatedCandidates = candidates.filter(c => 
                                c.from === myId || 
                                (!c.processed && (now - c.timestamp) < 30000) // Keep unprocessed ones for 30 seconds
                            );
                            localStorage.setItem('ice-candidates-' + roomId, JSON.stringify(updatedCandidates));
                        }
                        
                    } catch (e) {
                        console.error('‚ùå Error checking local signals:', e);
                    }
                };
                
                // DISABLED: Prevent infinite loops
                // localInterval = setInterval(checkForSignals, 5000);
                console.log('üí§ localStorage signaling interval DISABLED');
                return () => {
                    console.log('üßπ Cleaning up localStorage signaling interval (was disabled)');
                    // if (localInterval) {
                    //     clearInterval(localInterval);
                    //     localInterval = null;
                    // }
                };
            }
        }, [roomId, myId, isCreator, db]);
        
        // Cleanup WebRTC on unmount
        useEffect(() => {
            return () => {
                if (localAudioStream) {
                    localAudioStream.getTracks().forEach(track => track.stop());
                }
                if (localScreenStream) {
                    localScreenStream.getTracks().forEach(track => track.stop());
                }
                if (voicePeerConnectionRef.current) {
                    voicePeerConnectionRef.current.close();
                }
                if (screenPeerConnectionRef.current) {
                    screenPeerConnectionRef.current.close();
                }
            };
        }, []);

        // Track editor initialization to prevent duplication
        const editorInitialized = useRef(false);
        
        // Initialize CodeMirror editor for battle mode (only once)
        useEffect(() => {
            const editorContainer = document.getElementById("battle-editor");
            if (!editorContainer || !window.CodeMirror || editor || editorInitialized.current) return;

            console.log('üîß Initializing CodeMirror editor for battle mode...');
            
            const initialCode = problem.starterCode[selectedLanguage];
            const newEditor = window.CodeMirror(editorContainer, {
                value: initialCode,
                mode: selectedLanguage === "javascript" ? "javascript" : 
                      selectedLanguage === "python" ? "python" :
                      selectedLanguage === "java" ? "text/x-java" :
                      selectedLanguage === "cpp" ? "text/x-c++src" : "javascript",
                theme: (function(){
                    try { return (localStorage.getItem('theme') || 'dark') === 'dark' ? 'dracula' : 'default'; } catch(e) { return 'dracula'; }
                })(),
                lineNumbers: true,
                indentUnit: 4,
                smartIndent: true,
            });

            // Set initial code state to match editor
            setPlayer1Code(initialCode);
            
            // Track changes
            newEditor.on("change", (instance) => setPlayer1Code(instance.getValue()));
            newEditor.on("cursorActivity", (cm) => {
                try {
                    const s = cm.getSelection ? cm.getSelection() : '';
                    setHasSelection(!!(s && s.trim()));
                } catch (e) { setHasSelection(false); }
            });
            setEditor(newEditor);
            editorInitialized.current = true;
            
            console.log('‚úÖ CodeMirror editor initialized successfully');

            return () => {
                console.log('üßπ Cleaning up CodeMirror editor');
                if (newEditor) {
                    newEditor.toTextArea?.();
                }
                editorInitialized.current = false;
            };
        }, []);

        // Handle language switch for battle mode (separate effect) - ONLY change mode, don't reset code
        const lastLanguage = useRef(selectedLanguage);
        useEffect(() => {
            if (editor && selectedLanguage && lastLanguage.current !== selectedLanguage) {
                console.log('üîÑ Switching language from', lastLanguage.current, 'to', selectedLanguage);
                const mode = selectedLanguage === "javascript" ? "javascript" : 
                           selectedLanguage === "python" ? "python" :
                           selectedLanguage === "java" ? "text/x-java" :
                           selectedLanguage === "cpp" ? "text/x-c++src" : "javascript";
                editor.setOption("mode", mode);
                
                // Only set starter code, don't append
                const newStarterCode = problem.starterCode[selectedLanguage];
                editor.setValue(newStarterCode); // This replaces all content
                setPlayer1Code(newStarterCode);
                
                lastLanguage.current = selectedLanguage;
                console.log('‚úÖ Language switch completed');
            }
        }, [selectedLanguage, editor]);

        // Judge0 API integration for battle mode - Run Code
        const handleRunCode = async (player) => {
            if (player !== 1) return; // Only handle player 1 (current user)
            
            setLoading(true);
            setPlayer1Output("Running code with Judge0...");

            const languageMap = {
                javascript: 63, // Node.js
                python: 71,     // Python 3
                java: 62,       // Java
                cpp: 54,        // C++ 17
            };

            // Run with the first test case only for "Run Code"
            const test = problem.testCases[0];

            // Get function name based on problem
            const functionName = battleProblemId == 1 ? 'twoSum' : 
                                battleProblemId == 2 ? 'addTwoNumbers' :
                                battleProblemId == 3 ? 'lengthOfLongestSubstring' :
                                battleProblemId == 4 ? 'findMedianSortedArrays' :
                                battleProblemId == 5 ? 'reverseList' : 'twoSum';

            const pythonFunctionName = battleProblemId == 1 ? 'two_sum' : 
                                      battleProblemId == 2 ? 'add_two_numbers' :
                                      battleProblemId == 3 ? 'length_of_longest_substring' :
                                      battleProblemId == 4 ? 'find_median_sorted_arrays' :
                                      battleProblemId == 5 ? 'reverse_list' : 'two_sum';

            const javaFunctionName = battleProblemId == 1 ? 'twoSum' : 
                                    battleProblemId == 2 ? 'addTwoNumbers' :
                                    battleProblemId == 3 ? 'lengthOfLongestSubstring' :
                                    battleProblemId == 4 ? 'findMedianSortedArrays' :
                                    battleProblemId == 5 ? 'reverseList' : 'twoSum';

            const cppFunctionName = battleProblemId == 1 ? 'twoSum' : 
                                   battleProblemId == 2 ? 'addTwoNumbers' :
                                   battleProblemId == 3 ? 'lengthOfLongestSubstring' :
                                   battleProblemId == 4 ? 'findMedianSortedArrays' :
                                   battleProblemId == 5 ? 'reverseList' : 'twoSum';

            // Handle different parameter structures for different problems
            let functionCall = "";
            
            if (battleProblemId == 1) {
                // Two Sum: twoSum(nums, target)
                if (selectedLanguage === "javascript") {
                    functionCall = `${functionName}(${JSON.stringify(test.input)}, ${test.target})`;
                } else if (selectedLanguage === "python") {
                    functionCall = `${pythonFunctionName}(${JSON.stringify(test.input)}, ${test.target})`;
                } else if (selectedLanguage === "java") {
                    functionCall = `${javaFunctionName}(new int[]{${test.input.join(',')}}, ${test.target})`;
                } else if (selectedLanguage === "cpp") {
                    functionCall = `${cppFunctionName}({${test.input.join(',')}}, ${test.target})`;
                }
            } else if (battleProblemId == 2) {
                // Add Two Numbers: addTwoNumbers(l1, l2)
                if (selectedLanguage === "javascript") {
                    functionCall = `${functionName}(${JSON.stringify(test.input.l1)}, ${JSON.stringify(test.input.l2)})`;
                } else if (selectedLanguage === "python") {
                    functionCall = `${pythonFunctionName}(${JSON.stringify(test.input.l1)}, ${JSON.stringify(test.input.l2)})`;
                } else if (selectedLanguage === "java") {
                    functionCall = `${javaFunctionName}(new int[]{${test.input.l1.join(',')}}, new int[]{${test.input.l2.join(',')}})`;
                } else if (selectedLanguage === "cpp") {
                    functionCall = `${cppFunctionName}({${test.input.l1.join(',')}}, {${test.input.l2.join(',')}})`;
                }
            } else if (battleProblemId == 3) {
                // Longest Substring: lengthOfLongestSubstring(s)
                if (selectedLanguage === "javascript") {
                    functionCall = `${functionName}(${JSON.stringify(test.input)})`;
                } else if (selectedLanguage === "python") {
                    functionCall = `${pythonFunctionName}(${JSON.stringify(test.input)})`;
                } else if (selectedLanguage === "java") {
                    functionCall = `${javaFunctionName}("${test.input}")`;
                } else if (selectedLanguage === "cpp") {
                    functionCall = `${cppFunctionName}("${test.input}")`;
                }
            } else if (battleProblemId == 4) {
                // Median of Arrays: findMedianSortedArrays(nums1, nums2)
                if (selectedLanguage === "javascript") {
                    functionCall = `${functionName}(${JSON.stringify(test.input.nums1)}, ${JSON.stringify(test.input.nums2)})`;
                } else if (selectedLanguage === "python") {
                    functionCall = `${pythonFunctionName}(${JSON.stringify(test.input.nums1)}, ${JSON.stringify(test.input.nums2)})`;
                } else if (selectedLanguage === "java") {
                    functionCall = `${javaFunctionName}(new int[]{${test.input.nums1.join(',')}}, new int[]{${test.input.nums2.join(',')}})`;
                } else if (selectedLanguage === "cpp") {
                    functionCall = `${cppFunctionName}({${test.input.nums1.join(',')}}, {${test.input.nums2.join(',')}})`;
                }
            } else if (battleProblemId == 5) {
                // Reverse List: reverseList(head)
                if (selectedLanguage === "javascript") {
                    functionCall = `${functionName}(${JSON.stringify(test.input)})`;
                } else if (selectedLanguage === "python") {
                    functionCall = `${pythonFunctionName}(${JSON.stringify(test.input)})`;
                } else if (selectedLanguage === "java") {
                    functionCall = `${javaFunctionName}(new int[]{${test.input.join(',')}})`;
                } else if (selectedLanguage === "cpp") {
                    functionCall = `${cppFunctionName}({${test.input.join(',')}})`;
                }
            }

            // Fallback: if functionCall is still empty, use a default
            if (!functionCall) {
                if (selectedLanguage === "javascript") {
                    functionCall = `${functionName}(${JSON.stringify(test.input)}, ${test.target})`;
                } else if (selectedLanguage === "python") {
                    functionCall = `${pythonFunctionName}(${JSON.stringify(test.input)}, ${test.target})`;
                } else if (selectedLanguage === "java") {
                    functionCall = `${javaFunctionName}(new int[]{${test.input.join(',')}}, ${test.target})`;
                } else if (selectedLanguage === "cpp") {
                    functionCall = `${cppFunctionName}({${test.input.join(',')}}, ${test.target})`;
                }
            }

            // Generate wrapped code based on language
            let wrappedCode = "";
            if (selectedLanguage === "javascript") {
                wrappedCode = `${player1Code}

// Auto-call the function with test case
try {
    const result = ${functionCall};
    console.log(JSON.stringify(result));
} catch (error) {
    console.error(error.message);
}`;
            } else if (selectedLanguage === "python") {
                wrappedCode = `
${player1Code}

# Auto-call the function with test case
import json
print(json.dumps(${functionCall}))
`;
            } else if (selectedLanguage === "java") {
                // Extract the method body from user code
                let methodBody = player1Code.trim();
                
                // Remove 'public' prefix if it exists
                if (methodBody.startsWith('public ')) {
                    methodBody = methodBody.replace(/^public\s+/, '');
                }
                
                // Ensure it has public static prefix
                if (!methodBody.startsWith('static ')) {
                    methodBody = 'public static ' + methodBody;
                } else {
                    methodBody = 'public ' + methodBody;
                }
                
                // For problems that return non-array types, don't use Arrays.toString()
                const needsArraysToString = battleProblemId === 1 || battleProblemId === 2 || battleProblemId === 5;
                const printStatement = needsArraysToString ? `Arrays.toString(${functionCall})` : `${functionCall}`;
                
                wrappedCode = `import java.util.*;

public class Main {
    ${methodBody}
    
    public static void main(String[] args) {
        try {
            System.out.println(${printStatement});
        } catch (Exception e) {
            System.err.println("Error: " + e.getMessage());
        }
    }
}`;
            } else if (selectedLanguage === "cpp") {
                wrappedCode = `#include <iostream>
#include <vector>
#include <string>
#include <algorithm>
#include <sstream>
using namespace std;

// Helper function to print vectors
template<typename T>
void printVector(const vector<T>& vec) {
    cout << "[";
    for (size_t i = 0; i < vec.size(); ++i) {
        cout << vec[i];
        if (i < vec.size() - 1) cout << ",";
    }
    cout << "]";
}

${player1Code}

int main() {
    try {
        auto result = ${functionCall};
        
        // Handle different return types
        if constexpr (std::is_same_v<decltype(result), vector<int>>) {
            printVector(result);
        } else {
            cout << result;
        }
        cout << endl;
    } catch (const exception& e) {
        cerr << "Error: " << e.what() << endl;
    }
    return 0;
}`;
            }

            try {
                const res = await fetch("https://judge0-ce.p.rapidapi.com/submissions?base64_encoded=true&wait=true", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "x-rapidapi-host": "judge0-ce.p.rapidapi.com",
                        "x-rapidapi-key": "1f4bcaf085mshdb3d102dc891ab6p12b4d2jsn3480d98ed8c1"
                    },
                    body: JSON.stringify({
                        source_code: btoa(wrappedCode),
                        language_id: languageMap[selectedLanguage],
                        stdin: btoa(""),
                    }),
                });

                const result = await res.json();
                if (result.stdout) {
                    setPlayer1Output("Output:\n" + atob(result.stdout));
                } else if (result.stderr) {
                    setPlayer1Output("Error:\n" + atob(result.stderr));
                } else if (result.compile_output) {
                    setPlayer1Output("Compilation Error:\n" + atob(result.compile_output));
                } else {
                    setPlayer1Output("Unexpected response:\n" + JSON.stringify(result, null, 2));
                }
            } catch (err) {
                setPlayer1Output("Error calling Judge0: " + err.message);
            }

            setLoading(false);
        };

        // Judge0 API integration for battle mode - Submit Code
        const handleSubmitCode = async (player) => {
            if (player !== 1) return; // Only handle player 1 (current user)
            
            setLoading(true);
            setPlayer1Output("Submitting solution via Judge0...");

            const languageMap = {
                javascript: 63, // Node.js
                python: 71,     // Python 3
                java: 62,       // Java
                cpp: 54,        // C++ 17
            };

            let results = [];

            for (let i = 0; i < problem.testCases.length; i++) {
                const test = problem.testCases[i];

                // Get function name based on problem
                const functionName = battleProblemId === 1 ? 'twoSum' : 
                                    battleProblemId === 2 ? 'addTwoNumbers' :
                                    battleProblemId === 3 ? 'lengthOfLongestSubstring' :
                                    battleProblemId === 4 ? 'findMedianSortedArrays' :
                                    battleProblemId === 5 ? 'reverseList' : 'twoSum';

                const pythonFunctionName = battleProblemId == 1 ? 'two_sum' : 
                                          battleProblemId == 2 ? 'add_two_numbers' :
                                          battleProblemId == 3 ? 'length_of_longest_substring' :
                                          battleProblemId == 4 ? 'find_median_sorted_arrays' :
                                          battleProblemId == 5 ? 'reverse_list' : 'two_sum';

                const javaFunctionName = battleProblemId == 1 ? 'twoSum' : 
                                        battleProblemId == 2 ? 'addTwoNumbers' :
                                        battleProblemId == 3 ? 'lengthOfLongestSubstring' :
                                        battleProblemId == 4 ? 'findMedianSortedArrays' :
                                        battleProblemId == 5 ? 'reverseList' : 'twoSum';

                const cppFunctionName = battleProblemId == 1 ? 'twoSum' : 
                                       battleProblemId == 2 ? 'addTwoNumbers' :
                                       battleProblemId == 3 ? 'lengthOfLongestSubstring' :
                                       battleProblemId == 4 ? 'findMedianSortedArrays' :
                                       battleProblemId == 5 ? 'reverseList' : 'twoSum';

                // Handle different parameter structures for different problems
                let functionCall = "";
                
                if (battleProblemId == 1) {
                    // Two Sum: twoSum(nums, target)
                    if (selectedLanguage === "javascript") {
                        functionCall = `${functionName}(${JSON.stringify(test.input)}, ${test.target})`;
                    } else if (selectedLanguage === "python") {
                        functionCall = `${pythonFunctionName}(${JSON.stringify(test.input)}, ${test.target})`;
                    } else if (selectedLanguage === "java") {
                        functionCall = `${javaFunctionName}(new int[]{${test.input.join(',')}}, ${test.target})`;
                    } else if (selectedLanguage === "cpp") {
                        functionCall = `${cppFunctionName}({${test.input.join(',')}}, ${test.target})`;
                    }
                } else if (battleProblemId == 2) {
                    // Add Two Numbers: addTwoNumbers(l1, l2)
                    if (selectedLanguage === "javascript") {
                        functionCall = `${functionName}(${JSON.stringify(test.input.l1)}, ${JSON.stringify(test.input.l2)})`;
                    } else if (selectedLanguage === "python") {
                        functionCall = `${pythonFunctionName}(${JSON.stringify(test.input.l1)}, ${JSON.stringify(test.input.l2)})`;
                    } else if (selectedLanguage === "java") {
                        functionCall = `${javaFunctionName}(new int[]{${test.input.l1.join(',')}}, new int[]{${test.input.l2.join(',')}})`;
                    } else if (selectedLanguage === "cpp") {
                        functionCall = `${cppFunctionName}({${test.input.l1.join(',')}}, {${test.input.l2.join(',')}})`;
                    }
                } else if (battleProblemId == 3) {
                    // Longest Substring: lengthOfLongestSubstring(s)
                    if (selectedLanguage === "javascript") {
                        functionCall = `${functionName}(${JSON.stringify(test.input)})`;
                    } else if (selectedLanguage === "python") {
                        functionCall = `${pythonFunctionName}(${JSON.stringify(test.input)})`;
                    } else if (selectedLanguage === "java") {
                        functionCall = `${javaFunctionName}("${test.input}")`;
                    } else if (selectedLanguage === "cpp") {
                        functionCall = `${cppFunctionName}("${test.input}")`;
                    }
                } else if (battleProblemId == 4) {
                    // Median of Arrays: findMedianSortedArrays(nums1, nums2)
                    if (selectedLanguage === "javascript") {
                        functionCall = `${functionName}(${JSON.stringify(test.input.nums1)}, ${JSON.stringify(test.input.nums2)})`;
                    } else if (selectedLanguage === "python") {
                        functionCall = `${pythonFunctionName}(${JSON.stringify(test.input.nums1)}, ${JSON.stringify(test.input.nums2)})`;
                    } else if (selectedLanguage === "java") {
                        functionCall = `${javaFunctionName}(new int[]{${test.input.nums1.join(',')}}, new int[]{${test.input.nums2.join(',')}})`;
                    } else if (selectedLanguage === "cpp") {
                        functionCall = `${cppFunctionName}({${test.input.nums1.join(',')}}, {${test.input.nums2.join(',')}})`;
                    }
                } else if (battleProblemId == 5) {
                    // Reverse List: reverseList(head)
                    if (selectedLanguage === "javascript") {
                        functionCall = `${functionName}(${JSON.stringify(test.input)})`;
                    } else if (selectedLanguage === "python") {
                        functionCall = `${pythonFunctionName}(${JSON.stringify(test.input)})`;
                    } else if (selectedLanguage === "java") {
                        functionCall = `${javaFunctionName}(new int[]{${test.input.join(',')}})`;
                    } else if (selectedLanguage === "cpp") {
                        functionCall = `${cppFunctionName}({${test.input.join(',')}})`;
                    }
                }

                // Fallback: if functionCall is still empty, use a default
                if (!functionCall) {
                    if (selectedLanguage === "javascript") {
                        functionCall = `${functionName}(${JSON.stringify(test.input)}, ${test.target})`;
                    } else if (selectedLanguage === "python") {
                        functionCall = `${pythonFunctionName}(${JSON.stringify(test.input)}, ${test.target})`;
                    } else if (selectedLanguage === "java") {
                        functionCall = `${javaFunctionName}(new int[]{${test.input.join(',')}}, ${test.target})`;
                    } else if (selectedLanguage === "cpp") {
                        functionCall = `${cppFunctionName}({${test.input.join(',')}}, ${test.target})`;
                    }
                }

                let wrappedCode = "";
                if (selectedLanguage === "javascript") {
                    wrappedCode = `${player1Code}

// Auto-call the function with test case
try {
    const result = ${functionCall};
    console.log(JSON.stringify(result));
} catch (error) {
    console.error(error.message);
}`;
                } else if (selectedLanguage === "python") {
                    wrappedCode = `
${player1Code}

# Auto-call the function with test case
import json
print(json.dumps(${functionCall}))
`;
                } else if (selectedLanguage === "java") {
                    // Extract the method body from user code
                    let methodBody = player1Code.trim();
                    
                    // Remove 'public' prefix if it exists
                    if (methodBody.startsWith('public ')) {
                        methodBody = methodBody.replace(/^public\s+/, '');
                    }
                    
                    // Ensure it has public static prefix
                    if (!methodBody.startsWith('static ')) {
                        methodBody = 'public static ' + methodBody;
                    } else {
                        methodBody = 'public ' + methodBody;
                    }
                    
                    // For problems that return non-array types, don't use Arrays.toString()
                    const needsArraysToString = battleProblemId === 1 || battleProblemId === 2 || battleProblemId === 5;
                    const printStatement = needsArraysToString ? `Arrays.toString(${functionCall})` : `${functionCall}`;
                    
                    wrappedCode = `import java.util.*;

public class Main {
    ${methodBody}
    
    public static void main(String[] args) {
        try {
            System.out.println(${printStatement});
        } catch (Exception e) {
            System.err.println("Error: " + e.getMessage());
        }
    }
}`;
                } else if (selectedLanguage === "cpp") {
                    wrappedCode = `#include <iostream>
#include <vector>
#include <string>
#include <algorithm>
#include <sstream>
using namespace std;

// Helper function to print vectors
template<typename T>
void printVector(const vector<T>& vec) {
    cout << "[";
    for (size_t i = 0; i < vec.size(); ++i) {
        cout << vec[i];
        if (i < vec.size() - 1) cout << ",";
    }
    cout << "]";
}

${player1Code}

int main() {
    try {
        auto result = ${functionCall};
        
        // Handle different return types
        if constexpr (std::is_same_v<decltype(result), vector<int>>) {
            printVector(result);
        } else {
            cout << result;
        }
        cout << endl;
    } catch (const exception& e) {
        cerr << "Error: " << e.what() << endl;
    }
    return 0;
}`;
                }

                try {
                    const res = await fetch(
                        "https://judge0-ce.p.rapidapi.com/submissions?base64_encoded=true&wait=true",
                        {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                                "x-rapidapi-host": "judge0-ce.p.rapidapi.com",
                                "x-rapidapi-key": "1f4bcaf085mshdb3d102dc891ab6p12b4d2jsn3480d98ed8c1"
                            },
                            body: JSON.stringify({
                                source_code: btoa(wrappedCode),
                                language_id: languageMap[selectedLanguage],
                                stdin: btoa(""),
                            }),
                        }
                    );

                    const result = await res.json();

                    let verdict = "Wrong Answer";
                    if (result.stdout) {
                        const userOutput = JSON.parse(atob(result.stdout).trim());
                        verdict =
                            JSON.stringify(userOutput) === JSON.stringify(test.expected)
                                ? "Passed"
                                : `Failed (Expected ${JSON.stringify(test.expected)}, Got ${JSON.stringify(userOutput)})`;
                    } else if (result.stderr) {
                        verdict = "Runtime Error: " + atob(result.stderr);
                    } else if (result.compile_output) {
                        verdict = "Compilation Error: " + atob(result.compile_output);
                    }

                    results.push(`Test Case ${i + 1}: ${verdict}`);
                } catch (err) {
                    results.push(`Test Case ${i + 1}: Error - ${err.message}`);
                }
            }

            const passedTests = results.filter(r => r.includes('Passed')).length;
            const totalTests = problem.testCases.length;
            const progressPercent = Math.round((passedTests / totalTests) * 100);
            
            setPlayer1Progress(progressPercent);
            setPlayer1Output(results.join("\n"));
            
            // Check if all tests passed for completion
            if (passedTests === totalTests) {
                setPlayer1Output(prev => prev + "\n\n‚úÖ All tests passed! Solution submitted successfully.");
                if (player2Progress === 100) { // Both completed
                    setBattleStatus("Ended");
                    setWinner('player1'); // Winner determination logic can be enhanced
                }
            }
            
            setLoading(false);
        };

        const handleSendChatMessage = () => {
            console.log('üí¨ Attempting to send chat message:', newChatMessage);
            console.log('üí¨ Current chat messages count:', chatMessages.length);
            console.log('üí¨ Current user ID:', userId || myId || "Guest");
            
            if (newChatMessage.trim()) {
                const sender = userId || myId || "Guest";
                const message = {
                    id: Date.now() + Math.random(), // Unique ID
                    sender: sender,
                    text: newChatMessage.trim(),
                    timestamp: new Date()
                };
                
                console.log('üí¨ Sending message:', message);
                setChatMessages((prev) => {
                    const updated = [...prev, message];
                    console.log('üí¨ Updated chat messages:', updated);
                    
                    // Save to localStorage
                    try {
                        localStorage.setItem(`battle-chat-${roomId || 'local'}`, JSON.stringify(updated));
                        console.log('üìã Saved chat messages to localStorage');
                    } catch (e) {
                        console.warn('‚ö†Ô∏è Could not save chat messages:', e);
                    }
                    
                    return updated;
                });
                setNewChatMessage('');
                
                // Auto-scroll to bottom after sending message
                setTimeout(() => {
                    if (chatEndRef.current) {
                        chatEndRef.current.scrollIntoView({ behavior: 'smooth' });
                    }
                }, 100);
            } else {
                console.log('‚ö†Ô∏è Empty message, not sending');
            }
        };
        
        // Auto-scroll chat to bottom when new messages arrive
        useEffect(() => {
            console.log('üìú Chat messages updated, count:', chatMessages.length);
            console.log('üìú Messages:', chatMessages.map(m => `${m.sender}: ${m.text}`));
            if (chatEndRef.current) {
                chatEndRef.current.scrollIntoView({ behavior: 'smooth' });
            }
        }, [chatMessages]);
        
        // Clear chat messages when room changes
        useEffect(() => {
            if (roomId) {
                try {
                    const saved = localStorage.getItem(`battle-chat-${roomId}`);
                    if (saved) {
                        const messages = JSON.parse(saved);
                        setChatMessages(messages);
                        console.log('üìú Loaded', messages.length, 'saved chat messages for room', roomId);
                    } else {
                        setChatMessages([]);
                        console.log('üìú No saved messages for room', roomId);
                    }
                } catch (e) {
                    console.warn('‚ö†Ô∏è Could not load chat messages for room', roomId, ':', e);
                    setChatMessages([]);
                }
            }
        }, [roomId]);
        
        // Handle Enter key press for chat
        const handleChatKeyPress = (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                handleSendChatMessage();
            }
        };

        const formatTime = (seconds) => {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            return `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
        };

        // --- WebRTC Voice Chat & Screen Sharing Functions ---
        const initializeVoicePeerConnection = () => {
            // Always create new connection if current one is failed or closed
            if (voicePeerConnectionRef.current) {
                const state = voicePeerConnectionRef.current.connectionState;
                if (state === 'connected' || state === 'connecting') {
                    console.log('üé§ Reusing existing voice peer connection (state:', state, ')');
                    return voicePeerConnectionRef.current;
                }
                
                console.log('üóëÔ∏è Closing failed/closed voice peer connection (state:', state, ')');
                voicePeerConnectionRef.current.close();
                voicePeerConnectionRef.current = null;
                setVoicePeerConnection(null);
            }
            
            return createPeerConnection('voice');
        };
        
        const initializeScreenPeerConnection = () => {
            // Always create new connection if current one is failed or closed
            if (screenPeerConnectionRef.current) {
                const state = screenPeerConnectionRef.current.connectionState;
                if (state === 'connected' || state === 'connecting') {
                    console.log('üì∫ Reusing existing screen peer connection (state:', state, ')');
                    return screenPeerConnectionRef.current;
                }
                
                console.log('üóëÔ∏è Closing failed/closed screen peer connection (state:', state, ')');
                screenPeerConnectionRef.current.close();
                screenPeerConnectionRef.current = null;
                setScreenPeerConnection(null);
            }
            
            return createPeerConnection('screen');
        };
        
        const createPeerConnection = (type) => {
            console.log(`üÜï Initializing new ${type} peer connection...`);
            
            // Enhanced ICE servers configuration for better connectivity
            const iceServers = [
                // Google STUN servers
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' },
                { urls: 'stun:stun2.l.google.com:19302' },
                
                // Additional STUN servers for better reliability
                { urls: 'stun:stun.stunprotocol.org:3478' },
                { urls: 'stun:stun.nextcloud.com:443' },
                
                // Production TURN servers for better connectivity
                {
                    urls: 'turn:numb.viagenie.ca',
                    credential: 'muazkh',
                    username: 'webrtc@live.com'
                },
                {
                    urls: 'turn:192.158.29.39:3478?transport=udp',
                    credential: 'JZEOEt2V3Qb0y27GRntt2u2PAYA=',
                    username: '28224511:1379330808'
                },
                {
                    urls: 'turn:192.158.29.39:3478?transport=tcp',
                    credential: 'JZEOEt2V3Qb0y27GRntt2u2PAYA=',
                    username: '28224511:1379330808'
                }
            ];
            
            console.log('üåç Using ICE servers:', iceServers.map(s => s.urls));
            
            const pc = new RTCPeerConnection({ 
                iceServers,
                iceCandidatePoolSize: 10,
                bundlePolicy: 'max-bundle',
                rtcpMuxPolicy: 'require',
                iceTransportPolicy: 'all' // Try both STUN and TURN
            });
            
            console.log('‚úÖ Peer connection created successfully');
            
            // Enhanced connection state monitoring with detailed debugging
            pc.onconnectionstatechange = () => {
                console.log('üîÑ ===== CONNECTION STATE CHANGE =====');
                console.log('  - Connection State:', pc.connectionState);
                console.log('  - ICE Connection State:', pc.iceConnectionState);
                console.log('  - ICE Gathering State:', pc.iceGatheringState);
                console.log('  - Signaling State:', pc.signalingState);
                
                if (pc.connectionState === 'connected') {
                    console.log('‚úÖ WebRTC connection established successfully!');
                    
                    // Log active senders and receivers
                    const senders = pc.getSenders();
                    const receivers = pc.getReceivers();
                    console.log('üì§ Active senders:', senders.length);
                    senders.forEach((sender, index) => {
                        if (sender.track) {
                            console.log(`  - Sender ${index}:`, sender.track.kind, sender.track.label, 'enabled:', sender.track.enabled);
                        }
                    });
                    console.log('üì• Active receivers:', receivers.length);
                    receivers.forEach((receiver, index) => {
                        if (receiver.track) {
                            console.log(`  - Receiver ${index}:`, receiver.track.kind, receiver.track.label, 'enabled:', receiver.track.enabled);
                        }
                    });
                    
                } else if (pc.connectionState === 'failed') {
                    console.log('‚ùå WebRTC connection failed, attempting restart...');
                    // Attempt to restart connection
                    setTimeout(() => {
                        if (pc.connectionState === 'failed') {
                            pc.restartIce();
                        }
                    }, 2000);
                } else if (pc.connectionState === 'disconnected') {
                    console.log('‚ö†Ô∏è WebRTC connection disconnected');
                } else if (pc.connectionState === 'connecting') {
                    console.log('üîó WebRTC connection is connecting...');
                }
                
                // Update the appropriate state based on type
                if (type === 'voice') {
                    setVoicePeerConnection(pc);
                } else {
                    setScreenPeerConnection(pc);
                }
            };
            
            pc.oniceconnectionstatechange = () => {
                console.log('ICE connection state:', pc.iceConnectionState);
            };
            
            // Handle remote stream with enhanced debugging
            pc.ontrack = (event) => {
                console.log('üì° ===== ONTRACK EVENT FIRED =====');
                console.log('  - Track kind:', event.track.kind);
                console.log('  - Track label:', event.track.label);
                console.log('  - Track ID:', event.track.id);
                console.log('  - Track state:', event.track.readyState);
                console.log('  - Track enabled:', event.track.enabled);
                console.log('  - Streams count:', event.streams.length);
                
                if (event.streams.length === 0) {
                    console.warn('‚ö†Ô∏è No streams in ontrack event');
                    return;
                }
                
                const [remoteStream] = event.streams;
                console.log('üé¨ Remote stream details:');
                console.log('  - Video tracks:', remoteStream.getVideoTracks().length);
                console.log('  - Audio tracks:', remoteStream.getAudioTracks().length);
                console.log('  - Stream ID:', remoteStream.id);
                console.log('  - Stream active:', remoteStream.active);
                
                if (remoteStream.getVideoTracks().length > 0) {
                    // Screen sharing stream
                    console.log('üì∫ ===== HANDLING VIDEO STREAM =====');
                    console.log('  - Video tracks count:', remoteStream.getVideoTracks().length);
                    remoteStream.getVideoTracks().forEach((track, index) => {
                        console.log(`  - Video track ${index}:`, track.label, 'enabled:', track.enabled, 'state:', track.readyState);
                    });
                    
                    console.log('üì∫ Setting remote screen stream state:', {
                        streamId: remoteStream.id,
                        active: remoteStream.active,
                        videoTracks: remoteStream.getVideoTracks().length,
                        audioTracks: remoteStream.getAudioTracks().length
                    });
                    setRemoteScreenStream(remoteStream);
                    console.log('‚úÖ Remote screen stream state updated');
                    
                    if (remoteScreenRef.current) {
                        console.log('üñ•Ô∏è Video element found, attaching stream...');
                        console.log('  - Element type:', remoteScreenRef.current.tagName);
                        console.log('  - Element style display:', remoteScreenRef.current.style.display);
                        
                        remoteScreenRef.current.srcObject = remoteStream;
                        console.log('‚úÖ Screen sharing stream attached to video element');
                        
                        // Handle video element events with detailed logging
                        remoteScreenRef.current.onloadedmetadata = () => {
                            console.log('üì∫ Remote video metadata loaded');
                            console.log('  - Video dimensions:', remoteScreenRef.current.videoWidth, 'x', remoteScreenRef.current.videoHeight);
                            console.log('  - Video duration:', remoteScreenRef.current.duration);
                            
                            // Force video to load and play
                            remoteScreenRef.current.load();
                            remoteScreenRef.current.play()
                                .then(() => console.log('‚úÖ Video playback started successfully'))
                                .catch(e => {
                                    console.warn('‚ö†Ô∏è Video autoplay failed:', e);
                                    console.log('üíÜ Attempting to play with user interaction bypass...');
                                    // Try to play anyway
                                    setTimeout(() => {
                                        try {
                                            remoteScreenRef.current.play();
                                        } catch(err) {
                                            console.log('üéÆ Click anywhere on the page to enable video playback');
                                        }
                                    }, 1000);
                                });
                        };
                        
                        remoteScreenRef.current.oncanplay = () => {
                            console.log('‚úÖ Video can start playing');
                        };
                        
                        remoteScreenRef.current.onplay = () => {
                            console.log('‚ñ∂Ô∏è Video started playing');
                        };
                        
                        remoteScreenRef.current.onerror = (e) => {
                            console.error('‚ùå Video error:', e);
                        };
                        
                        remoteScreenRef.current.onstalled = () => {
                            console.warn('‚ö†Ô∏è Video playback stalled');
                        };
                        
                    } else {
                        console.error('‚ùå Video element ref is null!');
                    }
                } else {
                    console.log('üö´ No video tracks in stream');
                }
                
                if (remoteStream.getAudioTracks().length > 0) {
                    // Audio stream (could be voice chat or screen sharing audio)
                    console.log('üé§ Received audio stream');
                    if (remoteAudioRef.current) {
                        remoteAudioRef.current.srcObject = remoteStream;
                        console.log('üìª Audio stream attached to audio element');
                        
                        // Handle audio element events
                        remoteAudioRef.current.onloadedmetadata = () => {
                            console.log('üé§ Remote audio metadata loaded');
                            remoteAudioRef.current.play().catch(e => {
                                console.warn('Audio autoplay failed (this is normal in some browsers):', e);
                                console.log('üîä User will need to interact with page to enable audio');
                            });
                        };
                        
                        remoteAudioRef.current.oncanplay = () => {
                            console.log('‚úÖ Remote audio ready to play');
                        };
                    }
                }
            };
            
            // Handle ICE candidates via Firebase or localStorage fallback
            pc.onicecandidate = (event) => {
                if (event.candidate) {
                    console.log('Sending ICE candidate:', event.candidate.type);
                    
                    if (roomId && db && window.firebase) {
                        try {
                            // Use Firebase for global signaling - serialize the candidate properly
                            db.collection('battleRooms').doc(roomId).collection('iceCandidates').add({
                                candidate: {
                                    candidate: event.candidate.candidate,
                                    sdpMLineIndex: event.candidate.sdpMLineIndex,
                                    sdpMid: event.candidate.sdpMid,
                                    usernameFragment: event.candidate.usernameFragment
                                },
                                from: myId,
                                timestamp: firebase.firestore.FieldValue.serverTimestamp()
                            });
                        } catch (e) {
                            console.error('Error sending ICE candidate via Firebase:', e);
                            // Fallback to localStorage for local testing
                            sendIceCandidateViaLocalStorage(event.candidate);
                        }
                    } else {
                        // Local storage fallback
                        sendIceCandidateViaLocalStorage(event.candidate);
                    }
                }
            };
            
            // Store the peer connection in the appropriate ref based on type
            if (type === 'voice') {
                voicePeerConnectionRef.current = pc;
                setVoicePeerConnection(pc);
                console.log('‚úÖ Voice peer connection initialized');
                
                // Make accessible globally for debugging
                window.peerConnections = window.peerConnections || {};
                window.peerConnections.voice = pc;
            } else {
                screenPeerConnectionRef.current = pc;
                setScreenPeerConnection(pc);
                console.log('‚úÖ Screen peer connection initialized');
                
                // Make accessible globally for debugging
                window.peerConnections = window.peerConnections || {};
                window.peerConnections.screen = pc;
            }
            
            return pc;
        };
        
        // Helper function for localStorage ICE candidate exchange (local testing)
        const sendIceCandidateViaLocalStorage = (candidate) => {
            try {
                const iceCandidates = JSON.parse(localStorage.getItem('ice-candidates-' + roomId) || '[]');
                iceCandidates.push({ candidate, from: myId, timestamp: Date.now() });
                localStorage.setItem('ice-candidates-' + roomId, JSON.stringify(iceCandidates));
            } catch (e) {
                console.error('Error storing ICE candidate locally:', e);
            };
        };
        
        // WebRTC Diagnostic Test Function
        const runWebRTCDiagnostic = async () => {
            console.log('üîç Running WebRTC diagnostic test...');
            
            const results = {
                webrtc: false,
                getUserMedia: false,
                getDisplayMedia: false,
                stunConnectivity: false,
                microphone: false,
                screenShare: false
            };
            
            // Test WebRTC support
            if (window.RTCPeerConnection) {
                results.webrtc = true;
                console.log('‚úÖ WebRTC is supported');
            } else {
                console.log('‚ùå WebRTC is not supported');
            }
            
            // Test getUserMedia support
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                results.getUserMedia = true;
                console.log('‚úÖ getUserMedia is supported');
                
                // Test microphone access
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    results.microphone = true;
                    console.log('‚úÖ Microphone access granted');
                    stream.getTracks().forEach(track => track.stop());
                } catch (e) {
                    console.log('‚ùå Microphone access denied:', e.message);
                }
            } else {
                console.log('‚ùå getUserMedia is not supported');
            }
            
            // Test getDisplayMedia support
            if (navigator.mediaDevices && navigator.mediaDevices.getDisplayMedia) {
                results.getDisplayMedia = true;
                console.log('‚úÖ getDisplayMedia is supported');
            } else {
                console.log('‚ùå getDisplayMedia is not supported');
            }
            
            // Test STUN server connectivity
            if (results.webrtc) {
                try {
                    const pc = new RTCPeerConnection({
                        iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
                    });
                    
                    let candidateReceived = false;
                    pc.onicecandidate = (event) => {
                        if (event.candidate && event.candidate.type === 'srflx') {
                            candidateReceived = true;
                            results.stunConnectivity = true;
                            console.log('‚úÖ STUN server connectivity verified');
                            pc.close();
                        }
                    };
                    
                    // Create dummy data channel to trigger ICE gathering
                    pc.createDataChannel('test');
                    const offer = await pc.createOffer();
                    await pc.setLocalDescription(offer);
                    
                    // Wait for ICE candidates
                    setTimeout(() => {
                        if (!candidateReceived) {
                            console.log('‚ùå STUN server connectivity test failed');
                            pc.close();
                        }
                    }, 5000);
                    
                } catch (e) {
                    console.log('‚ùå STUN connectivity test error:', e.message);
                }
            }
            
            // Display results
            const summary = `
==== WebRTC Diagnostic Results ====
üåç WebRTC Support: ${results.webrtc ? '‚úÖ YES' : '‚ùå NO'}
üé§ getUserMedia Support: ${results.getUserMedia ? '‚úÖ YES' : '‚ùå NO'}
üñ•Ô∏è getDisplayMedia Support: ${results.getDisplayMedia ? '‚úÖ YES' : '‚ùå NO'}
üåç STUN Connectivity: ${results.stunConnectivity ? '‚úÖ YES' : '‚ùå NO (may take up to 5s to test)'}
üé§ Microphone Access: ${results.microphone ? '‚úÖ YES' : '‚ùå NO'}

${!results.webrtc ? '‚ö†Ô∏è Please use a modern browser that supports WebRTC\n' : ''}
${results.webrtc && !results.microphone ? '‚ö†Ô∏è Please allow microphone permissions for voice chat\n' : ''}
${results.webrtc && !results.getDisplayMedia ? '‚ö†Ô∏è Screen sharing may not be supported in this browser\n' : ''}
===================================`;
            
            console.log(summary);
            alert('WebRTC Diagnostic Complete! Check console for detailed results.');
            
            return results;
        };
        
        const startVoiceChat = async () => {
            try {
                console.log('üé§ Starting voice chat...');
                setIsConnecting(true);
                
                // Check if WebRTC is supported
                if (!window.RTCPeerConnection) {
                    throw new Error('WebRTC is not supported in this browser');
                }
                
                // Check if getUserMedia is supported
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    throw new Error('getUserMedia is not supported in this browser');
                }
                
                console.log('üì± Requesting microphone access...');
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true
                    }
                });
                
                console.log('‚úÖ Microphone access granted, stream:', stream);
                console.log('üîä Audio tracks:', stream.getAudioTracks().length);
                
                setLocalAudioStream(stream);
                
                if (localAudioRef.current) {
                    localAudioRef.current.srcObject = stream;
                    console.log('üìª Local audio stream attached to audio element');
                }
                
                const pc = initializeVoicePeerConnection();
                console.log('üîó Adding audio tracks to voice peer connection...');
                stream.getTracks().forEach(track => {
                    console.log('‚ûï Adding track:', track.kind, track.label);
                    pc.addTrack(track, stream);
                });
                
                setIsVoiceChatEnabled(true);
                console.log('‚úÖ Voice chat enabled!');
                
                // Create offer if creator
                if (isCreator && roomId) {
                    console.log('üëë Creator creating offer...');
                    const offer = await pc.createOffer();
                    await pc.setLocalDescription(offer);
                    console.log('üì§ Local description set, sending offer...');
                    
                    await sendWebRTCOffer(offer);
                } else {
                    console.log('üë• Waiting for offer from creator...');
                }
                
            } catch (error) {
                console.error('‚ùå Error starting voice chat:', error);
                
                let errorMessage = 'Voice chat setup failed. ';
                let detailedInstructions = '';
                
                if (error.name === 'NotAllowedError') {
                    errorMessage += 'Microphone access was denied.';
                    detailedInstructions = `
üì± TO FIX THIS:
1. Look for the microphone icon (üé§) in your browser's address bar
2. Click it and select "Always allow" for this site
3. Refresh the page and try again

üîç OR check browser settings:
‚Ä¢ Chrome: Settings > Privacy and Security > Site Settings > Microphone
‚Ä¢ Firefox: about:preferences#privacy > Permissions > Camera > Settings
‚Ä¢ Safari: Preferences > Websites > Microphone`;
                } else if (error.name === 'NotFoundError') {
                    errorMessage += 'No microphone detected.';
                    detailedInstructions = `
üé§ TO FIX THIS:
1. Connect a microphone or headset
2. Check that your microphone is not muted
3. Test your microphone in system settings
4. Refresh the page and try again`;
                } else if (error.name === 'NotSupportedError') {
                    errorMessage += 'WebRTC is not supported in this browser.';
                    detailedInstructions = `
üåê TO FIX THIS:
1. Use Chrome, Firefox, Safari, or Edge (latest versions)
2. Update your browser to the latest version
3. Voice chat requires a modern browser with WebRTC support`;
                } else {
                    errorMessage += `Technical error: ${error.message}`;
                    detailedInstructions = `
üîß TROUBLESHOOTING:
1. Refresh the page and try again
2. Clear browser cache and cookies
3. Try a different browser
4. Check if you're on a corporate network (may block voice chat)
5. Switch to a personal network or mobile hotspot

üí° For detailed debugging, press F12 to open browser console`;
                }
                
                alert(errorMessage + detailedInstructions);
                console.log('üé§ VOICE CHAT TROUBLESHOOTING GUIDE:');
                console.log('1. Check browser compatibility: Chrome, Firefox, Safari, Edge (latest)');
                console.log('2. Ensure microphone permissions are granted');
                console.log('3. Verify microphone is working in other applications');
                console.log('4. Check network - corporate networks may block WebRTC');
                console.log('5. HTTPS is required (‚úÖ your deployment uses HTTPS)');
                console.log('6. Try clearing browser cache and cookies');
                console.log('Full error object:', error);
                console.error('Full error details:', error);
            } finally {
                setIsConnecting(false);
            }
        };
        
        const stopVoiceChat = () => {
            if (localAudioStream) {
                localAudioStream.getTracks().forEach(track => track.stop());
                setLocalAudioStream(null);
            }
            setIsVoiceChatEnabled(false);
            setIsMuted(false);
        };
        
        const toggleMute = () => {
            if (localAudioStream) {
                const audioTracks = localAudioStream.getAudioTracks();
                audioTracks.forEach(track => {
                    track.enabled = isMuted;
                });
                setIsMuted(!isMuted);
            }
        };
        
        const startCodeSharing = async () => {
            try {
                console.log('üíª Starting code sharing...');
                setIsConnecting(true);
                
                // Enable code sharing
                setIsCodeSharing(true);
                console.log('‚úÖ Code sharing enabled!');
                
                // Send code sharing notification
                if (roomId) {
                    if (db && window.firebase) {
                        await db.collection('battleRooms').doc(roomId).set({
                            codeShare: { 
                                active: true,
                                from: myId,
                                sharedCode: player1Code,
                                language: selectedLanguage,
                                timestamp: firebase.firestore.FieldValue.serverTimestamp()
                            }
                        }, { merge: true });
                        console.log('‚úÖ Code sharing enabled via Firebase');
                    } else {
                        // Fallback to localStorage for local testing
                        const codeData = { 
                            active: true,
                            from: myId, 
                            sharedCode: player1Code,
                            language: selectedLanguage,
                            timestamp: Date.now()
                        };
                        localStorage.setItem('code-share-' + roomId, JSON.stringify(codeData));
                        console.log('‚úÖ Code sharing enabled via localStorage');
                    }
                } else {
                    console.warn('‚ö†Ô∏è No room ID available for code sharing');
                }
                
            } catch (error) {
                console.error('‚ùå Error starting code share:', error);
                alert('Could not start code sharing: ' + error.message);
            } finally {
                setIsConnecting(false);
            }
        };
        
        const stopCodeSharing = () => {
            setIsCodeSharing(false);
            
            // Notify room that code sharing stopped
            if (roomId) {
                if (db && window.firebase) {
                    db.collection('battleRooms').doc(roomId).set({
                        codeShare: { 
                            active: false, 
                            from: myId,
                            timestamp: firebase.firestore.FieldValue.serverTimestamp()
                        }
                    }, { merge: true });
                    console.log('‚úÖ Code sharing stopped via Firebase');
                } else {
                    // Clear localStorage for local testing
                    localStorage.removeItem('code-share-' + roomId);
                    console.log('‚úÖ Code sharing stopped via localStorage');
                }
            }
            
            console.log('‚úÖ Code sharing disabled');
        };
        
        // Enhanced WebRTC Signal Handlers with separate peer connections
        const handleWebRTCOffer = async (offer, type = 'voice') => {
            try {
                console.log(`üì¨ Processing received ${type} WebRTC offer...`);
                const pc = type === 'voice' ? initializeVoicePeerConnection() : initializeScreenPeerConnection();
                
                // Add local media streams based on type
                if (type === 'voice' && localAudioStream) {
                    localAudioStream.getTracks().forEach(track => {
                        if (!pc.getSenders().find(sender => sender.track === track)) {
                            pc.addTrack(track, localAudioStream);
                            console.log('‚ûï Added local audio track to voice connection');
                        }
                    });
                } else if (type === 'screen' && localScreenStream) {
                    localScreenStream.getTracks().forEach(track => {
                        if (!pc.getSenders().find(sender => sender.track === track)) {
                            pc.addTrack(track, localScreenStream);
                            console.log('‚ûï Added local screen track to screen connection');
                        }
                    });
                }
                
                await pc.setRemoteDescription(new RTCSessionDescription(offer));
                
                const answer = await pc.createAnswer();
                await pc.setLocalDescription(answer);
                
                // Send answer via Firebase or localStorage based on type
                if (db && window.firebase) {
                    if (type === 'voice') {
                        await db.collection('battleRooms').doc(roomId).set({
                            webrtc: { 
                                answer: { sdp: answer.sdp, type: answer.type }, 
                                from: myId,
                                timestamp: firebase.firestore.FieldValue.serverTimestamp()
                            }
                        }, { merge: true });
                        console.log('‚úÖ Voice answer sent via Firebase');
                    } else {
                        await db.collection('battleRooms').doc(roomId).set({
                            screenShare: { 
                                answer: { sdp: answer.sdp, type: answer.type }, 
                                from: myId,
                                timestamp: firebase.firestore.FieldValue.serverTimestamp()
                            }
                        }, { merge: true });
                        console.log('‚úÖ Screen share answer sent via Firebase');
                    }
                } else {
                    // Use localStorage fallback  
                    const signals = { answer: { sdp: answer.sdp, type: answer.type }, from: myId };
                    const storageKey = type === 'voice' ? 'webrtc-voice-signals-' : 'screen-share-signals-';
                    localStorage.setItem(storageKey + roomId, JSON.stringify(signals));
                    console.log(`‚úÖ ${type} answer sent via localStorage`);
                }
            } catch (error) {
                console.error('‚ùå Error handling WebRTC offer:', error);
                throw error;
            }
        };
        
        const handleWebRTCAnswer = async (answer, type = 'voice') => {
            try {
                console.log(`üì¨ Processing received ${type} WebRTC answer...`);
                const pc = type === 'voice' ? voicePeerConnectionRef.current : screenPeerConnectionRef.current;
                
                if (!pc) {
                    console.warn(`‚ö†Ô∏è No ${type} peer connection found for answer`);
                    return;
                }
                
                if (pc.signalingState !== 'stable') {
                    await pc.setRemoteDescription(new RTCSessionDescription(answer));
                    console.log(`‚úÖ ${type} WebRTC answer processed successfully`);
                } else {
                    console.warn(`‚ö†Ô∏è Ignoring ${type} WebRTC answer - peer connection already stable`);
                }
            } catch (error) {
                console.error(`‚ùå Error handling ${type} WebRTC answer:`, error);
                throw error;
            }
        };
        
        const sendWebRTCOffer = async (offer) => {
            try {
                console.log('üì§ Sending WebRTC offer...');
                if (db && window.firebase) {
                    await db.collection('battleRooms').doc(roomId).set({
                        webrtc: { 
                            offer: { sdp: offer.sdp, type: offer.type }, 
                            from: myId,
                            timestamp: firebase.firestore.FieldValue.serverTimestamp()
                        }
                    }, { merge: true });
                    console.log('‚úÖ WebRTC offer sent via Firebase');
                } else {
                    // Use localStorage fallback
                    const signals = { offer: { sdp: offer.sdp, type: offer.type }, from: myId };
                    localStorage.setItem('webrtc-voice-signals-' + roomId, JSON.stringify(signals));
                    console.log('‚úÖ WebRTC voice offer sent via localStorage');
                }
            } catch (error) {
                console.error('‚ùå Error sending WebRTC offer:', error);
                throw error;
            }
        };

        return (
            <div className="min-h-screen bg-gray-900 text-gray-100 font-inter p-4 flex flex-col items-center">
                 {/* Header */}
                 <nav className="fixed top-0 left-0 w-full bg-gray-800 text-gray-100 shadow-lg z-50">
                    {/* Main header bar */}
                    <div className="flex justify-between items-center p-4 min-h-[64px]">
                        <div className="flex items-center">
                            <h1 className="text-xl font-bold ml-4 text-indigo-400">Codera Battle Room</h1>
                        </div>
                        
                        {/* Timer - Always visible */}
                        <div className="text-lg sm:text-xl font-medium text-orange-400 mx-4">
                            Time Left: <span className="font-bold">{formatTime(timer)}</span>
                        </div>
                        
                        {/* Control buttons - Responsive layout */}
                        <div className="flex items-center space-x-2 overflow-x-auto">
                            {/* Enhanced Room Sharing */}
                            <div className="flex items-center space-x-2 flex-shrink-0">
                                <button
                                    onClick={() => { 
                                        // Create proper invite URL
                                        const baseUrl = window.location.href.split('?')[0].split('#')[0];
                                        const inviteUrl = baseUrl + '#/battle/room?id=' + roomId;
                                        
                                        navigator.clipboard.writeText(inviteUrl).then(() => {
                                            // Show success message
                                            const btn = document.querySelector('[data-copy-btn]');
                                            const originalText = btn.textContent;
                                            btn.textContent = '‚úÖ Copied!';
                                            btn.classList.remove('bg-blue-600');
                                            btn.classList.add('bg-green-600');
                                            setTimeout(() => {
                                                btn.textContent = originalText;
                                                btn.classList.remove('bg-green-600');
                                                btn.classList.add('bg-blue-600');
                                            }, 2000);
                                            
                                            console.log('üîó Invite URL copied to clipboard:', inviteUrl);
                                        }).catch(() => {
                                            // Fallback: show prompt with URL
                                            prompt('Copy this URL to share the battle room:', inviteUrl);
                                            console.log('üîó Share this URL:', inviteUrl);
                                        });
                                    }}
                                    className="px-3 py-2 bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium rounded-md shadow-md transition duration-200 flex items-center whitespace-nowrap"
                                    data-copy-btn
                                    title="Copy room URL to share with friends"
                                >
                                    <svg className="w-4 h-4 mr-1 sm:mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.367 2.684 3 3 0 00-5.367-2.684z" />
                                    </svg>
                                    <span className="hidden sm:inline">Share Room</span>
                                    <span className="sm:hidden">Share</span>
                                </button>
                                
                                {/* Room ID Display */}
                                <div className="text-xs sm:text-sm text-gray-300 bg-gray-700 px-2 sm:px-3 py-1 rounded border border-gray-600 max-w-[120px] sm:max-w-none">
                                    <span className="font-mono text-yellow-400 select-all truncate" title="Room ID - click to select">{roomId || 'Creating...'}</span>
                                </div>
                            </div>
                            
                            {/* Voice Chat Controls */}
                            <div className="flex items-center space-x-1 flex-shrink-0">
                                {!isVoiceChatEnabled ? (
                                    <button 
                                        onClick={startVoiceChat} 
                                        disabled={isConnecting}
                                        className="p-2 rounded-md bg-green-600 hover:bg-green-700 disabled:bg-gray-600 transition duration-200" 
                                        aria-label="Start voice chat"
                                        title="Start Voice Chat"
                                    >
                                        {isConnecting ? (
                                            <svg className="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                                <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                                                <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                            </svg>
                                        ) : (
                                            <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
                                            </svg>
                                        )}
                                    </button>
                                ) : (
                                    <>
                                        {/* Mute/Unmute Button */}
                                        <button 
                                            onClick={toggleMute} 
                                            className={`p-2 rounded-md transition duration-200 ${
                                                isMuted ? 'bg-red-600 hover:bg-red-700' : 'bg-green-600 hover:bg-green-700'
                                            }`}
                                            aria-label={isMuted ? 'Unmute microphone' : 'Mute microphone'}
                                            title={isMuted ? 'Unmute' : 'Mute'}
                                        >
                                            {isMuted ? (
                                                <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" clipRule="evenodd" />
                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2" />
                                                </svg>
                                            ) : (
                                                <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
                                                </svg>
                                            )}
                                        </button>
                                        
                                        {/* Stop Voice Chat Button */}
                                        <button 
                                            onClick={stopVoiceChat} 
                                            className="p-2 rounded-md bg-red-600 hover:bg-red-700 transition duration-200" 
                                            aria-label="Stop voice chat"
                                            title="End Voice Chat"
                                        >
                                            <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M16 8l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2M3 3l18 18" />
                                            </svg>
                                        </button>
                                    </>
                                )}
                            </div>
                            
                            {/* Code Share Controls */}
                            <div className="flex items-center flex-shrink-0">
                                {!isCodeSharing ? (
                                    <button 
                                        onClick={startCodeSharing} 
                                        disabled={isConnecting}
                                        className="p-2 rounded-md bg-purple-600 hover:bg-purple-700 disabled:bg-gray-600 transition duration-200" 
                                        aria-label="Start code sharing"
                                        title="Share Your Code"
                                    >
                                        {isConnecting ? (
                                            <svg className="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                                <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                                                <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 714 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                            </svg>
                                        ) : (
                                            <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4" />
                                            </svg>
                                        )}
                                    </button>
                                ) : (
                                    <button
                                        onClick={stopCodeSharing} 
                                        className="p-2 rounded-md bg-red-600 hover:bg-red-700 transition duration-200" 
                                        aria-label="Stop code sharing"
                                        title="Stop Code Share"
                                    >
                                        <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728L5.636 5.636m12.728 12.728L18.364 5.636 5.636 18.364" />
                                        </svg>
                                    </button>
                                )}
                            </div>
                            
                            {/* Diagnostic and Exit Controls */}
                            <div className="flex items-center space-x-1 flex-shrink-0">
                                {/* WebRTC Diagnostic Button */}
                                <button
                                    onClick={runWebRTCDiagnostic}
                                    className="p-2 rounded-md bg-yellow-600 hover:bg-yellow-700 transition duration-200" 
                                    aria-label="Run WebRTC diagnostic"
                                    title="Test WebRTC Support & Connectivity"
                                >
                                    <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                    </svg>
                                </button>
                                
                                <button 
                                    onClick={() => navigateTo('/battle')} 
                                    className="px-3 py-2 bg-red-600 hover:bg-red-700 text-white text-xs sm:text-sm rounded-md shadow-md transition duration-200 whitespace-nowrap"
                                >
                                    <span className="hidden sm:inline">Exit Battle</span>
                                    <span className="sm:hidden">Exit</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </nav>

                {/* Main Battle Area */}
                <main className="w-full max-w-7xl grid grid-cols-1 lg:grid-cols-3 gap-4 pt-20">
                    {/* Left Panel: Tabs (Description, Players, Leaderboard) */}
                    <section className="lg:col-span-1 bg-gray-800 p-6 rounded-lg shadow-lg overflow-y-auto max-h-[80vh] flex flex-col">
                        <div className="flex border-b border-gray-600 mb-4">
                            {['Description', 'Players', 'Leaderboard'].map(tab => (
                                <button
                                    key={tab}
                                    onClick={() => setActiveBattleTab(tab)}
                                    className={`px-4 py-2 -mb-px border-b-2 ${activeBattleTab === tab ? 'border-indigo-500 text-indigo-400' : 'border-transparent text-gray-400 hover:text-white'} transition duration-200`}
                                >
                                    {tab}
                                </button>
                            ))}
                        </div>

                        {activeBattleTab === 'Description' && (
                            <>
                                <h2 className="text-2xl font-semibold text-white mb-4 pb-2">{problem.title} <span className={`ml-2 px-3 py-1 text-sm font-medium rounded-full ${problem.difficulty === 'Easy' ? 'bg-green-600 text-green-100' : problem.difficulty === 'Medium' ? 'bg-yellow-600 text-yellow-100' : 'bg-red-600 text-red-100'}`}>{problem.difficulty}</span></h2>
                                <p className="text-gray-300 mb-4">{problem.description}</p>
                                <div className="mt-4">
                                    <h3 className="text-lg font-medium text-white mb-2">Examples:</h3>
                                    {problem.examples.map((example, index) => (
                                        <pre key={index} className="bg-gray-700 p-3 rounded-md text-gray-200 text-sm mb-2 overflow-x-auto">
                                            <code>{example}</code>
                                        </pre>
                                    ))}
                                </div>
                            </>
                        )}
                        {activeBattleTab === 'Players' && (
                            <div className="space-y-4">
                                <div className="bg-gray-700 p-4 rounded-md">
                                    <h3 className="text-lg font-semibold text-white mb-2">You ({myId}) {winner === 'player1' && <span className="text-yellow-400 ml-2">üëë</span>}</h3>
                                    <div className="w-full bg-gray-600 rounded-full h-2.5 mb-2">
                                        <div className="bg-blue-500 h-2.5 rounded-full" style={{ width: `${player1Progress}%` }}></div>
                                    </div>
                                    <p className="text-gray-300 text-sm">{player1Progress === 100 ? 'Completed!' : 'Coding...'}</p>
                                </div>
                                <div className="bg-gray-700 p-4 rounded-md">
                                    <h3 className="text-lg font-semibold text-white mb-2">Opponent ({Object.keys(participants).find(id => id !== myId) || 'Waiting...'}) {winner === 'player2' && <span className="text-yellow-400 ml-2">üëë</span>}</h3>
                                    <div className="w-full bg-gray-600 rounded-full h-2.5 mb-2">
                                        <div className="bg-purple-500 h-2.5 rounded-full" style={{ width: `${player2Progress}%` }}></div>
                                    </div>
                                    <p className="text-gray-300 text-sm">{player2Progress === 100 ? 'Completed!' : 'Coding...'}</p>
                                </div>
                            </div>
                        )}
                        {activeBattleTab === 'Leaderboard' && (
                            <div className="bg-gray-700 p-4 rounded-md flex-grow">
                                <h3 className="text-lg font-semibold text-white mb-2">Battle Leaderboard</h3>
                                <ul className="space-y-2">
                                    <li className="flex justify-between items-center text-gray-200">
                                        <span>You ({myId})</span>
                                        <span>{player1Progress === 100 ? 'Completed' : 'In Progress'}</span>
                                    </li>
                                    <li className="flex justify-between items-center text-gray-200">
                                        <span>Opponent ({Object.keys(participants).find(id => id !== myId) || 'Waiting...'})</span>
                                        <span>{player2Progress === 100 ? 'Completed' : 'In Progress'}</span>
                                    </li>
                                </ul>
                                {battleStatus === 'Ended' && (
                                    <p className="mt-4 text-center text-lg font-bold text-yellow-400">Winner: {winner === 'player1' ? 'You!' : winner === 'player2' ? 'Opponent!' : 'Draw!'}</p>
                                )}
                            </div>
                        )}

                         {isHost && battleStatus === 'Ended' && (
                            <div className="mt-auto pt-4 border-t border-gray-600 flex justify-center">
                                 <button
                                    onClick={() => console.log("Host clicked Next Question")}
                                    className="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-md shadow-md transition duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                >
                                    Next Question (Host Only)
                                </button>
                            </div>
                        )}
                    </section>

                    {/* Code Editor & Output */}
                    <section className="lg:col-span-2 grid grid-cols-1 gap-4">
                        {/* Player Editor */}
                        <div className="bg-gray-800 p-4 rounded-lg shadow-lg flex flex-col">
                            <div className="flex items-center justify-between mb-3 border-b border-gray-600 pb-2">
                                <h2 className="text-xl font-semibold text-white">Your Code</h2>
                                {/* Language Selector */}
                                <select
                                    value={selectedLanguage}
                                    onChange={(e) => setSelectedLanguage(e.target.value)}
                                    className="bg-gray-700 text-gray-100 p-2 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 border border-gray-600"
                                    disabled={battleStatus === "Ended"}
                                >
                                    <option value="javascript">JavaScript</option>
                                    <option value="python">Python</option>
                                    <option value="java">Java</option>
                                    <option value="cpp">C++</option>
                                </select>
                            </div>
                            
                            {/* CodeMirror Editor Container */}
                            <div className="relative mb-3">
                                <div 
                                    id="battle-editor" 
                                    className="flex-grow border border-gray-600 rounded-md overflow-hidden"
                                    style={{ minHeight: '350px' }}
                                ></div>
                                {hasSelection && (
                                    <button
                                        onClick={handleSaveSelectionToNotes}
                                        className="absolute top-2 right-2 px-3 py-1 text-xs bg-yellow-600 hover:bg-yellow-700 text-white rounded shadow"
                                        title="Save selected code to Notes"
                                    >
                                        Save selection
                                    </button>
                                )}
                            </div>
                            
                            <div className="flex flex-wrap justify-end gap-2 mb-3">
                                <button
                                    onClick={() => handleRunCode(1)}
                                    className="px-5 py-2 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-md shadow-md transition duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    disabled={battleStatus === "Ended" || loading}
                                >
                                    {loading ? 'Running...' : 'Run Code'}
                                </button>
                                <button
                                    onClick={() => handleSubmitCode(1)}
                                    className="px-5 py-2 bg-green-600 hover:bg-green-700 text-white font-medium rounded-md shadow-md transition duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-green-500"
                                    disabled={battleStatus === "Ended" || loading}
                                >
                                    Submit
                                </button>
                                <button onClick={handleSaveSelectionToNotes} className="px-5 py-2 bg-yellow-600 hover:bg-yellow-700 text-white font-medium rounded-md shadow-md">Save selection to Notes</button>
                                <button onClick={() => setShowNotes(s => !s)} className="px-5 py-2 bg-indigo-600 hover:bg-indigo-700 text-white font-medium rounded-md shadow-md">{showNotes ? 'Hide Notes' : 'Show Notes'}</button>
                            </div>
                            <div className="bg-gray-700 p-3 rounded-md text-gray-200 text-sm min-h-[80px] overflow-auto">
                                <h3 className="font-medium text-white mb-1">Output:</h3>
                                <pre className="whitespace-pre-wrap">{player1Output}</pre>
                            </div>

                            {showNotes && (
                                <div className="mt-4 bg-gray-700 p-4 rounded-md text-gray-100">
                                    <div className="flex items-center justify-between mb-2">
                                        <h3 className="text-lg font-semibold">Notes for this battle</h3>
                                        <span className="text-xs text-gray-300">{battleNotes.length} saved</span>
                                    </div>
                                    {battleNotes.length === 0 ? (
                                        <p className="text-gray-300 text-sm">No notes yet. Select code in the editor and click "Save selection to Notes".</p>
                                    ) : (
                                        <ul className="space-y-2">
                                            {battleNotes.map(note => (
                                                <li key={note.id} className="bg-gray-800 border border-gray-600 rounded-md p-3">
                                                    <div className="flex items-center justify-between">
                                                        <div>
                                                            <div className="text-sm font-medium text-white">{note.title || 'Snippet'}</div>
                                                            <div className="text-xs text-gray-400">{new Date(note.createdAt).toLocaleString()} ‚Ä¢ {note.language}</div>
                                                        </div>
                                                        <div className="flex gap-2">
                                                            <button onClick={() => handleInsertNoteAtCursor(note)} className="px-3 py-1 text-xs bg-blue-600 hover:bg-blue-700 rounded">Insert</button>
                                                            <button onClick={() => handleCopyNote(note)} className="px-3 py-1 text-xs bg-teal-600 hover:bg-teal-700 rounded">Copy</button>
                                                            <button onClick={() => handleDeleteNote(note.id)} className="px-3 py-1 text-xs bg-red-600 hover:bg-red-700 rounded">Delete</button>
                                                        </div>
                                                    </div>
                                                    <pre className="mt-2 text-sm whitespace-pre-wrap text-gray-200 overflow-auto max-h-40">{note.snippet}</pre>
                                                </li>
                                            ))}
                                        </ul>
                                    )}
                                </div>
                            )}
                        </div>
                        
                        {/* Friend's Code Viewer - Only show when friend is sharing code */}
                        {isViewingFriendCode && friendCode && (
                            <div className="bg-gray-800 p-4 rounded-lg shadow-lg flex flex-col border-2 border-purple-500">
                                <div className="flex items-center justify-between mb-3 border-b border-gray-600 pb-2">
                                    <h2 className="text-xl font-semibold text-purple-400 flex items-center">
                                        <svg className="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                            <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clipRule="evenodd" />
                                        </svg>
                                        Friend's Code (Live)
                                    </h2>
                                    <div className="flex items-center space-x-2">
                                        <span className="px-2 py-1 bg-purple-600 text-white text-xs rounded-full animate-pulse">
                                            Live
                                        </span>
                                        <span className="text-xs text-gray-400">
                                            Auto-synced
                                        </span>
                                    </div>
                                </div>
                                
                                {/* Friend's Code Display */}
                                <div className="flex-grow bg-gray-900 p-3 rounded-md text-gray-200 text-sm font-mono overflow-auto max-h-[400px] border border-purple-500">
                                    <pre className="whitespace-pre-wrap">{friendCode || '// Waiting for friend to share code...'}</pre>
                                </div>
                                
                                {/* Code info */}
                                <div className="mt-2 text-xs text-gray-400 flex items-center justify-between">
                                    <span>Read-only view ‚Ä¢ Updates in real-time</span>
                                    <span>Lines: {friendCode.split('\n').length || 0}</span>
                                </div>
                            </div>
                        )}
                    </section>
                </main>

                {/* Chat and Voice Chat */}
                <section className="w-full max-w-7xl bg-gray-800 p-4 rounded-lg shadow-lg mt-4 flex flex-col md:flex-row gap-4">
                    {/* Chat Window */}
                    <div className="flex-1 flex flex-col min-h-[200px] max-h-[300px] md:max-h-[250px]">
                        <h2 className="text-xl font-semibold text-white mb-2 border-b border-gray-600 pb-2">Chat</h2>
                        <div className="flex-grow bg-gray-700 p-3 rounded-md mb-3 overflow-y-auto custom-scrollbar">
                            {chatMessages.length === 0 ? (
                                <p className="text-gray-400">No messages yet. Say hello!</p>
                            ) : (
                                chatMessages.map((msg, index) => (
                                    <div key={index} className="mb-1">
                                        <span className="font-bold text-blue-400">{msg.sender}:</span>{' '}
                                        <span className="text-gray-200">{msg.text}</span>
                                        <span className="text-xs text-gray-500 ml-2">{msg.timestamp.toLocaleTimeString()}</span>
                                    </div>
                                ))
                            )}
                            <div ref={chatEndRef} />
                        </div>
                        <div className="flex">
                            <input
                                type="text"
                                value={newChatMessage}
                                onChange={(e) => setNewChatMessage(e.target.value)}
                                onKeyDown={handleChatKeyPress}
                                className="flex-grow bg-gray-700 text-gray-200 p-2 rounded-l-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                placeholder="Type your message..."
                                aria-label="Chat input field"
                            />
                            <button
                                onClick={handleSendChatMessage}
                                className="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-r-md transition duration-200"
                                aria-label="Send chat message"
                            >
                                Send
                            </button>
                        </div>
                    </div>

                    {/* Voice Chat & Screen Sharing Status */}
                    <div className="flex-1 flex flex-col bg-gray-700 p-4 rounded-lg shadow-inner">
                        <h2 className="text-xl font-semibold text-white mb-2 border-b border-gray-600 pb-2">Communication Status</h2>
                        <div className="flex-grow text-gray-300 space-y-3">
                            <div className="flex items-center justify-between">
                                <span className="font-bold text-indigo-400">Battle Status:</span>
                                <span className={`px-2 py-1 rounded text-sm ${battleStatus === 'In Progress' ? 'bg-green-600' : battleStatus === 'Ended' ? 'bg-red-600' : 'bg-yellow-600'}`}>
                                    {battleStatus}
                                </span>
                            </div>
                            
                            <div className="flex items-center justify-between">
                                <span className="font-bold text-purple-400">Voice Chat:</span>
                                <span className={`px-2 py-1 rounded text-sm ${isVoiceChatEnabled ? 'bg-green-600' : 'bg-gray-600'}`}>
                                    {isVoiceChatEnabled ? (isMuted ? 'Muted' : 'Active') : 'Disabled'}
                                </span>
                            </div>
                            
                            <div className="flex items-center justify-between">
                                <span className="font-bold text-purple-400">Code Share:</span>
                                <span className={`px-2 py-1 rounded text-sm ${isCodeSharing ? 'bg-green-600' : 'bg-gray-600'}`}>
                                    {isCodeSharing ? 'Sharing' : 'Not Sharing'}
                                </span>
                            </div>
                            
                            <div className="flex items-center justify-between">
                                <span className="font-bold text-blue-400">Viewing Friend's Code:</span>
                                <span className={`px-2 py-1 rounded text-sm ${isViewingFriendCode ? 'bg-green-600' : 'bg-gray-600'}`}>
                                    {isViewingFriendCode ? 'Active' : 'Not Available'}
                                </span>
                            </div>
                            
                            {/* Connection Status */}
                            <div className="space-y-2">
                                <div className="flex items-center justify-between">
                                    <span className="font-bold text-yellow-400">Voice Connection:</span>
                                    <span className={`px-2 py-1 rounded text-sm ${voicePeerConnection && voicePeerConnection.connectionState === 'connected' ? 'bg-green-600' : 'bg-red-600'}`}>
                                        {voicePeerConnection ? voicePeerConnection.connectionState || 'Connecting...' : 'Not Connected'}
                                    </span>
                                </div>
                            </div>
                            
                            {/* Friend's Code Status */}
                            {isViewingFriendCode && (
                                <div className="mt-4 p-3 bg-gray-800 rounded border border-purple-500">
                                    <h3 className="text-sm font-semibold text-white mb-2 flex items-center">
                                        <svg className="w-4 h-4 mr-2 text-purple-400" fill="currentColor" viewBox="0 0 20 20">
                                            <path fillRule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zm0 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V8zm0 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1v-2z" clipRule="evenodd" />
                                        </svg>
                                        Friend's Code:
                                        <span className="ml-2 px-2 py-1 text-xs rounded bg-green-600 text-white animate-pulse">
                                            Live
                                        </span>
                                    </h3>
                                    <div className="text-xs text-gray-400 space-y-1">
                                        <div>Status: Receiving real-time updates</div>
                                        <div>Lines: {friendCode.split('\n').length || 0}</div>
                                        <div>Characters: {friendCode.length || 0}</div>
                                    </div>
                                </div>
                            )}
                            
                            {/* Participants Count */}
                            <div className="mt-2 text-sm text-gray-400">
                                Connected: {Object.keys(participants).length} / 2 players
                            </div>
                        </div>
                    </div>
                </section>
                {battleStatus === "Ended" && (
                     <div className="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4">
                        <div className="bg-gray-800 p-8 rounded-lg shadow-2xl text-center border border-indigo-500 max-w-md w-full animate-fade-in-up">
                            <h2 className="text-3xl font-bold text-indigo-400 mb-4">Battle Ended!</h2>
                            <p className="text-gray-200 text-lg mb-6">
                                {winner === 'player1' ? 'You Won! üéâ' : winner === 'player2' ? 'ProCoder77 Won! üèÖ' : 'It\'s a Draw!'}
                            </p>
                            <button
                                onClick={() => navigateTo('/battle')}
                                className="px-8 py-3 bg-green-600 hover:bg-green-700 text-white font-bold rounded-full shadow-lg transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-green-500"
                            >
                                Back to Battle
                            </button>
                        </div>
                    </div>
                )}
                
                {/* Audio Elements for WebRTC - Keep visible for debugging */}
                <div className="fixed bottom-4 left-4 bg-gray-800 p-2 rounded border border-gray-600" style={{display: isVoiceChatEnabled ? 'block' : 'none'}}>
                    <div className="text-xs text-gray-300 mb-1">Audio Debug:</div>
                    <div className="space-y-1">
                        <div className="flex items-center space-x-2">
                            <span className="text-xs text-gray-400">Local:</span>
                            <audio ref={localAudioRef} muted={true} controls className="w-24 h-6" />
                        </div>
                        <div className="flex items-center space-x-2">
                            <span className="text-xs text-gray-400">Remote:</span>
                            <audio ref={remoteAudioRef} autoPlay={true} controls className="w-24 h-6" />
                        </div>
                    </div>
                </div>
                
            </div>
        );
    };

    // Leaderboard Page (Minimal for routing demo)
    const LeaderboardPage = ({ navigateTo }) => {
        const [timeFilter, setTimeFilter] = useState('all-time');
        const [activeTab, setActiveTab] = useState('Practice');

        const leaderboardData = {
            'Practice': {
                'daily': [
                    { id: 1, username: 'ProCoder77', score: 1200, rank: 1 },
                    { id: 2, username: 'AlgoMaster', score: 1150, rank: 2 },
                    { id: 3, username: 'You', score: 1000, rank: 3 },
                ],
                'weekly': [
                    { id: 1, username: 'ProCoder77', score: 5000, rank: 1 },
                    { id: 3, username: 'You', score: 4500, rank: 2 },
                    { id: 2, username: 'AlgoMaster', score: 4200, rank: 3 },
                ],
                'all-time': [
                    { id: 1, username: 'ProCoder77', score: 15000, rank: 1 },
                    { id: 2, username: 'AlgoMaster', score: 13000, rank: 2 },
                    { id: 3, username: 'You', score: 10000, rank: 3 },
                    { id: 4, username: 'DebugDiva', score: 8000, rank: 4 },
                    { id: 5, username: 'CodeNinja', score: 7500, rank: 5 },
                ]
            },
            'Random Battle': {
                'daily': [
                    { id: 1, username: 'ProCoder77', score: 250, rank: 1 },
                    { id: 3, username: 'You', score: 200, rank: 2 },
                ],
                'weekly': [
                    { id: 1, username: 'ProCoder77', score: 1200, rank: 1 },
                    { id: 2, username: 'AlgoMaster', score: 1000, rank: 2 },
                ],
                'all-time': [
                    { id: 1, username: 'ProCoder77', score: 3000, rank: 1 },
                    { id: 3, username: 'You', score: 2800, rank: 2 },
                ]
            },
            'Friend Battles': {
                'daily': [
                    { id: 3, username: 'You', score: 150, rank: 1 },
                    { id: 1, username: 'ProCoder77', score: 100, rank: 2 },
                ],
                'weekly': [
                    { id: 3, username: 'You', score: 700, rank: 1 },
                    { id: 1, username: 'ProCoder77', score: 600, rank: 2 },
                ],
                'all-time': [
                    { id: 3, username: 'You', score: 2000, rank: 1 },
                    { id: 1, username: 'ProCoder77', score: 1800, rank: 2 },
                ]
            }
        };

        const currentData = leaderboardData[activeTab][timeFilter] || [];

        return (
            <div className="p-8 pt-24 pl-28 lg:pl-28 min-h-screen bg-gray-900 text-gray-100 font-inter">
                <h1 className="text-3xl font-bold text-indigo-400 mb-6">Global Leaderboard</h1>

                <div className="flex border-b border-gray-700 mb-4">
                    {['Practice', 'Random Battle', 'Friend Battles'].map(tab => (
                        <button
                            key={tab}
                            onClick={() => setActiveTab(tab)}
                            className={`px-4 py-2 -mb-px border-b-2 ${activeTab === tab ? 'border-indigo-500 text-indigo-400' : 'border-transparent text-gray-400 hover:text-white'} transition duration-200`}
                        >
                            {tab}
                        </button>
                    ))}
                </div>

                <div className="bg-gray-800 p-6 rounded-lg shadow-lg border border-indigo-700 mb-6">
                    <div className="flex justify-between items-center mb-4">
                        <h2 className="text-xl font-semibold text-white">Rankings</h2>
                        <select
                            value={timeFilter}
                            onChange={(e) => setTimeFilter(e.target.value)}
                            className="bg-gray-700 text-gray-100 p-2 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                        >
                            <option value="daily">Daily</option>
                            <option value="weekly">Weekly</option>
                            <option value="all-time">All Time</option>
                        </select>
                    </div>

                    <div className="overflow-x-auto">
                        <table className="min-w-full divide-y divide-gray-700">
                            <thead className="bg-gray-700">
                                <tr>
                                    <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">
                                        Rank
                                    </th>
                                    <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">
                                        Username
                                    </th>
                                    <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">
                                        Score
                                    </th>
                                </tr>
                            </thead>
                            <tbody className="bg-gray-800 divide-y divide-gray-700">
                                {currentData.length === 0 ? (
                                    <tr>
                                        <td colSpan="3" className="px-6 py-4 whitespace-nowrap text-center text-gray-400">
                                            No data available for this filter.
                                        </td>
                                    </tr>
                                ) : (
                                    currentData.map((entry) => (
                                        <tr key={entry.id} className="hover:bg-gray-700 transition duration-150 ease-in-out">
                                            <td className="px-6 py-4 whitespace-nowrap">
                                                <div className="text-sm font-medium text-white">{entry.rank}</div>
                                            </td>
                                            <td className="px-6 py-4 whitespace-nowrap">
                                                <button onClick={() => navigateTo(`/profile/${entry.id}`)} className="text-indigo-400 hover:text-indigo-600">
                                                    {entry.username}
                                                </button>
                                            </td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-300">
                                                {entry.score}
                                            </td>
                                        </tr>
                                    ))
                                )}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        );
    };

    // Friends Page (Minimal for routing demo)
    const FriendsPage = ({ navigateTo }) => {
        const [activeTab, setActiveTab] = useState('My Friends');
        const [myFriends, setMyFriends] = useState([
            { id: 1, name: 'ProCoder77', online: true },
            { id: 2, name: 'AlgoMaster', online: true },
            { id: 3, name: 'DebugDiva', online: false },
        ]);
        const [friendRequests, setFriendRequests] = useState([
            { id: 4, name: 'RequestUser1' },
            { id: 5, name: 'RequestUser2' },
        ]);
        const [discoverUsers, setDiscoverUsers] = useState([
            { id: 6, name: 'NewCoder', isFriend: false },
            { id: 7, name: 'LearnFast', isFriend: false },
            { id: 8, name: 'CodeExplorer', isFriend: false },
        ]);

        // Check for query parameter for friend requests tab
        useEffect(() => {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('tab') === 'requests') {
                setActiveTab('Requests');
            }
        }, []);

        const handleAcceptRequest = (id) => {
            const acceptedFriend = friendRequests.find(req => req.id === id);
            if (acceptedFriend) {
                setMyFriends(prev => [...prev, { ...acceptedFriend, online: true }]);
                setFriendRequests(prev => prev.filter(req => req.id !== id));
                alert('Friend request accepted!');
            }
        };

        const handleDeclineRequest = (id) => {
            setFriendRequests(prev => prev.filter(req => req.id !== id));
            alert('Friend request declined!');
        };

        const handleAddFriend = (id) => {
            const addedUser = discoverUsers.find(user => user.id === id);
            if (addedUser) {
                console.log(`Sending friend request to ${addedUser.name}`);
                setDiscoverUsers(prev => prev.filter(user => user.id !== id));
                alert('Friend request sent!');
            }
        };

        return (
            <div className="p-8 pt-24 pl-28 lg:pl-28 min-h-screen bg-gray-900 text-gray-100 font-inter">
                <h1 className="text-3xl font-bold text-indigo-400 mb-6">Friends & Connections</h1>

                <div className="flex border-b border-gray-700 mb-6">
                    {['My Friends', 'Requests', 'Discover'].map(tab => (
                        <button
                            key={tab}
                            onClick={() => setActiveTab(tab)}
                            className={`px-4 py-2 -mb-px border-b-2 ${activeTab === tab ? 'border-indigo-500 text-indigo-400' : 'border-transparent text-gray-400 hover:text-white'} transition duration-200`}
                        >
                            {tab}
                        </button>
                    ))}
                </div>

                {activeTab === 'My Friends' && (
                    <div className="bg-gray-800 p-6 rounded-lg shadow-lg border border-indigo-700">
                        <h2 className="text-xl font-semibold text-white mb-4">My Friends</h2>
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            {myFriends.length === 0 ? (
                                <p className="text-gray-400 col-span-full">You don't have any friends yet.</p>
                            ) : (
                                myFriends.map(friend => (
                                    <div key={friend.id} className="bg-gray-700 p-4 rounded-md shadow-sm flex flex-col items-center text-center">
                                        <img src={`https://placehold.co/60x60/FF7700/FFFFFF?text=${friend.name.substring(0,2)}`} alt={friend.name} className="w-16 h-16 rounded-full mb-3 border-2 border-indigo-500" />
                                        <h3 className="text-lg font-semibold text-white">{friend.name}</h3>
                                        <p className={`text-sm ${friend.online ? 'text-green-400' : 'text-gray-400'}`}>{friend.online ? 'Online' : 'Offline'}</p>
                                        <div className="flex gap-2 mt-3">
                                            <button onClick={() => navigateTo(`/profile/${friend.id}`)} className="px-3 py-1 bg-blue-600 hover:bg-blue-700 text-white text-sm rounded-md">Profile</button>
                                            <button onClick={() => navigateTo('/battle/friends')} disabled={!friend.online} className={`px-3 py-1 text-sm rounded-md ${friend.online ? 'bg-purple-600 hover:bg-purple-700' : 'bg-gray-500 cursor-not-allowed'} text-white`}>Battle</button>
                                        </div>
                                    </div>
                                ))
                            )}
                        </div>
                    </div>
                )}

                {activeTab === 'Requests' && (
                    <div className="bg-gray-800 p-6 rounded-lg shadow-lg border border-indigo-700">
                        <h2 className="text-xl font-semibold text-white mb-4">Friend Requests</h2>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            {friendRequests.length === 0 ? (
                                <p className="text-gray-400 col-span-full">No pending friend requests.</p>
                            ) : (
                                friendRequests.map(request => (
                                    <div key={request.id} className="flex items-center justify-between p-3 bg-gray-700 rounded-md">
                                        <span className="font-medium text-white">{request.name}</span>
                                        <div className="flex gap-2">
                                            <button onClick={() => handleAcceptRequest(request.id)} className="px-4 py-2 bg-green-600 hover:bg-green-700 text-white text-sm rounded-md">Accept</button>
                                            <button onClick={() => handleDeclineRequest(request.id)} className="px-4 py-2 bg-red-600 hover:bg-red-700 text-white text-sm rounded-md">Decline</button>
                                        </div>
                                    </div>
                                ))
                            )}
                        </div>
                    </div>
                )}

                {activeTab === 'Discover' && (
                    <div className="bg-gray-800 p-6 rounded-lg shadow-lg border border-indigo-700">
                        <h3 className="text-xl font-semibold text-white mb-4">Discover New Coders</h3>
                        <input type="text" placeholder="Search for users..." className="w-full p-2 bg-gray-700 border border-gray-600 rounded-md text-gray-100 mb-4 focus:outline-none focus:ring-2 focus:ring-blue-500" />
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            {discoverUsers.length === 0 ? (
                                <p className="text-gray-400 col-span-full">No new coders to discover.</p>
                            ) : (
                                discoverUsers.map(user => (
                                    <div key={user.id} className="flex items-center justify-between p-3 bg-gray-700 rounded-md">
                                        <span className="font-medium text-white">{user.name}</span>
                                        <button onClick={() => handleAddFriend(user.id)} className="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white text-sm rounded-md">Add Friend</button>
                                        </div>
                                ))
                            )}
                        </div>
                    </div>
                )}
            </div>
        );
    };

    // Profile Page (Minimal for routing demo)
    const ProfilePage = ({ navigateTo, profileId }) => {
        const isMyProfile = !profileId || profileId === '1'; // Assuming '1' is current user's ID
        const userProfile = {
            id: profileId || '1',
            username: isMyProfile ? 'CodeMaster' : 'ProCoder77',
            bio: isMyProfile ? 'Passionate full-stack developer and competitive programmer.' : 'Top-ranked competitive programmer with a love for algorithms.',
            codingLevel: 'Advanced',
            streakCount: 7,
            badges: isMyProfile ? ["First Win", "10-Day Streak", "100 Battles Won"] : ["First Win", "Master Solver"],
            isFriend: profileId === '2' // Simulate ProCoder77 as a friend
        };

        const handleAddFriend = () => {
            console.log(`Adding ${userProfile.username} as friend`);
            // Simulate toast
            alert(`Friend request sent to ${userProfile.username}!`);
            // In a real app, update isFriend state or refetch profile
            userProfile.isFriend = true; // For demo purposes, immediately update state
        };

        return (
            <div className="p-8 pt-24 pl-28 lg:pl-28 min-h-screen bg-gray-900 text-gray-100 font-inter">
                <div className="bg-gray-800 p-8 rounded-lg shadow-lg border border-indigo-700 max-w-4xl mx-auto">
                    <div className="flex items-center space-x-6 mb-8">
                        <img src={`https://placehold.co/120x120/FF7700/FFFFFF?text=${userProfile.username.substring(0,2)}`} alt="Profile Avatar" className="w-32 h-32 rounded-full border-4 border-indigo-500" />
                        <div>
                            <h1 className="text-4xl font-bold text-indigo-400">{userProfile.username}</h1>
                            <p className="text-gray-300 text-lg mt-1">{userProfile.codingLevel}</p>
                            <p className="text-gray-400 mt-2">{userProfile.bio}</p>
                        </div>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                        <div className="bg-gray-700 p-4 rounded-md shadow-inner">
                            <h3 className="text-xl font-semibold text-white mb-2">Stats</h3>
                            <p className="text-gray-300">Current Streak: <span className="font-bold text-orange-400">{userProfile.streakCount} Days</span></p>
                            <p className="text-gray-300">Problems Solved: <span className="font-bold text-green-400">150</span></p>
                            <p className="text-gray-300">Battles Won: <span className="font-bold text-blue-400">75</span></p>
                        </div>
                        <div className="bg-gray-700 p-4 rounded-md shadow-inner">
                            <h3 className="text-xl font-semibold text-white mb-2">Badges</h3>
                            <div className="flex flex-wrap gap-2 mt-2">
                                {userProfile.badges.map((badge, index) => (
                                    <span key={index} className="px-3 py-1 bg-green-600 text-green-100 text-sm font-medium rounded-full">
                                        {badge}
                                    </span>
                                ))}
                            </div>
                        </div>
                    </div>

                    <div className="flex justify-start gap-4">
                        {isMyProfile ? (
                            <>
                                <button onClick={() => console.log("Edit Profile")} className="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-md shadow-md transition duration-200">
                                    Edit Profile
                                </button>
                                <button onClick={() => console.log("Settings")} className="px-6 py-2 bg-gray-600 hover:bg-gray-700 text-white font-medium rounded-md shadow-md transition duration-200">
                                    Settings
                                </button>
                            </>
                        ) : (
                            <>
                                {!userProfile.isFriend ? (
                                    <button onClick={handleAddFriend} className="px-6 py-2 bg-green-600 hover:bg-green-700 text-white font-medium rounded-md shadow-md transition duration-200">
                                        Add Friend
                                    </button>
                                ) : (
                                    <button onClick={() => navigateTo('/battle/friends')} className="px-6 py-2 bg-purple-600 hover:bg-purple-700 text-white font-medium rounded-md shadow-md transition duration-200">
                                        Battle
                                    </button>
                                )}
                                {/* No "Message" button as per requirement for other profiles */}
                            </>
                        )}
                    </div>
                </div>
            </div>
        );
    };


    // Main Application Component
    const App = () => {
        // Firebase State
        const [db, setDb] = useState(null);
        const [auth, setAuth] = useState(null);
        const [userId, setUserId] = useState(null);
        const [isAuthenticated, setIsAuthenticated] = useState(false);
        const [isAuthReady, setIsAuthReady] = useState(false);
        const [firebaseEnabled, setFirebaseEnabled] = useState(true);

        // UI State
        const [currentPage, setCurrentPage] = useState(window.location.pathname);
        const [previousPage, setPreviousPage] = useState('/home'); // Track previous page for profile toggle
        const [isSidebarOpen, setIsSidebarOpen] = useState(window.innerWidth >= 1024); // Open by default on desktop
        // Theme state (active App)
        const [theme, setTheme] = useState(() => {
            try { return localStorage.getItem('theme') || 'dark'; } catch(e) { return 'dark'; }
        });
        useEffect(() => {
            try { localStorage.setItem('theme', theme); } catch(e) {}
            document.body.classList.toggle('light', theme === 'light');
            window.dispatchEvent(new CustomEvent('theme-change', { detail: theme }));
        }, [theme]);
        const toggleTheme = () => setTheme(prev => (prev === 'dark' ? 'light' : 'dark'));

        // --- Firebase Initialization and Authentication ---
        useEffect(() => {
            try {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-codera-app-id';
                const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};

                if (Object.keys(firebaseConfig).length === 0) {
                    console.error("Firebase config is missing or invalid. Please ensure __firebase_config is correctly set.");
                    // Fallback: run the app in demo mode without Firebase
                    setFirebaseEnabled(false);
                    setIsAuthenticated(true);
                    setIsAuthReady(true);
                    return;
                }

                const app = initializeApp(firebaseConfig);
                const firestoreDb = getFirestore(app);
                const firebaseAuth = getAuth(app);

                setDb(firestoreDb);
                setAuth(firebaseAuth);

                const authenticate = async () => {
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(firebaseAuth, __initial_auth_token);
                        } else {
                            // Attempt anonymous sign-in for initial setup or if custom token is absent
                            await signInAnonymously(firebaseAuth);
                        }
                    } catch (error) {
                        console.error("Firebase authentication error:", error);
                    }
                };

                authenticate();

                const unsubscribe = onAuthStateChanged(firebaseAuth, (user) => {
                    if (user) {
                        setUserId(user.uid);
                        setIsAuthenticated(true);
                        console.log("User authenticated:", user.uid);
                        // If on login page and authenticated, redirect to home
                        if (currentPage === '/login' || currentPage === '/') {
                            // Check if current protocol is 'blob:' to avoid pushState errors
                            if (window.location.protocol !== 'blob:') {
                                setCurrentPage('/home');
                                window.history.pushState({}, '', '/home');
                            } else {
                                setCurrentPage('/home');
                            }
                        }
                    } else {
                        setUserId(null);
                        setIsAuthenticated(false);
                        console.log("User signed out or anonymous.");
                        // If not authenticated and not on login page, redirect to login
                        if (currentPage !== '/login') {
                            // Check if current protocol is 'blob:' to avoid pushState errors
                            if (window.location.protocol !== 'blob:') {
                                setCurrentPage('/login');
                                window.history.pushState({}, '', '/login');
                            } else {
                                setCurrentPage('/login');
                            }
                        }
                    }
                    setIsAuthReady(true);
                });

                return () => unsubscribe(); // Cleanup auth listener
            } catch (error) {
                console.error("Error initializing Firebase:", error);
            }
        }, [currentPage]);

        // Handle initial routing based on authentication state
        useEffect(() => {
            if (isAuthReady) {
                if (!isAuthenticated && currentPage !== '/login') {
                    if (window.location.protocol !== 'blob:') {
                        setCurrentPage('/login');
                        window.history.pushState({}, '', '/login');
                    } else {
                        setCurrentPage('/login');
                    }
                } else if (isAuthenticated && (currentPage === '/' || currentPage === '/login')) {
                    if (window.location.protocol !== 'blob:') {
                        setCurrentPage('/home');
                        window.history.pushState({}, '', '/home');
                    } else {
                        setCurrentPage('/home');
                    }
                }
            }
        }, [isAuthReady, isAuthenticated, currentPage]);


        // Handle browser navigation (back/forward)
        useEffect(() => {
            const handlePopState = () => {
                setCurrentPage(window.location.pathname);
            };
            window.addEventListener('popstate', handlePopState);
            return () => window.removeEventListener('popstate', handlePopState);
        }, []);

        // Function to navigate programmatically
        const navigateTo = (path) => {
            // Store previous page before navigating to any new page
            if (currentPage !== path && !currentPage.startsWith('/profile')) {
                // Only update previous page if we're not currently on a profile page
                // This prevents overwriting the original page when navigating between profile pages
                setPreviousPage(currentPage);
            } else if (currentPage !== path && currentPage.startsWith('/profile') && !path.startsWith('/profile')) {
                // If leaving profile to go somewhere else, don't update previous page
                // Keep the original previous page intact
            } else if (currentPage !== path && !currentPage.startsWith('/profile') && path.startsWith('/profile')) {
                // If going to profile from non-profile page, store current as previous
                setPreviousPage(currentPage);
            }
            setCurrentPage(path);
            // Only modify browser history if not running from a blob: URL
            if (window.location.protocol !== 'blob:') {
                window.history.pushState({}, '', path);
            }
        };

        // Special toggle function for profile icon
        const toggleProfile = () => {
            if (currentPage.startsWith('/profile')) {
                // If currently on profile, go back to previous page
                setCurrentPage(previousPage);
                if (window.location.protocol !== 'blob:') {
                    window.history.pushState({}, '', previousPage);
                }
            } else {
                // If not on profile, store current page and go to profile
                setPreviousPage(currentPage);
                setCurrentPage('/profile');
                if (window.location.protocol !== 'blob:') {
                    window.history.pushState({}, '', '/profile');
                }
            }
        };

        const handleLogout = async () => {
            if (auth) {
                try {
                    await signOut(auth);
                    navigateTo('/login'); // Redirect to login after logout
                } catch (error) {
                    console.error("Error logging out:", error);
                }
            }
        };

        // Conditional rendering based on authentication and current page
        if (!isAuthReady) {
            return (
                <div className="min-h-screen flex items-center justify-center bg-gray-900 text-gray-100">
                    <svg className="animate-spin h-10 w-10 text-indigo-400 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                        <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <p>Loading application...</p>
                </div>
            );
        }

        // This conditional redirect is now handled within the useEffect for better lifecycle management
        // and to ensure pushState is not called on blob: URLs
        // if (!isAuthenticated && currentPage !== '/login') {
        //     navigateTo('/login');
        //     return null;
        // }

        const isAuthed = firebaseEnabled ? isAuthenticated : true;

        const renderPage = () => {
            const pathSegments = currentPage.split('/').filter(Boolean); // ['', 'practice', '1'] -> ['practice', '1']
            const baseRoute = `/${pathSegments[0] || ''}`;
            const id = pathSegments[1];
            const subRoute = pathSegments[1]; // for /battle/random or /battle/friends

            switch (baseRoute) {
                case '/login':
                    return isAuthed ? <HomePage username="CodeMaster" navigateTo={navigateTo} /> : <LoginPage onLoginSuccess={() => navigateTo('/home')} navigateTo={navigateTo} />;
                case '/home':
                    return isAuthed ? <HomePage username="CodeMaster" navigateTo={navigateTo} /> : <LoginPage onLoginSuccess={() => navigateTo('/home')} navigateTo={navigateTo} />;
                case '/practice':
                    return isAuthed ? (id ? <PracticeProblemPage problemId={id} /> : <PracticeListPage navigateTo={navigateTo} />) : <LoginPage onLoginSuccess={() => navigateTo('/home')} navigateTo={navigateTo} />;
                case '/battle':
                     if (!isAuthed) return <LoginPage onLoginSuccess={() => navigateTo('/home')} navigateTo={navigateTo} />;
                     if (subRoute === 'random') return <BattleRandomPage navigateTo={navigateTo} />;
                     if (subRoute === 'friends') return <BattleFriendsPage navigateTo={navigateTo} />;
                     if (subRoute === 'room') return <BattleRoomPage navigateTo={navigateTo} userId={userId} db={db} />;
                     return <BattleOverviewPage navigateTo={navigateTo} />;
                case '/leaderboard':
                    return isAuthed ? <LeaderboardPage navigateTo={navigateTo} /> : <LoginPage onLoginSuccess={() => navigateTo('/home')} navigateTo={navigateTo} />;
                case '/friends':
                    return isAuthed ? <FriendsPage navigateTo={navigateTo} /> : <LoginPage onLoginSuccess={() => navigateTo('/home')} navigateTo={navigateTo} />;
                case '/notes':
                    return isAuthed ? <NotesPage navigateTo={navigateTo} /> : <LoginPage onLoginSuccess={() => navigateTo('/home')} navigateTo={navigateTo} />;
                case '/profile':
                    return isAuthed ? <ProfilePage navigateTo={navigateTo} profileId={id} /> : <LoginPage onLoginSuccess={() => navigateTo('/home')} navigateTo={navigateTo} />;
                default:
                    // Default to home if authenticated, else login
                    return isAuthed ? <HomePage username="CodeMaster" navigateTo={navigateTo} /> : <LoginPage onLoginSuccess={() => navigateTo('/home')} navigateTo={navigateTo} />;
            }
        };

        return (
            <div className={`flex min-h-screen ${theme === 'dark' ? 'bg-gray-900' : 'bg-gray-100'}`}>
                {isAuthed && (
                    <>
                        <Navbar toggleSidebar={() => setIsSidebarOpen(!isSidebarOpen)} username="CodeMaster" currentPage={currentPage} userId={userId} onLogout={handleLogout} theme={theme} onToggleTheme={toggleTheme} navigateTo={navigateTo} toggleProfile={toggleProfile} />
                        <Sidebar isSidebarOpen={isSidebarOpen} toggleSidebar={setIsSidebarOpen} navigateTo={navigateTo} currentPage={currentPage} />
                    </>
                )}
                <div className={`flex-grow ${isAuthed ? 'ml-0 lg:ml-20' : ''} transition-all duration-300 ease-in-out`}>
                    {renderPage()}
                </div>
            </div>
        );
    };
    
    // Render the AppEarly component (React 18)
    if (window.ReactDOM && ReactDOM.createRoot) {
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<AppEarly />);
    } else {
        // Fallback for older ReactDOM UMDs
        ReactDOM.render(<AppEarly />, document.getElementById('root'));
    }

    </script>
</body>
</html>
